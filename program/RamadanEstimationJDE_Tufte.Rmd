---
title: "Ramadan estimation"
author: "Seiro Ito"
date: "`r format(Sys.time(), '%Y年%m月%d日 %R')`"
output:
  tufte::tufte_html:
    citation_package: natbib
    tufte_features: ["fonts", "background", "italics"]
    toc: true
    includes:
      in_header: "../program/MathShorthand.html"
####   bookdown::tufte_html2:
####     citation_package: natbib
####     tufte_features: ["fonts", "background", "italics"]
####     toc: true
####     includes:
####       in_header: "../program/MathShorthand.html"
  pdf_document:
    latex_engine: xelatex
    fig_width: 7
    fig_height: 6
    fig_caption: true
    includes:
      in_header: "../program/MathShorthand.html"
urlcolor: blue
linkcolor: red
header-includes:
    - \usepackage{amsmath}
    - \usepackage{amssymb}
    - \usepackage{amsfonts}
    - \usepackage{bookmark} 
    - \usepackage{natbib} 
    - \usepackage{xltxtra} 
    - \usepackage{zxjatype} 
    - \usepackage[ipa]{zxjafont} 
    - \usepackage{marginnote}
bibliography: c:/seiro/settings/Tex/seiro.bib
link-citations: yes
#### c:\seiro\languages\R\R-4.2.1\bin\x64\Rscript.exe -e "path <- 'c:/data/Ramadan/program/'; rmarkdown::render('c:/data/Ramadan/program/RamadanEstimationJDE_Tufte.Rmd')"
# path0 <- "c:/data/Ramadan/"; setwd(path <- paste0(path0, "submit2024/")); pathprogram <- paste0(path, "program/"); rmarkdown::render(paste0(pathprogram, "RamadanEstimationJDE_Tufte.Rmd"))
#### rmarkdown::render(paste0(path, "program/RamadanEstimationJDE_Tufte.Rmd"), output_format = "pdf_document")
#### Below are git bash commands.  ####
#### To publish on github, we are placing html under /root/program/RamadanEstimationJDE_Tufte.html.
#### cd c:/data/Ramadan/submit2024/
#### git init
#### git config --global user.name "SeiroIto"
#### git remote add origin https://github.com/SeiroIto/Ramadan.git  ## specify remote
#### git branch -M main
#### Close git once and start again. 
#### Before running below, create .gitignore and place it in c:/data/Ramadan/submit2024/
#### .gitignore has following lines (=asking git to ignore data files)
####    /save/*.qs
####    /save/*.rds
####    /save/*.prn
####    /save/Feb29/
####    /progran/cache/
#### git add c:/data/Ramadan/submit2024/program c:/data/Ramadan/submit2024/save   ## this adds files to track
#### git add c:/data/Ramadan/submit2024/program   ## for most times, use this 
#### Below may not be necessary if .gitignore works as intended. 
#### Below tells git the files to untrack.
#### git update-index --assume-unchanged c:/data/Ramadan/submit2024/docs/save/*.qs
#### If wanting back to "being tracked":
####   git update-index --no-assume-unchanged filename
####   git rm --cached is “correct” when you want to be the only one who still has the file. 
#### git update-index --assume-unchanged c:/data/Ramadan/submit2024/save/Feb29/
#### git update-index --assume-unchanged c:/data/Ramadan/submit2024/save/*.rds
#### git update-index --assume-unchanged c:/data/Ramadan/submit2024/save/*.prn
#### git ls-tree -r main --name-only ## list all tracked files
#### git commit -am "initial commit"
#### git push -f origin main  ## push files to remote
#### if error with push fatal: the remote end hung up unexpectedly, run below
#### git config http.postBuffer 2000000000
#### git push -f origin main  ## push files to remote
---

```{css, echo=F}
Blue {
  color: dodgerblue;
}
.SeiroBenign {
  background-color: #FFEBCD;
  padding: 0.5em; /*文字まわり（上下左右）の余白*/
  /* border: 1px solid yellow; */
  /* font-weight: bold; */
}
.SeiroLightGreen {
  background-color: #D0F0C0; /* Tea green */
  padding: 0.5em; /*文字まわり（上下左右）の余白*/
  font-family: Noto Sans;
  /* border: 1px solid yellow; */
  /* font-weight: bold; */
}
#### Default height of a block
pre {
  max-height: 700px;
  overflow-y: auto;
}
pre[class] {
  max-height: 950px;
}
.scroll-100 {
  max-height: 100px;
  overflow-y: auto;
  background-color: inherit;
}
```
```{r setup, echo = F, results = "hide"} 
#### include = F <==> echo=F & results = F
#### renv::init()
#### library(renv)
library(knitr)
library(tufte)
#### invalidate cache when the tufte version changes
knitr::opts_chunk$set(
  tidy = FALSE, cache.extra = packageVersion('tufte'), 
  margin_references = TRUE,
  #### remove leading hashes in html output
  comment = "", 
  echo = T, cache = F, 
  class.source = "SeiroBenign", class.output = "SeiroLightGreen"
  )
options(htmltools.dir.version = FALSE, width = 100)
gc()
```

```{r here setup, eval = F, echo = F}
library(here)
library(rprojroot)
#### Need to set project root
setwd("c:/data/Ramadan/")
getwd()
here::i_am("Submit2024/program/RamadanEstimationJDE_Tufte.Rmd")
getwd()
find_root_file("Workshop2024Mar26/code/EstimationCode/R", 
  "data_simulated_20230426.csv", criterion = has_file(".git/index"))
(RootFile <- find_root(has_file(".git/index")))
#### List all files and directories below the root
dir(find_root(has_file(".git/index")))
FPath <- function(SubFolder, FileName) 
  find_root_file(SubFolder, FileName, criterion = has_file(".git/index"))
FPath("docs/Workshop2024Mar26/code/EstimationCode/R", "data_simulatedCD_20230426.csv")
data_sim <- fread(FPath("docs/Workshop2024Mar26/code/EstimationCode/R", 
  "data_simulatedCD_20230426.csv"))

``

<details><summary>Click here to see the code of path and definition settings.</summary>

```{r path and def files, echo = T, eval = T, cache = F, warning = F, results = "hide"}
library(data.table)
library(qs)
pathprogram <- paste0(path, "program/");  
pathprogram0 <- paste0(path0, "program/program/");  
pathsource <- paste0(path0, "source/")
pathsave <- paste0(path, "save/")
pathsaveFeb29 <- paste0(pathsave, "Feb29/")
pathsave0 <- paste0(path0, "DataSubmitted/save/DIDReplication/")
pathsave0 <- paste0(path0, "save/DID_JHR2/")
pathfigure <- pathsavefigure <- paste0(pathprogram, "figure/")
dir.create(pathsave)
dir.create(pathsaveFeb29)
dir.create(pathsavefigure)
file.remove(list.files("program/cache", full.names = T))
#### Uncommenting below deletes all input/output of R from html. Why???
#### render_listings()	####	it changes "<-" to real arrows, etc., prettifying
#### substitution table "sbt"
source(paste0(pathprogram, "SubstitutionTableForHTML.R"))
#### agHH defs, minAge, maxAge
source(paste0(pathprogram, "DefinitionsAndParameters.R")) 
#### Tabulation functions
source(paste0(pathprogram, "tabulate_est.R"))
source(paste0(pathprogram, "EstimatorFunctions.R"))
```
</details>
```{r TableFootnotes, file = "../program/TableFootnotePieces.R", echo = F}
```

# Read and format data

## Define samples


<details><summary>Click here to see the code of reading files.</summary>
```{r read data, results = "hide"}
library(data.table); library(bit64); library(qs)
#### Renamed: DataForJHR => DataRamadan
#### Need "../save/DataRamadan.qs" when I knit from c:/data/Ramadan/submit2024/,
#### but need to use save/DataRamadan.qs when I copy-paste to console.
yzw <- qread("../save/DataRamadan.qs")
colnames(yzw)
setkey(yzw, uniquid, survey)
zF <- yzw
```
</details>
<details><summary>Click here to see the code of selecting sample.</summary>
```{r Selecting samples}
####zF[, (grepout("yr\\d", colnames(zF))) := NULL]
zF[, Dummy1999 := as.numeric(survey==1999)]
zF[, Dummy2002 := as.numeric(survey==2002)]
zF[, Dummy2006 := as.numeric(survey==2006)]
zF[, Dummy1999 := Dummy1999 - mean(Dummy1999)]
zF[, Dummy2002 := Dummy2002 - mean(Dummy2002)]
zF[, Dummy2006 := Dummy2006 - mean(Dummy2006)]
#### zE: Sample of individuals existed in round 1 and 2. 
zE <- zF[grepl("111|110", exist), ]
#### switch HHtype definition between sd and sd2, if Usesd2==T
if (Usesd2) setnames(zE, c("sd", "sd2"), c("sd0", "sd"))
#### zS: Sample with at least some schooling in 3 rounds
zS <- zF[!(grepl("000", spattern)), ]
zE[, exist := droplevels(exist)]
zS[, exist := droplevels(exist)]
#### zY: Sample of young cohorts of 1999
iiid0 <- unique(zF[grepl("^[6-9]$", AgeIn1999), uniquid])
zY <- zF[uniquid %in% iiid0 & survey != 1999, ]
zY[, Age2002 := AgeIn2002]
zY[AgeIn2002 >= 18, Age2002 := "18plus"]
zY[, Age2002 := factor(AgeIn2002)]
table(zY[, .(survey, Age2002)])
table(zY[, .(survey, agHH = agHH0>0)])
```
</details>

In the original sample, `exist`^[Availability of each observations across survey rounds. A value of 110 indicates that this individual is observed in rd 1 and 2 but attrited in 3.] is either 001, 110, 111. We drop the observations of 001 as they do not form a panel. 

## Create demeaned dummies and their interaction terms

We demean the dummy interaction terms. 

<details><summary>Click here to see the code of demeaning dummy variable interactions.</summary>
```{r variables to interact with yrX 2}
thesevar.strings <- "edulevel\\.|^dummy\\d|kut|nwater|flood"
#thesevar.strings <- "^dummy\\d"
thesevar <- gsub("\\_", "\\\\_", grepout(thesevar.strings, colnames(yzw)))
thesevar <- unique(gsub(".yr.", "", thesevar))
#### demographic
iidd <- grepout("^D.*Age[gG]|Sib|pc|D.*Edu|sp.e.*y|hd.e.*y|sex$|nonmusl|flood|kut|nwater", colnames(yzw))
iidd <- iidd[!grepl("^D.*\\.1$", iidd)] # drop possible dummy duplicates
iidist <- grepout("^dummy[A-Z]", colnames(yzw)) # districts
iidy <- grepout("^dummy\\d", colnames(yzw)) # year
iiag <- grepout("agHH", colnames(yzw)) # agHH definitions
#### real valued time varying covariates
rvtv <- c("pcland", "pcnlasset")
#### trend: To control heterogenous trends = X*yrX
iitrend <- unique(c(aghh.defs, iidd, iidist, thesevar))
#### slope: To estimate heterogenous impacts = X*agHH*yrX
iislope <- iidd
#### Note slope variables are a subset of trend variables.
#### rvtv is also interacted with yrX and agHH*yrX but not demeaned, so 
#### I put it in a different group
```
Create age and year dummies and age wise interactions (age*agHH). Demean these interacting dummy variables: 

<p style="font-family: times, serif; font-size:10pt">
`r iitrend[order(iitrend)]` (process not shown). 
</p>

Demeaning needs to be done separately for each sample because means differ between samples. Demeaning level is recommended to be at individual \citep[][Remark 6]{Bent2013} and \citep[][eq. 18]{GiesselmannSchmidt-Catran2022}, and, for FE estimators, further demean the demeaned interaction term as usual to drop individual FEs:
\[
\tilde{x}_{it}\tilde{z}_{it}-\overline{\tilde{x}_{it}\tilde{z}_{it}}
\]
where $\tilde{x}_{it}=x_{it}-\bar{x}_{i}$. 

Alternatively, one can also use FD to drop individual FEs, which is what is done in the below when we choose demeaning level at individuals. 

```{r save zEm.1999 etc and create dummy agHH yrX interactions }
#### This chunk is copied from SampleSelectionDemeaning.rnw
####for (ss in c("E", "S", "Y")) {
for (ss in c("E", "S")) {
  zXobjs <- gsub("X", ss, c("zXp.1999", "zXp.2002", "zXm.1999", "zXm.2002"))
  zX <- get(paste0("z", ss))
  dim(zX)
  if (ss == "Y") {
    zXobjs <- zXobjs[1]
    assign(zXobjs[1], zX)
  } else {
    #### read zE or zS or zY
    #### placebo testing samples: drop 1999 entries while choosing cohorts
    ####   zXp.1999: 2002 effects on AgeInRangeR1 (AgeInRange in 1999) cohorts
    assign(zXobjs[1], 
      zX[uniquid %in% uniquid[AgeInRangeR1 == 1] & survey != 1999, ])
    ####   zXp.2002: 2002 effects on AgeInRangeR2 (AgeInRange in 2002) cohorts
    assign(zXobjs[2], 
      zX[uniquid %in% uniquid[AgeInRangeR2 == 1] & survey != 1999, ])
    #### main esitmation samples: drop 2006 entries while choosing cohorts
    ####   zXm.1999: 1999 effects on AgeInRangeR1 (AgeInRange in 1999) cohorts
    assign(zXobjs[3], 
      zX[uniquid %in% uniquid[AgeInRangeR1 == 1] & survey != 2006, ])
    ####   zXm.2002: 1999 effects on AgeInRangeR2 (AgeInRange in 2002) cohorts
    assign(zXobjs[4], 
      zX[uniquid %in% uniquid[AgeInRangeR2 == 1] & survey != 2006, ])
  }
  for (k in 1:length(zXobjs)) {
    zXobj <- get(zXobjs[k])
    #### keep original (undemeaned) level of x as UDx
    ######## Note: Using (paste0("UD", iitrend)) := eval(parse(text=iitrend)) 
    ######## gives wrong values...
    zXobj[, (paste0("UD", iitrend)) := .SD, .SDcol = iitrend]
    for (m in 1:length(aghh.defs))
    {
      aghhvec <- as.numeric(unlist(zXobj[, aghh.defs[m], with = F]))
      #### create x.yr2. x.yr3 for all covariates
####      zXobj[, (paste0(rep(c(iitrend, rvtv), each = 2), c(".yr2", ".yr3"))) := 
####        eval(parse(text = 
####          paste0("list(", paste(rep(c(iitrend, rvtv), each = 2), collapse = ","), ")")
####        ))]
      zXobj[, (paste0(rep(iitrend, each = 2), c(".yr2", ".yr3"))) := 
        eval(parse(text = 
          paste0("list(", paste(rep(iitrend, each = 2), collapse = ","), ")")
        ))]
      #### demean all dummies (iitrend): x1 is a dummy variable, 
      #### x2_{t} is a time varying variable
      ####   y_{t}=ci+a0+a1*x1+a2*x2_{t}+a3*x1*x2_{t}+e_{t}
      #### ci is individual effects of i. Other i suffix (xi, d1i, ...) is omitted. 
      #### Denote mX as X-mean(X),
      ####   y_{t}=mean(y_{t})+mci+a1*mx1+a2*mx2_{t}+a3*mx1*mx2_{t}+me_{t}
      #### Denote DX_{t} = X_{t}-X_{t-1}.
      ####   Dy_{t}=Dmean(y_{t})+a2*Dmx2_{t}+a3*mx1*Dmx2_{t}+Dme_{t}.
      #### I will first demean iitrend for all periods and keep only 1 period when 
      #### estimating FD.
      if (DemeanAtIndividualLevel){
        #### demeaning with individual mean
         iiid <- zXobj[, uniquid]
         for (eye in iiid) {
           ey <- grep(eye, iiid)
           for (j in c(iitrend, paste0(rep(iitrend, each = 2), c(".yr2", ".yr3"))))
             set(zXobj, i = ey, j = j, value = zXobj[[j]][ey] - mean(zXobj[[j]][ey], na.rm = T))
         }
      } else {
        #### demeaning with overall mean
        for (j in c(iitrend, paste0(rep(iitrend, each = 2), c(".yr2", ".yr3"))))
          set(zXobj, j = j, value = zXobj[[j]] - mean(zXobj[[j]], na.rm = T))
      }
      #### Create demeaned interactions: demeaned dummies * demeaned yrX
      #### and name them as DUMMY.yr2, DUMMY.yr3
      #### Only variables in iidd: sex, ages, age groups, class groups
      zXobj[, (paste0(iitrend, ".yr2")) := 
        lapply(1:length(iitrend), function(i) 
          #### NOTE: eval(parse(text=paste0(iitrend[i], "*Dummy1999"))) previously, yr2 was defined as 1999
          eval(parse(text=paste0(iitrend[i], "*Dummy2002")))
        )]
      zXobj[, (paste0(iitrend, ".yr3")) := 
        lapply(1:length(iitrend), function(i) 
          eval(parse(text=paste0(iitrend[i], "*Dummy2006")))
        )]
      zXobj[, (paste0(iislope, ".", aghh.defs[m], ".yr2")) := 
        lapply(1:length(iislope), function(i) 
          eval(parse(text=paste0(iislope[i], "*", aghh.defs[m], "*Dummy2002")))
        )]
      zXobj[, (paste0(iislope, ".", aghh.defs[m], ".yr3")) := 
        lapply(1:length(iislope), function(i) 
          eval(parse(text=paste0(iislope[i], "*", aghh.defs[m], "*Dummy2006")))
        )]
####      zXobj[, (paste0(rvtv, ".yr2")) := 
####        lapply(1:length(rvtv), function(i) 
####          eval(parse(text=paste0(rvtv[i], "*Dummy2002")))
####        )]
####      zXobj[, (paste0(rvtv, ".yr3")) := 
####        lapply(1:length(rvtv), function(i) 
####          eval(parse(text=paste0(rvtv[i], "*Dummy2006")))
####        )]
####      zXobj[, (paste0(rvtv, ".", aghh.defs[m], ".yr2")) := 
####        lapply(1:length(rvtv), function(i) 
####          eval(parse(text=paste0(rvtv[i], "*", aghh.defs[m], "*Dummy2002")))
####        )]
####      zXobj[, (paste0(rvtv, ".", aghh.defs[m], ".yr3")) := 
####        lapply(1:length(rvtv), function(i) 
####          eval(parse(text=paste0(rvtv[i], "*", aghh.defs[m], "*Dummy2006")))
####        )]
    }
    if (grepl("m", zXobjs[k])) 
      zXobj[, grepout("yr3", colnames(zXobj)) := NULL] else
      zXobj[, grepout("yr2", colnames(zXobj)) := NULL]
    if (grepl("99", zXobjs[k])) 
      zXobj[, grepout("2002", colnames(zXobj)) := NULL] else
      zXobj[, grepout("1999", colnames(zXobj)) := NULL]
    qsave(zXobj, paste0("../save/", gsub("\\.", "", zXobjs[k]), ".qs"))
    assign(zXobjs[k], zXobj)
  }
 qsave(zX, paste0("../save/z", ss, ".qs"))
}
```
</details>

In data preparation (`Create2RoundPanel.rnw`), `totalland` (decimal) is deflated with 1 million (1,000,000), or 10000 acre units. I reflated it back to original decimal units and further divided with 100 to make it to acre units. `totalvalue` is also deflated with 1,000,000 or in million BDT units. To get values in 1000 BDT units, multiply with 1000. 

```{r main sample size check, echo = F, eval = F}
#### zXy0, zXy1 (zEm0, zEm1, ..., zEp20, zEp21, ...) are created.
#### Need to run this after having done main estimation. 
zEm.1999 <- qread("../save/zEm1999.qs")
dim(zEm.1999)
zSm.1999 <- qread("../save/zSm1999.qs")
zEp.1999 <- qread("../save/zEp1999.qs")
zEp.2002 <- qread("../save/zEp2002.qs")
zSp.1999 <- qread("../save/zSp1999.qs")
zSp.2002 <- qread("../save/zSp2002.qs")
####zYp.1999 <- qread("save/zYp1999.ps")
zEp.1999[, AgeIn1999 := Age[survey == 2002] - 3, by = uniquid]
zSp.1999[, AgeIn1999 := Age[survey == 2002] - 3, by = uniquid]
zsobj <- c("zmobj", "zpobj")
zsobj2 <- c("zmobj2", "zpobj2")
zmobj <- c("zEm.1999", "zSm.1999")[1]
zpobj <- c("zEp.2002", "zSp.2002", "zEp.1999", "zSp.1999")[c(1, 3)]
zmobj2 <- c("zEm", "zSm")[1]
zpobj2 <- c("zEp2", "zSp2", "zEp9", "zSp9")[c(1, 3)]
library(qs)
#### Read from submission data / estimation for JHR
zi00N <- qread(paste0(pathsave0, "DID_N_MainResults.qs"))
ii <- jj <- s <- m <- 1
j <- 2
for (ii in 1:length(zsobj)) {
  zSobj <- get(zsobj[ii])
  zSobj2 <- get(zsobj2[ii])
  for (jj in 1:length(zSobj)) {
    #### ii: estimation objective (main/placebo)
    #### jj: jj, zE/zS sample selection
    #### j needs to be set at 1. We use j == 1 in SampleSizeCompareTable, 
    #### and apply sd == 1 in NuclearSampleSizeCompareTable
    j <- 1; ge <- 3
    zi <- zi00N[[ii]][[jj]][[s]][[j]][[ge]][[m]] 
    #### age s=10/nuclear j/agHHdef m/cl=satterthwaite
    zid <- lapply(zi, "[[", "level.data")
    zidd <- lapply(zi, "[[", "diff.data")
    #### least num of obs data
    zid0 <- zid[[length(zid)]]
    zidd0 <- zidd[[length(zidd)]]
    zid0 <- zid0[uniquid %in% zidd0[, uniquid], ]
    #### most num of obs data
    zid1 <- zid[[1]]
    zidd1 <- zidd[[1]]
    zid1 <- zid1[uniquid %in% zidd1[, uniquid], ]
    #### original data
    z1 <- get(zSobj[jj])
    z1[, tee := 1:.N, by = uniquid]
    z.0 <- z1[uniquid %in% zid0[, uniquid], ]
    z.1 <- z1[uniquid %in% zid1[, uniquid], ]
    assign(paste0(zSobj2[jj], 0), z.0) #### zEm0: least num of obs
    assign(paste0(zSobj2[jj], 1), z.1) #### zEm1: most num of obs
  }  #### jj
}  #### ii
```
<details><summary>Click here to see the code of attaching id variables.</summary>
```{r id variable from orginal rd 1 file}
for (yy in c(0, 3, 7)) {
  pathsource000 <- paste0(pathsource, "/ffe/200", yy, "/Data/HouseholdData/STATA/")
  assign(paste0("pathsource0", yy), pathsource000)
  fn <- list.files(pathsource000)
  assign(paste0("fn", yy), list.files(pathsource000, full.names = T))
  assign(paste0("fn0", yy), list.files(pathsource000))
}
```
Add `id` variable from original rd 1 file `r fn00`
```{r add id variable from orginal rd 1 file}
#### fn0, fn3, fn7
ros1 <- data.table(foreign::read.dta(grepout("a1", fn0)))
#### rd 2 has hhid = hh used in uniquid
#### uniquid = paste0(4000+hhid, ".", putzeroontop(mid/100))
ros2 <- data.table(foreign::read.dta(grepout("a1", fn3)))
ros3 <- data.table(foreign::read.dta(grepout("rost", fn7)))
#### ros1 and ros2 have hhnum in common. id = hhnum-mid
#### ros2 and ros3 have hhidn in common. id2 = hhidn-mid
ros1[, id := paste0(hhnum, "-", mid)]
ros2[, id := paste0(hhnum, "-", mid)]
ros2[, id2 := paste0(hhidn, "-", mid)]
ros3[, id2 := paste0(hhidn, "-", mid)]
ros1[, rd2 := 0L]
ros1[id %in% ros2[, id], rd2 := 1L]
ros2[, rd3 := 0L]
ros2[id2 %in% ros3[, id2], rd3 := 1L]
ros1[, rd3 := 0L]
ros1[id %in% ros2[rd3==1L, id], rd3 := 1L]
ros1[, exist := paste0(1, rd2, rd3)]
ros1[, exist := factor(exist)]
#### attach uniquid in ros1
ros2[, uniquid := paste0(4000+hhidn, ".", putzeroontop(mid))]
rs2id <- ros2[, .(id, uniquid)]
setkey(rs2id, id); setkey(ros1, id)
RosRd1 <- rs2id[ros1]
#### attach schoolp
a00 <- foreign::read.dta(grepout("a2a", fn0))
a00 <- data.table(a00)
a00sch <- a00[, .(hhnum, mid, schoolp)]
a00sch[, schoolp := as.numeric(grepl("Y", schoolp))]
setkey(RosRd1, hhnum, mid); setkey(a00sch, hhnum, mid)
RosRd1 <- a00sch[RosRd1]
#### attach agHH defs
#### agri or tenant as income source
#### 	sum(ii1 <- whichgrep("Agri|Tena", z[, "isource"]) & y2k )
#### tenant and own farmers as occupation
#### 	sum(ii2 <- whichgrep("Agri|enan|farm", z[, "occup"]) & y2k)
#### a subset of ii1, owners and cultivators
#### 	sum(ii3 <- whichgrep("OwnL|Tena", z[, "isource"]) & y2k) 
#### ag labourer
#### 	sum(iiL <- whichgrep("Agri.*day", z[, "occup"]) & y2k)
#### 	c(sum(ii1 & ii2), sum(ii1 & !ii2), sum(!ii1 & ii2))
#### 	table(ocagHHold=ii2, aglabHH=iiL)
#### 	fem <- z[, "sex"] == "Female"
#### 	hd <- whichgrep("head", z[, "rhhold"])
#### 		####	adult members: age > 20 and not enrolled, both in 2000
#### 	adlt <- y2k & z[, "age"] > 20 & !eq(z[, "schoolp"], "Yes")
#### 		####	isource agri HH
#### 	z <- cbind(z, isagHH = z[, "hh"] %in% z[ii1 & y2k, "hh"])
#### 		####	owner cultivator household as ownagHH
#### 	z <- cbind(z, ownagHH = z[, "hh"] %in% z[ii3 & y2k, "hh"])
#### 		####	M/F head isource|occup is agri
#### 	z <- cbind(z, hdagHH = 
####    z[, "hh"] %in% z[(ii1|ii2|ii3) & y2k & hd, "hh"])
#### 	z <- cbind(z, mhdagHH = 
####    z[, "hh"] %in% z[(ii1|ii2|ii3) & y2k & hd & !fem, "hh"])
#### 	z <- cbind(z, fhdagHH = 
####    z[, "hh"] %in% z[(ii1|ii2|ii3) & y2k & hd & fem, "hh"])
#### 		####	agri laborer indicator
#### 	z <- cbind(z, aglabHH = z[, "hh"] %in% z[iiL & y2k, "hh"])
#### 		####	occup agri HH (old def, wrong, due to error in data.prn codes)
#### 	z <- cbind(z, ocagHHold = z[, "hh"] %in% z[ii2 & y2k, "hh"])
#### 		#### correct def of occup ag HH
#### 	pathsource00 <- paste0(pathsource, "/ffe/2000/Data/HouseholdData/STATA/")
#### 	fn <- list.files(pathsource00)
#### 	fn0 <- list.files(pathsource00, full.names = T)
#### 	#### 1.A.1 section (roster)
#### 	e00 <- foreign::read.dta(grepout("a1", fn0))
#### 	e00 <- data.table(e00)
#### 	f1 <- fread(paste0(pathsource, "ffe2000.prn"))
#### 	f1id <- unique(f1[!is.na(q1_04n), .(hhnum, q1_04n)])
#### 	setnames(f1id, "q1_04n", "hh")
#### 	setkey(f1id, hhnum); setkey(e00, hhnum)
#### 	e00 <- e00[f1id]
#### 	setkey(e00, hh)
#### 	#### ocagHH: Any member of HH reports agri as one's occupation
#### 	z <- cbind(z, ocagHH = 
####    z[, "hh"] %in% unique(e00[grepl("Ag|arm|enan", occup), hh]))
####	z <- cbind(z, agHH0 = z[, "isagHH"] | z[, "ocagHH"])
qsave(RosRd1, "../save/OriginalRd1RosterFileWithUniquid.qs")
```
</details>


# Understanding characteristics of sample used in main results

## Descriptive statistics of main and placebo samples


<details><summary>Click here to see the code of sample descriptive statistics.</summary>
```{r sample destat, echo = T, warning = F}
yzw <- readRDS("../save/DataForJHR.rds")
zEm.1999 <- qread("../save/zEm1999.qs")
zE = copy(yzw[grepl("111|110", exist), ])
samples <- c("main", "placebo")
z23 <- c("z2", "z3")
zsobj <- c("zmobj", "zpobj")
zsobj2 <- c("zmobj2", "zpobj2")
empeeobj <- c("Mobj", "Pobj")
zpobj <- c("zEp.2002", "zSp.2002", "zEp.1999", "zSp.1999")[c(1, 3)]
zmobj <- c("zEm.1999", "zSm.1999")[1]
Mobj <- "Main sample, 1999 cohort"
Pobj <- c("Placebo sample, 2002 cohort", "Placebo sample, 1999 cohort")
zmobj2 <- c("zEm", "zSm")
zpobj2 <- c("zEp2", "zSp2", "zEp9", "zSp9")[c(1, 3)]
yrXs <- list(c("yr2", "yr2"), c("yr3", "yr3", "yr3", "yr3"))
#### regressors.list <- list(
####   main = regressorsM,
####   placebo = regressorsM2002
#### )
####  (note the chapitalised names in some) created in the below loop
####  binary
varcompare01 <- c("Enrolled", "AgHH", "HdagHH", "IsagHH", "OcagHH", 
  "StipendProgram", "NonStipendProgram",
  # hdsex uses Rd1RelToHead while hd.sex = 1 if reltohead=1 in any round (vulnerable to entry errors)
  # Need to use .yr2 variables: By substituting with yrXs, we can specify 
  # yr2 (baseline value) in main estimation, yr3 (2002 value) in placebo estimation.
  "Sex", "UDhdsex", "UDnonmuslim", "UDflooded",
  "kutchalatrine.yr2", "ownwater.yr2", 
  "Hd.edulevel.primary", "Hd.edulevel.secondary", 
  "Sp.edulevel.primary", "Sp.edulevel.secondary")
#### continuous
varcompare2 <- c("age", "yield", "UDOldSibF", "UDOldSibM") #"OldAgSibF", "OldAgSibM")
#### scaled continuous
varcompare3 <- c("pclandDec", "pcnlasset1000")
boxsize <- .85
library(qs)
zi00N <- qread("../save/DID2024_N_MainResults.qs")
for (ii in 1:length(samples)) {
  zSobj <- get(zsobj[ii]) # zmobj or zpobj
  mpobj <- get(empeeobj[ii])
  yrxs <- yrXs[[ii]]
  dst0 <- vector("list", length = length(10:12)) # s
  dst <- vector("list", length = length(zSobj)) # jj
  # jj
  #  zmobj: zEm.1999, zSm.1999
  #  zpobj: zEp.2002, zSp.2002, zEp.1999, zSp.1999
  for (jj in 1:length(zSobj)) {
    dst[[jj]] <- dst0
    # choose yrX
    yrx <- yrxs[jj]
    varcompare1 <- gsub("yr2", yrx, varcompare01)
    # drop nonmuslims if zXp
    if (any(grepl("p", zSobj))) 
      varcompare1 <- varcompare1[!grepl("nonmu", varcompare1)]
    for (s in 1) {
      s0 <- (10:12)[s]
      i <- paste0("older", s0)
     # ii: estimation objective (main/placebo), m or p
     # jj: jj, zE/zS sample selection, E or S or Y
     # dd: demeaned if 1
     # s: agelb 10
     # j: direct offspring
     # ge: boys+girls
     dd <- s <- 1
     j <- 2
     ge <- 3
     zi <- zi00N[[ii]][[jj]][[s]][[j]][[ge]][[1]] # resultsN0[[ii]][[jj]][[dd]][[s]][[j]][[ge]][[m]]
     # age s=10/nuclear j/agHHdef m/cl=satterthwaite
      # [[ii]][[jj]][[s]][[j]][[m]][[k]]
     zid <- lapply(zi, "[[", "level.data")
     zid <- zid[[length(zid)]]
     zidd <- lapply(zi, "[[", "diff.data")
     zidd <- zidd[[length(zidd)]]
     z1 <- zid[uniquid %in% zidd[, uniquid], ]
     z1[, age := age2^(.5)]
     if (any(grepl("LHS", colnames(z1)))) setnames(z1, c("LHS"), c("Enrolled"))
     z1[, tee := 1:.N, by = uniquid]
     # Binary: copy all 0/1 values at tee == 1 to other rds
     # Change back from demeaned to undemeaned values
     yrXvars <- grepout(paste0(yrx, "$"), colnames(z1))
     yrXvars <- yrXvars[!grepl("^pc|Sib|hdsex|agH", yrXvars)]
     yrXvars0 <- gsub(paste0("\\.", yrx), "", yrXvars)
     yrXvars1 <- yrXvars[!grepl("Sib", yrXvars)]
     yrXvars10 <- gsub(paste0("\\.", yrx), "", yrXvars1)
     # Add agHH defs from original data
     yrXvars10 <- gsub("^agHH$", aghh.defs[1], yrXvars10)
     # pcland, pcnlasset is not in z1 (zid). Need to get from yzw
     yrXvars10 <- c("hdagHH", "isagHH", "ocagHH", "hdsex", "pcland", "pcnlasset", yrXvars10)
     if (ii == 1) 
       yzw.vars1 <- yzw[survey == 1999, c("uniquid", yrXvars10), with = F] else
       yzw.vars1 <- yzw[survey == 2002, c("uniquid", yrXvars10), with = F]
     setkey(yzw.vars1, uniquid); setkey(z1, uniquid)
     z12 <- yzw.vars1[z1]
     #z1[, (yrXvars0) := 0L]
     ## i needs to be set at tee == 2, because sex.yr2 > 0 for sex = 1 in yr2, but sex.yr2 > 0 for sex = 0 in yr1
     #for (yy in 1:length(yrXvars))
     #  set(z1, i = which(z1[["tee"]] == 2 & z1[[yrXvars[yy]]] > 0), 
     #    j = grep(paste0("^", yrXvars0[[yy]], "$"), colnames(z1)), value = 1L)
     #z1[, (yrXvars0) := .SD[tee == 2], by = uniquid, .SDcols = yrXvars0]
     for (v2 in c("sex", "agHH", "hdagHH", "isagHH", "ocagHH",
       #"OldSibF", "OldSibM", #"OldAgSibF", "OldAgSibM", 
       "hd.edulevel.primary", "hd.edulevel.secondary", 
       "sp.edulevel.primary", "sp.edulevel.secondary")) {
       V2 <- paste0(toupper(substr(v2, 1, 1)), substr(v2, 2, nchar(v2)))
       z12[, (V2) := eval(parse(text = v2))]
     }
     # HdagHH changes. tee == 2 has more HadgHH == 1. Use tee == 2 values.
     z12[, HdagHH := HdagHH[tee==2], by = uniquid]
     z12[, AgHH := as.integer(agHH>0)]
     # UD covariates: Created in SampleSelectionDemeaning.rnw. Need to get from zEm.1999
     zud <- zEm.1999[, .(uniquid, tee, UDhdsex, UDnonmuslim, UDflooded, UDOldSibF, UDOldSibM)]
     setkey(zud, uniquid, tee); setkey(z12, uniquid, tee); 
     z12 <- zud[z12]
     # 4002.04: totalland = 5 decimal, 5 members => pcland = 1 decimal
     z12[, pclandDec := pcland]
     #"per member nonland asset (1000 tk)",
     # totalvalue is deflated with 1million (1000000). Multiply with 1000 to get 1000 Tk units.
     z12[, pcnlasset1000 := pcnlasset*1000]
     # Keep only rd 1 values. (Rd 1 values are copied already, do it again to make sure.)
     z12[, pclandDec := pclandDec[1], by = uniquid]
     z12[, pcnlasset1000 := pcnlasset1000[1], by = uniquid]
     # all variables to numeric
     d1 <- sapply(z12[tee == 1, gsub("\\.yr.$", "", 
       c(varcompare1, varcompare2, varcompare3)), with = F], as.numeric)
     d1 <- destat(d1, signif = 3)
     dst[[jj]][[s]] <- d1
     dst.print <- as.matrix(d1)
     d2 <- data.table(d1)
     thesecols <- c("mean", "std")
     d2[, (thesecols) := lapply(.SD, formatC, digits = 3, format = "f"), .SDcols = thesecols]
     d2 <- d2[, thesecols, with = F]
     dst.print <- a2b(dst.print, "NA", "")
     dst.print[, thesecols] <- as.matrix(d2)
     source("../program/substitution_table.R")
     rn <- rownames(dst.print)
     # substitute variable names with short labels
     for (mm in 1:nrow(sbt))
       if (length(iir <- grep(sbt[mm, 1], rn)) > 0) 
         rn[iir] <- sbt[mm, 2]
     dst.print <- cbind(covariates = rn, dst.print)
     #### LaTeX table
     ltb <- latextab(dst.print, delimiterline = NULL, 
        hcenter = c(5.75, rep(boxsize, 5), 1.0, rep(boxsize, ncol(dst.print)-7)),
        hleft = c("\\scriptsize\\hfill", rep("\\hfill\\scriptsize$", ncol(dst.print)-1)), 
        hright = c("", rep("$", ncol(dst.print)-1)),
        headercolor = NULL, alternatecolor = NULL)
     ltb <- gsub("agr", "Agr", ltb)
     ltb <- c(
         ltb[1:2], 
         "\\hline",
         ltb[-c(1:2)]
       )
     write.tablev(ltb, 
        paste0("../draft/Tables/SampleDescriptiveStat_", i, "_", zSobj[jj], ".tex")
        , colnamestrue = F)
     #### HTML table
     library(kableExtra)
     ktb <- data.table(dst.print)
     kt <- kable(ktb, align = 
       paste0("r", paste0(rep("c", ncol(ktb)-1), collapse = "")), 
       caption = paste("Descriptive statistics:", mpobj[jj]))
     kt <- column_spec(kt, 1, width = "9cm; min-width:9cm;")
     kt <- column_spec(kt, 2:6, width = "2.0cm; min-width:2.0cm;")
     kt <- kableExtra::footnote(kt, general = "Sample of direct offspring of household heads.")
     assign(paste0("kt", zSobj[jj]), kt)
    }  # s
    qsave(dst, paste0("../save/SampleDestat_", zSobj[jj], ".qs"))
  }  # jj
}  # ii
```
</details>

```{r sample destat in html, echo = F}
ktzEm.1999
```
```{r sample destat zep2002 in html, echo = F}
ktzEp.2002
```


## Simple DID, regression sample descriptive statistics, ag-nonag contrasts

<details><summary>Click here to see the code of simple DID.</summary>
```{r plain DID}
library(clubSandwich)
Zm <- qread("../save/zEm1999.qs")
zm <- Zm[, .(survey, thana, hh, uniquid, agHH0, isagHH, 
  sd, AgeIn1999, AgeIn2006, schoolp, program, anyprog)]
zm[, aghh := as.integer(agHH0>0)]
zm[, y1999 := as.integer(survey==1999)]
zm[, FFWProgram := as.integer(grepl("FFW", anyprog))]
zm[, NonFFWProgram := as.integer(!is.na(anyprog) & !grepl("FFW|non-m", anyprog))]
lm0 <- lm(schoolp ~ aghh*y1999, 
  data = zm[survey < 2006 & 10 <= AgeIn1999 & AgeIn1999 <= maxAge, ])
lm1 <- lm(schoolp ~ aghh*y1999+program, 
  data = zm[survey < 2006 & 10 <= AgeIn1999 & AgeIn1999 <= maxAge, ])
lm2 <- lm(schoolp ~ aghh*y1999+anyprog, 
  data = zm[survey < 2006 & 10 <= AgeIn1999 & AgeIn1999 <= maxAge, ])
lm3 <- lm(schoolp ~ aghh*y1999+FFWProgram+program, 
  data = zm[survey < 2006 & 10 <= AgeIn1999 & AgeIn1999 <= maxAge, ])
clusterNum0 <- zm[survey < 2006 & 10 <= AgeIn1999 & AgeIn1999 <= maxAge, thana]
clusterNum0 <- as.numeric(factor(asc(clusterNum0)))
clusterNum3 <- clusterNum2 <- clusterNum1 <- clusterNum0
dideasy <- function(x, regnum) {
  # Get CIs of lm obj using the cluster variable in global environment
  clnum <- get(paste0("clusterNum", regnum), envir = globalenv())
  if (length(x$na.action) > 0) clnum <- clnum[-(x$na.action)]
  return(clubSandwich::conf_int(x, vcov = "CR2", level = 0.95, 
    test = "Satterthwaite", cluster = clnum, coefs = "All", p_values = T))
}
lmlist <- list(lm0, lm1, lm2, lm3)
lapply(1:length(lmlist), function(i) dideasy(lmlist[[i]], regnum = i-1)) 
```
</details>

Given that the data is collected with program impacts in mind, we expect the program indicator to be correlated with school enrollment and will need to add to the estimating equation as a covariate. Then, we need to know if `program` is distributed as good as random between ag and nonag. `program` is defined in `Construct3RoundPanelAndClean.rnw` with grepl("FF|stipe|RRMP|VGD", anyprog). The table (ref:SDiffTable) shows <Blue>`programs` are, indeed, as good as randomly distributed between ag and non-ag HHs</Blue> with the large $p$ values. 

<details><summary>Click here to see the code of ag vs. nonag differences.</summary>

```{r program random test, echo = T, class.output="scroll-100"}
#### Table 1 ag nonag difference AgNonAgDiffTableForJHR
yzw <- qread("../save/DataRamadan.qs")
zEm.1999 <- qread("../save/zEm1999.qs")
#### use yzw to get undemeaned dummies
yzw[, HeadAge := age[grepl("head", reltohead)][1], by = hh]
yzw[, HeadSex := sex[grepl("head", reltohead)][1], by = hh]
yzw[, FFWProgram := as.integer(grepl("FFW", anyprog))]
yzw[, CreditProgram := as.integer(grepl("Grameen|BRAC", anyprog))]
yzw[, NonFFWProgram := as.integer(!is.na(anyprog) & !grepl("FFW|non-m", anyprog))]
zE = copy(yzw[grepl("111|110", exist), ])
varcompare01 <- c("Enrolled", "agHH", "hdagHH", 
  "program", "FFWProgram", "NonFFWProgram", "CreditProgram",
  "sex", "hdsex", "UDnonmuslim", "UDflooded",
  "kutchalatrine.yr2", "ownwater.yr2", 
  "hd.edulevel.primary", "hd.edulevel.secondary", 	
  "sp.edulevel.primary", "sp.edulevel.secondary")
varcompare2 <- c("Age", "yield")
varcompare3 <- c("pclandDec", "pcnlasset1000", 
  "rainfallMeanY", "highMeanY", "lowMeanY",
  "UDOldSibF", "UDOldSibM" #,"OldAgSibF", "OldAgSibM",
)
Sample.Diff <- NULL
zi00 <- qread(paste0(pathsave0, "FD_N_MainCRCoV_results.qs"))
samples <- c("main", "placebo")
z23 <- c("z2", "z3")
zsobj <- c("zmobj", "zpobj")
zsobj2 <- c("zmobj2", "zpobj2")
zpobj <- c("zEp.2002", "zSp.2002", "zEp.1999", "zSp.1999")[c(1, 3)]
zmobj <- c("zEm.1999", "zSm.1999")[1]
zmobj2 <- c("zEm", "zSm")
zpobj2 <- c("zEp2", "zSp2", "zEp9", "zSp9")[c(1, 3)]
ii <- jj <- s <- 1; j <- 2; 
#### agHH def: 3=Head's reply (previously, 1=agHH0)
m <- ge <- 3
zSobj <- get(zsobj[ii])
yrx <- c("yr2", "yr3")[ii]
s0 <- (10:12)[s]
clnum <- 2
#### 1st stage result
#### resultsN[[ii]][[jj]][[1]][[s]][[j]][[ge]][[m]][[k]]
zi <- zi00[[ii]][[jj]][[1]][[s]][[j]][[ge]][[m]]
zid <- lapply(zi, "[[", "level.data")
zidd <- lapply(zi, "[[", "diff.data")
#### most-number data
zidd1 <- zidd[[1]]
zid1 <- zid[[1]][uniquid %in% zidd1[, uniquid], ] # has only a part of covariates
zid2 <- zid[[length(zid)]] # this has all covariates
zid2[, tee := 1:.N, by = uniquid]
zid2[, Age := age2^(.5)]
#### least number data
zidd <- zidd[[length(zidd)]]
z1 <- zid2[uniquid %in% zidd[, uniquid], ]
#### thrown away obs: obs only found in most number data
ii.thrown <- unique(zid2[!(uniquid %in% zidd[, uniquid]), uniquid])
#### kept obs: obs kept in least number data
ii.kept <- unique(zid2[(uniquid %in% zidd[, uniquid]), uniquid])
#### yrx variables: demeaned => undemeaned (retrieve from yzw data)
yrXvars <- grepout(paste0(yrx, "$"), colnames(z1))
#### variables except OldSib (copied already as undemeaned UDOldSib...)
yrXvars <- yrXvars[!grepl("^pc|Sib|hdsex|\\.agH", yrXvars)]
yrXvars1 <- gsub(paste0("\\.", yrx), "", yrXvars)
yrXvars10 <- gsub("^agHH$", aghh.defs[m], yrXvars1)
yrXvars10 <- c("rainfallMeanY", "highMeanY", "lowMeanY", "hdsex", 
  "pcland", "pcnlasset", "FFWProgram", "NonFFWProgram", "CreditProgram", yrXvars10)
yzw.vars1 <- yzw[survey == 1999, c("uniquid", yrXvars10), with = F]
#### Micro credit programs seem to be nonexistent in 1999
if (all(yzw.vars1[, CreditProgram]==0L)) yzw.vars1[, CreditProgram := NULL]
#### base: z1 (obs used in FDestimation), 
####  not zid2 (most numbered data in fdestimation)
setkey(yzw.vars1, uniquid); setkey(z1, uniquid)
z12 <- yzw.vars1[z1]
#### UD covariates: Created in SampleSelectionDemeaning.rnw. 
#### Need to get from zEm.1999
zud <- zEm.1999[, .(uniquid, tee, UDhdsex, UDnonmuslim, 
  UDflooded, UDOldSibF, UDOldSibM)]
setkey(zud, uniquid, tee); setkey(z12, uniquid, tee); 
z12 <- zud[z12]
z12[, pclandDec := pcland/100] # in acre
z12[, pclandDec := pcland*100] # in decimal
z12[, pcnlasset1000 := pcnlasset*1000] # in 1000 BDT
z12[, pclandDec := pclandDec[1], by = uniquid]
z12[, pcnlasset1000 := pcnlasset1000[1], by = uniquid]
setnames(z12, c("schoolp"), c("Enrolled"), skip_absent = T)
#### Change first character of variable names to upper case
for (v2 in grepout("^agH|^sex|^hd\\.|^sp|^ku|^own", yrXvars10)) {
    V2 <- paste0(toupper(substr(v2, 1, 1)), substr(v2, 2, nchar(v2)))
    z12[, (V2) := eval(parse(text = v2))]
}
z12[, c("AgHH", "NonAgHH") := 0L]
z12[eval(parse(text=aghh.defs[m])) == 0L, NonAgHH := 1L]
z12[eval(parse(text=aghh.defs[m])) == 1L, AgHH := 1L]
z01 <- z12[tee == 1, ]
z.0 <- z01[eval(parse(text=aghh.defs[m])) == 0L, ]
z.1 <- z01[eval(parse(text=aghh.defs[m])) == 1L, ]
ClusterVec <- as.numeric(z01[, thana])
SampleDiff <- NULL
#### binary variables
for (v in grepout("^Enr|LH|^Sex|^Hd|^Sp|^Ku|^Own|^UD[hfn]|^pr|FFW|Cre", 
  colnames(z.1))) {
  form1 <- paste(v, "~ -1 + AgHH + NonAgHH")
  rg1 <- lm(as.formula(form1), data = z01)
  ci1 <- clubSandwich::conf_int(rg1, vcov = "CR2", level = 0.95, 
    test = "Satterthwaite", cluster = ClusterVec, coefs = "All", p_values = T)
  form2 <- paste(v, "~", aghh.defs[m])
  rg2 <- lm(as.formula(form2), data = z01)
  ci2 <- clubSandwich::conf_int(rg2, vcov = "CR2", level = 0.95, 
    test = "Satterthwaite", cluster = ClusterVec, coefs = "All", p_values = T)
  form3 <- paste(v, "~ +1")
  rg3 <- lm(as.formula(form3), data = z01)
  ci3 <- clubSandwich::conf_int(rg3, vcov = "CR2", level = 0.95, 
    test = "Satterthwaite", cluster = ClusterVec, coefs = "All", p_values = T)
  d0 <- as.numeric(unlist(z.0[, v, with = F]))
  d1 <- as.numeric(unlist(z.1[, v, with = F]))
  d01 <- as.numeric(unlist(z01[, v, with = F]))
  mean01 <- mean(d01, na.rm = T)
  ttested <- t.test(d1, d0)
  SampleDiff <- rbind(SampleDiff, 
    rbind(
      c(zSobj[jj], paste0("older", s0), v, 
        mean01, ttested$est, 
        ttested$p.value, ci2[2, "p_val"])
    , c("", "", paste0("se$_{", v, "}$"), ci3$SE, ci2[, "SE"], "", "")
    )
  )
}
#### continuous variables
for (v in c(varcompare2, varcompare3)) {
  form1 <- paste(v, "~ -1 + AgHH + NonAgHH")
  rg1 <- lm(as.formula(form1), data = z01)
  ci1 <- clubSandwich::conf_int(rg1, vcov = "CR2", level = 0.95, 
    test = "Satterthwaite", cluster = ClusterVec, coefs = "All", p_values = T)
  form2 <- paste(v, "~", aghh.defs[m])
  rg2 <- lm(as.formula(form2), data = z01)
  ci2 <- clubSandwich::conf_int(rg2, vcov = "CR2", level = 0.95, 
    test = "Satterthwaite", cluster = ClusterVec, coefs = "All", p_values = T)
  form3 <- paste(v, "~ +1")
  rg3 <- lm(as.formula(form3), data = z01)
  ci3 <- clubSandwich::conf_int(rg3, vcov = "CR2", level = 0.95, 
    test = "Satterthwaite", cluster = ClusterVec, coefs = "All", p_values = T)
  d0 <- as.numeric(unlist(z.0[, v, with = F]))
  d1 <- as.numeric(unlist(z.1[, v, with = F]))
  d01 <- as.numeric(unlist(z01[, v, with = F]))
  mean01 <- mean(d01, na.rm = T)
  std01 <- var(d01, na.rm = T)^(.5)
  ttested <- t.test(d1, d0)
  SampleDiff <- rbind(SampleDiff, 
    rbind(
      c(zSobj[jj], paste0("older", s0), v, 
        mean01, ttested$est, 
        ttested$p.value, ci2[2, "p_val"])
    , c("", "", paste0("se$_{", v, "}$"), ci3$SE, ci2[, "SE"], "", "")
    )
  )
}
#### substitute variable names
source(paste0(pathprogram, "SubstitutionTableForHTML.R"))
colnames(SampleDiff) <- c("sample", "age", "variables", "overall",
  "agHH", "nonagHH", "t", "Satterthwaite")
SampleDiff <- data.table(SampleDiff)
rn <- SampleDiff[, variables]
Rn <- read.table(text = "
  'Child is enrolled (yes = 1)' LHS
  'Age of child' Age
  'Sex of child (female = 1)' Sex
  'HH head sex (female = 1)' UDhdsex
  'HH head education: primary' Hd.edulevel.primary
  'HH head spouse education: primary' Sp.edulevel.primary
  'HH head education: secondary' Hd.edulevel.secondary
  'HH head spouse education: secondary' Sp.edulevel.secondary
  'Number of older brothers per child' UDOldSibM
  'Number of older sisters per child' UDOldSibF
  'Per-member land holding (decimal)' pclandDec
  'Per-member non-land asset (1000 Tk)' pcnlasset1000
  'HH has piped water supply' Ownwater
  'HH has sanitary latrine (structured toilet)' Kutchalatrine
  'HH is non-Muslim' UDnonmuslim
  'HH receives Food-for-Work (FFW) program' FFWProgram
  'HH receives non-FFW program' NonFFWProgram
  'HH receives a program' program
  'Mean rainfall (millimeters)' rainfallMeanY
  'Mean high temperature (Celsius)' highMeanY
  'Mean low temperature (Celsius)' lowMeanY
  'Paddy yield (in 000 metric tons)' yield
  'Flooded (=1)' UDflooded
")
Rn <- data.table(Rn)
setnames(Rn, c("changedto", "org"))
rnseq <- NULL
for (ss in 1:nrow(Rn)) {
  iist <- paste0("^", Rn[["org"]][ss], "$")
  if (any(iii <- grepl(iist, rn))) {
    rnseq <- c(rnseq, grep(iist, rn))
    rn[iii] <- Rn[ss, changedto]
  }
}
rn[seq(2, length(rn), 2)] <- ""
#### for (ss in 1:nrow(sbt)) {
####   if (any(grepl(sbt[ss, "org"], rn)))
####     rn[grepl(sbt[ss, "org"], rn)] <- sbt[ss, "changedto"]
#### }
rn <- gsub("^se.*", "", rn)
SampleDiff[, variables := rn]
SampleDiff <- data.table(SampleDiff[c(t(data.table(rnseq, rnseq+1))), ])
for (j in c("overall", "agHH", "nonagHH", "t", "Satterthwaite")) 
  set(SampleDiff, j = j, value = as.numeric(as.character(SampleDiff[[j]])))
#### #### reorder
#### reo <- paste0("Enr|LHS|rain|high|low|[Yy]i|[pP]rog|[Aa]ge|[Ss]ex|",
####   "d ed|e ed|pri|seco|bro|sis|sibl|hold|asse|wat|toi|latr|Mus|Flo")
#### reo <- unlist(strsplit(reo, "\\|"))
#### reo2 <- NULL
#### for (rr in reo) reo2 <- c(reo2, grep(rr, unlist(SampleDiff[, 3])))
#### reo2 <- c(t(cbind(reo2, reo2+1)))
#### SampleDiff <- SampleDiff[reo2, ]
SDiff.print = copy(SampleDiff)
if (any(grepl("LHS", SampleDiff[, variables]))) 
  SDiff.print[grepl("LHS", variables), variables := "Enrollment"]
for (j in c("overall", "agHH", "nonagHH", "t", "Satterthwaite")) 
  SDiff.print[, (j) := formatC(eval(parse(text=j)), digits = 4, format = "f")]
SDiff.print <- rbind(as.matrix(SDiff.print), 
  c("", "", "n", nrow(z01), nrow(z.1[tee == 1, ]), nrow(z.0[tee == 1, ]), "", ""))
SDiff.print <- a2b(SDiff.print, "   NA", "")
#### Parenthesize the std
iispace <- which(
  SDiff.print[, 3]=="" & 
    !grepl("interaction with|^n$|bar.R|thana dum|mean at|raw DID", SDiff.print[, 3])
    )
iispace <- iispace-1
iispace2 <- iispace[seq(2, length(iispace), 2)]
for (kk in c("overall", "agHH", "nonagHH")) 
  SDiff.print[iispace+1, kk] <- 
    paste0("(", 
      formatC(as.numeric(SDiff.print[iispace+1, kk]), digits = 3, format = "f")
    , ")")
#### Bracket p values
for (kk in c("t", "Satterthwaite")) 
  SDiff.print[iispace, kk] <- 
    paste0("[", 
      formatC(as.numeric(SDiff.print[iispace, kk])*100, digits = 2, format = "f")
    , "]")
#### LaTeX table
ltb <- latextab(SDiff.print[, -(1:2)], delimiterline = NULL, 
    hcenter = c(5, rep(2, ncol(SDiff.print)-3)),
    hleft = c("\\scriptsize", rep("\\hfil\\scriptsize$", ncol(SDiff.print)-3)), 
    hright = c("\\hfill", rep("$", ncol(SDiff.print)-3)),
    headercolor = NULL, 
    addseparatingcols = 3, separatingcolwidth = .1, 
    separatingcoltitle = c("\\textsf{Means}", "\\textsf{$p$-values (\\%)}"),
    adjlskiprows = iispace, adjustlineskip = "-.5ex",
    alternatecolorManual = c(iispace2, iispace2+1),
    alternatecolorManualColor = NULL
    )
ltb[3] <- gsub("\\\\\\\\", "", ltb[3])
ltb <- c(
    ltb[1:grep("^Child.*nrolled", ltb)-1],
    "\\hline\\multicolumn{7}{l}{\\scriptsize HH level variables}\\\\\\hline",
    ltb[grep("^Child.*nrolled", ltb):(grep("^Mean", ltb)[1]-1)],
    "\\hline\\multicolumn{7}{l}{\\scriptsize Thana level variables}\\\\\\hline",
    ltb[grep("^Mean", ltb)[1]:length(ltb)]
  )
write.tablev(ltb
  ,  paste0("../draft/Tables/AgNonAgDestat.tex")
  ,  colnamestrue = F)
rm(zi00)
```
</details>

<details><summary>Click here to see the code of ag-nonag difference table.</summary>
```{r show ag nonag diff table}
#### HTML table
library(kableExtra)
kt <- kable(SDiff.print[, -(1:2)], align = 
  paste0("r", paste0(rep("c", ncol(SDiff.print)-1), collapse = "")), 
  caption = "Baseline differences between agricultural and non-agricultural households")
kt <- column_spec(kt, 1, width = "9cm; min-width:9cm;")
kt <- column_spec(kt, 2:6, width = "2.5cm; min-width:2.5cm;")
kt <- kableExtra::footnote(kt, general = "Differences between the children of agricultural and non-agricultural households in main data with the 10 years old age lowerbound. Overall, agHH, nonagHH columns show means for all households, means for agricultural households, means for non-agricultural households. Column headed by t shows p-values of regular t-tests, Satterthwaite shows p-values under a Sattherthwaite correction for small number of clusters.")
#kable(SDiff.print, format = "latex", booktabs = TRUE)
```
</details>

<!-- \@ref(tab:destat) -->

```{r desstat, echo = F}
kt
```


# Preparing regressors

<details><summary>Click here to see the code of regressor preparation.</summary>
```{r regressor pieces and reordering strings}
#### ii0 is a set of variables that will not be required for any of estimation steps below.
#### Note: Some variables are not used in estimation but needed to show the clusters.
ii0 <- paste("^nonm|only|abs|isag|ocag|ownag|hd.*[gmiltxy]$|educa", 
    "pce|dist|vill|der$|^latrine$|^k.*trine$|water$|older|pc4|pov|gps",
    "sp.edulevel$|sp.e.*y$|sp.age$|sp.d|pc.*ag|^sex$", 
    "scha|hd.any|hd.bmi|hd.age|^first|^cm|hdsex|1000",
    "prodtha|areatha|yi.*na.yr2$", 
    "memship|spatt|floode|dummyAa|DummyEd", sep = "|")
####  covariate selection
  #  familytype = nuclear, extended
  #  cohort demeaned = F, T
  #  regressors: 7 variants (by excluding from full regressor matrix)
  #    1: (indiv, yield, weather, program, hd, wealth, hygiene, sp, area) are excluded
  #    2: (         yield, weather, program, hd, wealth, hygiene, sp, area) are excluded
  #    3: (                  weather, program, hd, wealth, hygiene, sp, area) are excluded
  #    4: (                               program, hd, wealth, hygiene, sp, area) are excluded
  #    5: (                                                   wealth, hygiene, sp, area) are excluded
  #    6: (                                                                            sp, area) are excluded
  #    7: (                                                                             NONE ) are excluded.
  #  for each familytype i, demeaninng j, regressor k
  #  regression: 2 {Main, Placebo} * 2 {zE, zS} * 2 {sd=0,1} * 3 {agHH, isource, occup} * 7
  #  = 294 variations for each age cutoff {10, 11, 12}
  # ii: m, p
  # jj: zE, zS
  # j: only nuclear (sd == 1) or include extended (sd == 0)
  # m: agHH def
  # s: age cutoff
  # k: specification
#### flood = 1 if  districtSherpur == 0 & districtTangail == 0 & districtChandpur == 0
#### (district/thana=sherpur/sherpur sadar, tangail/modhupur, chandpur/haziganj)
#### or, flood = 1 if district/thana  barishal/aailjhar,  coxbazar/chokoria, narail/kalia, 
#### nilphamari/nilphamary sadar, nowgaon/mohadebpur.
source("../program/RegressorPieces.R")
main.reorder.JHR = c("^.Inter|^age$|age2|yield|^(any)?prog|rain|^high|^low|Std|",
    "^agHH$|^agHH.yr\\d$|^hdagHH.yr\\d$|",
    "^sex.yr\\d$|^...ed.*y.yr\\d$|hd.?sex.yr\\d$|Sib[FM].yr\\d|",
    "^pcland.y|^pcnlasset.y|water.y|latrine.y|",
    "^sex.*H.*\\d$|hd.ed.*H.*\\d$|sp.ed.*H.*\\d$|hd.?sex.*H.*\\d$|",
    "Sib.*H.*\\d|^pcland.*H.*\\d$|^pcnlasset..*H.*\\d$|water.*H.*\\d$|latrine.*H.*\\d$")
main.reorder.JHR <- paste0(main.reorder.JHR, collapse = "")
mix.reorder <- function(x, y=main.reorder.JHR) 
  paste0(c(y[1], x, y[3], y[4]), collapse = "")
```



Regressors for main. 
```{r Regressors for main, echo = T, results = 'hide'}
#### source("../program/RegressorPieces.R")
regressorsM.old <- 
  c("^\\(Interce", indivagesib2, paste(yield, weather.variables1, sep = "|"), 
  hd2, hygiene2, sp2)
#### zEp.2002: UDOldSibF is all 0, UDOldSibM is all 0 but 2 obs, 
####   so drop them (and interactions).
regressorsM <- 
  # add X1.yr2 and X1.agHH.yr2, then X2.yr2 and X2.agHH.yr2
  #July 16 
  # c("^\\(Interce", indivagesib2, paste(yield, weather.variables1, sep = "|"), 
  #July 29 
  # c("^\\(Interce", indivage2, paste(yield, weather.variables1, "^prog", sep = "|"), 
  #   hygiene2, paste(hdeduonly2, sp2, sib2, sep = "|"), area2)
  c("^\\(Interce", indivage2, 
  # Aug 1 paste(hdeduonly2, sp2, sep = "|"), 
  # corr of hd.edulevel.primary.yr2 and hd.edulevel.primary.agHH.yr2 are .80
  # corr of sp.edulevel.primary.yr2 and sp.edulevel.primary.agHH.yr2 are .84
  # So drop these triple interactions of the above. 
    paste(hdedunoagHH2, spedunoagHH2, sep = "|"),
    paste(yield, weather.variables1, "^prog", sep = "|"), 
    hygiene2, sib2, area2)
    #paste(sib2, area2, sep = "|"))
  #hd2, hygiene2, area2)
regressorsM.new <- 
  # add X.yr2, then X.agHH.yr2
  c("^\\(Interce", indivagesibyr2, paste(yield, weather.variables1, sep = "|"), 
  paste(hdyr2, hygieneyr2, sep = "|"), 
  paste(indivagesib2, hd2, hygiene2, sep = "|"), area2)
ShowCovariates <- function(x, y, startfrom = 2) {
paste(unlist(
  lapply(
    lapply(startfrom:length(x), function(i) 
      paste0(i, ". (", paste(grepout(x[i], y), collapse = ", "), ")"))
    , function(z) c(z, "   <br><br>"))
  ), collapse = " ")
}
```

Regressors for placebo testing. \gobblepars 
```{r Regressors for placebo testing}
#### zEp.2002: UDOldSibF is all 0, UDOldSibM is all 0 but 2 obs, 
####   so drop them (and interactions).
regressorsM2002 <- c("^\\(Interce", indivagesib3, paste(yield, weather.variables1, sep = "|"),
####  hd3, hygiene3, area3)
  paste(hd3, sp3, sep = "|"), hygiene3, area3)
regressorsM2002 <-   c("^\\(Interce", indivage3, 
  paste(hdedunoagHH3, spedunoagHH3, sep = "|"),
  paste(yield, weather.variables1, "^prog", sep = "|"), 
  hygiene3, sib3, area3)
```
</details>


Specifications:  

1. Simple DID  
1. $+$ program, time variant controls, thana specific trends  
1. $+$ heterogenous impacts propagated through household or individual level time-invariant controls  

<details><summary>Click here to see the R script for components of regressor preparation. R</summary>
```{r regressor pieces 2, echo = T, file = "../program/RegressorPieces.R"}
```
</details>


<details><summary>Click here to see the R script for regressor preparation.</summary>
Regressors for main. 
```{r reordering for main 2024, echo = T, results = 'hide'}
main.reorder.2024 = c("^.Inter|^age$|age2|yield|[pP]rog|rain|^high|^low|Std|",
    "^agHH$|^agHH.yr\\d$|^hdagHH.yr\\d$|",
    "^sex.yr\\d$|^...ed.*y.yr\\d$|hd.?sex.yr\\d$|Sib[FM].yr\\d|",
    "^pcland.y|^pcnlasset.y|water.y|latrine.y|",
    "^sex.*H.*\\d$|hd.ed.*H.*\\d$|sp.ed.*H.*\\d$|hd.?sex.*H.*\\d$|",
    "Sib.*H.*\\d|^pcland.*H.*\\d$|^pcnlasset..*H.*\\d$|water.*H.*\\d$|latrine.*H.*\\d$")
main.reorder.2024 <- paste0(main.reorder.2024, collapse = "")
ZEm.1999 <- qread("../save/zEm1999.qs")
zEm.1999[, FFWProgram := as.integer(grepl("FFW", anyprog))]
zEm.1999[, NonFFWProgram := as.integer(!is.na(anyprog) & !grepl("FFW|non-m", anyprog))]
#### source("../program/RegressorPieces.R")
```

Regressors for main 2024 (fewer number of specifications). 
```{r Regressors for main 2024, echo = T, results = 'hide'}
source("../program/RegressorPieces.R")
regressorsM2024Feb29 <- 
  c("^\\(Interce", 
    paste(indivonlyage, yield, weather.variables1, StipendProg, area2, sep = "|"),
    paste(indivNoAgeNoAgHHsib2, hdedunoagHH2, spedunoagHH2, hygieneyr2, sep = "|"),
    paste(indivnoagesib2, hdeduonly2, speduonly2, hygiene2, sep = "|"))
regressorsM2024 <- 
regressorsM2024Feb28 <- 
  c("^\\(Interce", 
    paste(indivonlyage, yield, weather.variables1, StipendProg, area2, sep = "|"),
    paste(indivnoagesib2, hdedunoagHH2, spedunoagHH2, hygiene2, sep = "|"))
regressorsM2024Apr23 <- 
  c("^\\(Interce", 
    #paste(indivonlyage, yield, weather.variables1, StipendProg, area2, sep = "|"),
    paste(indivonlyage, StipendProg, sep = "|"),
    paste(yield, weather.variables1, area2, sep = "|"),
    paste(indivnoagesib2, hdedunoagHH2, spedunoagHH2, hygiene2, sep = "|"))
regressorsM2024Feb23 <- 
  c("^\\(Interce", 
    paste(indivage2, yield, weather.variables1, prog, sep = "|"),
    paste(indivnoagesib2, hdedunoagHH2, spedunoagHH2, hygiene2, sep = "|"),
    area2)
regressorsM2024Apr10 <- 
  c("^\\(Interce", 
    paste(indivonlyage, yield, weather.variables1, OnlyStipendProg, area2, sep = "|"),
    paste(indivnoagesib2, hdedunoagHH2, spedunoagHH2, hygiene2, sep = "|"))
regressorsP2024Feb23 <- 
  c("^\\(Interce", 
    paste(indivonlyage, yield, weather.variables1, StipendProg, sep = "|"),
    paste(indivnoagesib3, hdedunoagHH3, spedunoagHH3, hygiene3, sep = "|"),
    area3)
regressorsP2024 <- 
regressorsP2024Feb24 <- 
  c("^\\(Interce", 
    paste(indivonlyage, yield, weather.variables1, StipendProg, area3, sep = "|"),
    paste(indivnoagesib3, hdedunoagHH3, spedunoagHH3, hygiene3, sep = "|"))
regressorsP2024Apr10 <- 
  c("^\\(Interce", 
    paste(indivonlyage, yield, weather.variables1, OnlyStipendProg, area3, sep = "|"),
    paste(indivnoagesib3, hdedunoagHH3, spedunoagHH3, hygiene3, sep = "|"))
```

Note that `NonStipendProgram` almost ceases to exist in 2002.   

* The value of `NonStipendProgram` becomes 1 to 0 as time passes. This is only true for the recipients (111 for boys, 158 for girls) and will not pose multicollinearity.  
* So we can still use `StipendProgram` and `NonStipendProgram` separately in regressions.  
* This is not the case when we run cross section estimation for days absent later on.  

</details>


Covariates in Specifications 2 and 3 of `regressorsM2024` (for main effects):   

<details><summary>Click here to see covariates.</summary>
`r ShowCovariates(regressorsM2024, colnames(zEm.1999))` 
</details>


Covariates in Specifications 2 and 3 of `regressorsP2024` (for placebo effects of 2002 cohorts):   

<details><summary>Click here to see covariates.</summary>
`r ShowCovariates(regressorsP2024, colnames(zEp.2002))` 
</details>

Same covariates are used for placebo effects of 1999 cohorts. 

<br>

<details><summary>Click here to see the R script for non-muslim regressor preparation.</summary>
Regressors for non-muslim placebo tests. \gobblepars
```{r Regressors for non-muslim placebo tests, echo = T}
regressorsN <- c("^\\(Interce", 
  nonmuslims2, 
  paste(indivagesib2, yieldweather, sep = "|"),
  paste(hd2, sp2, sep = "|"), hygiene2, #sp2, 
  area2)
regressorsN <- c("^\\(Interce", 
  paste(nonmuslims2, indivage2, sep = "|"),
   paste(yield, weather.variables1, "^prog", sep = "|"), 
  hygiene2, paste(hdeduonly2, sp2, sib2, sep = "|"), area2)
regressorsNJHR <- c("^\\(Interce", 
  paste(nonmuslims2, indivage2, sep = "|"), 
  paste(hdedunoagHH2, spedunoagHH2, sep = "|"),
  paste(yield, weather.variables1, "^prog", sep = "|"), 
  hygiene2, sib2, area2)
regressorsN <- 
  c("^\\(Interce", 
    paste(nonmuslims2, indivage2, yield, weather.variables1, StipendProg, area2, sep = "|"),
    paste(indivnoagesib2, hdeduonly2, speduonly2, hygiene2, sep = "|"))
regressorsN2002 <- c("^\\(Interce", 
  paste(nonmuslims3, indivage3, sep = "|"),
  paste(hdedunoagHH3, spedunoagHH3, sep = "|"),
  paste(yield, weather.variables1, "^prog", sep = "|"), 
  hygiene3, sib3, area3)
```
</details>

<details><summary>Click here to see covariates.</summary>
`r ShowCovariates(regressorsN, colnames(zEm.1999))` 
</details>


Flood affected thanas are \gobblepars
```{r flood thana, echo = F}
unique(zEm.1999[flooded>0,.(thana)])
```

If we use `"flooded thana name".yr2` as a covariate for thana fixed effects, flood affected thana (`r unique(zEm.1999[flooded>0, thana])`) observations will be dropped, because they are perfectly collinear with `flooded.yr2`. So we will not be able to use `"thana names".yr2` thana fixed effects in flood regressions. This also means that flood regression results are different from main results on the fact that they control for `flooded.agHH.yr2` while the main results do not, and thana fixed trends are grouped as flooded.yr2 for flooded thanas (and unflooed thana's thana fixed trends are subsumed in the intercept). This is a limitation but the specification is sufficient to verify if flood is correlated with main impact estimates. \gobblepars

<details><summary>Click here to see the R script for flood regressor preparation.</summary>

```{r Regressors for flood, echo = T}
#### area2 specification is dropped because of flooded dummy.
regressorsF <- c("^\\(Interce", 
  paste(indivyieldweather2, flood2, sep = "|"),
  flood2.int,
  paste(hd2, sp2, sep = "|"), hygiene2, area2)
  #sp2)
regressorsNF <- c("^\\(Interce", 
  paste(indivyieldweather2, nonflood2, sep = "|"),
  nonflood2.int,
  paste(hd2, sp2, sep = "|"), hygiene2, area2)
  #sp2)
regressorsNF <- c("^\\(Interce", 
   paste(nonflood2, nonflood2.int, indivage2, sep = "|"), 
   paste(hdedunoagHH2, spedunoagHH2, sep = "|"),
   paste(yield, weather.variables1, "^prog", sep = "|"), 
   hygiene2, sib2, area2)
regressorsNF2002 <- c("^\\(Interce", 
   paste(nonflood3, nonflood3.int, indivage3, sep = "|"), 
   paste(hdedunoagHH3, spedunoagHH3, sep = "|"),
   paste(yield, weather.variables1, "^prog", sep = "|"), 
   hygiene3, sib3, area3)
regressorsFJHR <- c("^\\(Interce", 
   paste(flood2, flood2.int, indivage2, sep = "|"), 
   paste(hdedunoagHH2, spedunoagHH2, sep = "|"),
   paste(yield, weather.variables1, "^prog", sep = "|"), 
   hygiene2, sib2, area2)
regressorsF <- c("^\\(Interce", 
    paste(flood2, flood2.int, indivonlyage, yield, weather.variables1, StipendProg, area2, sep = "|"),
    paste(indivnoagesib2, hdedunoagHH2, spedunoagHH2, hygiene2, sep = "|"))
regressorsF2002 <- c("^\\(Interce", 
   paste(flood3, flood3.int, indivage3, sep = "|"), 
   paste(hdedunoagHH3, spedunoagHH3, sep = "|"),
   paste(yield, weather.variables1, "^prog", sep = "|"), 
   hygiene3, sib3, area3)
```
</details>

Regressors for flood.  

<details><summary>Click here to see covariates.</summary>
`r ShowCovariates(regressorsF, colnames(zEm.1999))` 
</details>

Regressors for number of grades. \gobblepars

<details><summary>Click here to see the R script for grade progression regressor preparation.</summary>
```{r Regressors for NumGrades, echo = T, results = 'hide'}
regressorsNumGrades <- 
  c("^\\(Interce", indivnoagesib2, 
  paste(yield, weather.variables1, sep = "|"), 
  paste(hd2, sp2, sep = "|"), hygiene2, #sp2, 
  area2)
  #"^age2$")
regressorsNumGrades <- 
  c("^\\(Interce", indivage2, 
    paste(hdedunoagHH2, spedunoagHH2, sep = "|"),
    paste(yield, weather.variables1, "^prog", sep = "|"), 
    hygiene2, sib2, area2)
regressorsNumGrades <- 
  c("^\\(Interce", 
    paste(indivonlyage, yield, weather.variables1, StipendProg, area2, sep = "|"),
    paste(indivnoagesib2, hdedunoagHH2, spedunoagHH2, hygiene2, sep = "|"))
regressorsNumGrades2002 <- 
  c("^\\(Interce", indivage3, 
    paste(hdedunoagHH3, spedunoagHH3, sep = "|"),
    paste(yield, weather.variables1, "^prog", sep = "|"), 
    hygiene3, sib3, area3)
```
</details>

<details><summary>Click here to see covariates.</summary>
`r ShowCovariates(regressorsNumGrades, colnames(zEm.1999))`  
</details>

Regressors for number of days absent are just the same as main. \gobblepars


# Estimation

## Estimating equation

Baseline model: $D_{I}=1$ if agricultural household, $r_{2002}=1$ in year 2002. We expect exam preponement in 1999 had an uplifting impact on children of agricultural households, and after its effect is gone, there will be a steeper drop in enrollment than children of non-agricultural households, implying $b<0$:
\begin{equation*}
y_{it}=a_{0}+a_{1}D_{i}+a_{2}r_{2002}+bD_{i}r_{2002}+\bfbeta'\bfx_{it}+a_{i}+e_{it}.
\end{equation*}
We do not know if all of the uplifting effect will be dicipated. If it is a fraction $\alpha\in(0, 1)$ that is dicipated, the true impact of the uplifiting effect is $\left|\frac{b}{1-\alpha}\right|$, so we are potentially underestimating the impacts.  

We take a first-difference $t-(t-1)$ to get^[A programming note. If taking a first-difference in the conventional way, `diff` function takes $t-(t-1)$ differences. If we set `opposite.time.order==F`, then `diff` function gives $t-(t-1)$ differences. If a child drops out, then `LHS` changes from 1 to 0, and a $t-(t-1)$ difference gives $-1$. If the child is from an agricultural household, then `agHH.yr2` (agHH==1 \& 2002==1) changes from 0 to 1, so the $t-(t-1)$ difference gives $1$. OLS of $\Delta$`LHS` on $\Delta$`agHH.yr2` gives a negative estimate under the maintained hypothesis ``agricultural households experienced a larger drop in enrollment rates.'']
\begin{equation*}
\Delta y_{it}=a_{2}+bD_{i}+\bfbeta'\Delta\bfx_{it}+\Delta e_{it}.
\end{equation*}

## Main and placebo estimation

Results are stored in a list of following layers: [[ii]][[jj]][[dd]][[j]][[ge]][[m]][[s]][[k]]  

ii: main, placebo  
jj: zE, zS samples  
dd: demeaned, undemeaned  
j: only nuclear (sd == 1) or include extended (sd == 0)  
ge: boys, girls, boys+girls  
m: agHH def  
s: age cutoff  
k: specification  

Estimation steps:  

1. Use `DID1` to try all specifications and pick the data matrix with all non-NA covariates. We retrieve the first-differenced estimation data. This data is the estimation data to be used for the all specifications so we get the same number of observations for all specifications.   
1. Use `DID2` with the first-differenced estimation data.  

Placebo estimation tests a non-existing 2002-2006 shock on the outcomes. To align with the main estimation, we primarily rely on 2002 cohort of 10-18 years old in 2002. In addition, we also use 1999 cohort of 13-21 years old in 2002. Both cohorts show similar results, as there is a significant sample overlap between them.  

## Standard errors

We need to cluster the standard errors to account for unobservable correlations within a cluster.  Following the conventional wisdom, we cluster at the highest level of cluster sampling [@AbadieAtheyImbensWooldridge2022], which is Thana in our data.  

For inference of linear hypotheses, we use <span style='color:blue; font-size:100%; font-weight:600'> [glht](https://search.r-project.org/CRAN/refmans/multcomp/html/glht.html)  </span> of <Blue><a href='https://cran.r-project.org/web/packages/multcomp/index.html'>multcomp package</a></Blue>.  


<details><summary>Click here to see the R script of main and placebo estimation.</summary>
```{r read 2024 main and JHR main results, eval = T, warning = F}
####Res <- qread("../save/TabulatedAllResults.qs")
####re <- Res[grepl("Em", data) & grepl("dir", HHtype) & grepl("main", coeff)
####   & grepl("B", inference) & grepl(0, agdef) & agelb == 10, ]
####re[, yintercept := 0]
####re[, spec := factor(reg, labels = 1:4)]
#### results <- qread("save/DID2024_MainResults.qs")
results <- qread("../save/DID2024_MainResults.qs")
#### resultsJHR <- qread(paste0(pathsave0, "FD_MainCRCoV_results.qs"))
```
```{r Show results for main 10 - 18 nuclear, eval = F, cache = FALSE}
ii <- jj <-  m <- s <- 1
j <- clnum <- 2 ## extended HH, Satterthwaite
ge <- 3  # boys+girls
####    [[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]][[k]]
cis <- lapply(results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci")
cis <- lapply(cis, function(x) x[grepl("^agHH|Prog", x[, "Coef"]), ])
cis <- lapply(cis, data.table)
cis <- lapply(1:length(cis), function(i) cis[[i]][, spec := i])
cis <- rbindlist(cis)
numcols <- colnames(cis)[!grepl("Coef", colnames(cis))]
cis[, (numcols) := lapply(.SD, round, 4), .SDcols = numcols]
#### JHR results have a 1=demeaned/2=undemeaned layer
de <- 1
cisj <- lapply(resultsJHR[[ii]][[de]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci")
cisj <- lapply(cisj, function(x) x[grepl("^agHH|prog", x[, "Coef"]), ])
cisj <- lapply(cisj, data.table)
cisj <- lapply(1:length(cisj), function(i) cisj[[i]][, spec := i])
cisj <- rbindlist(cisj)
numcols <- colnames(cisj)[!grepl("Coef", colnames(cisj))]
cisj[, (numcols) := lapply(.SD, round, 4), .SDcols = numcols]
cat("Previous and new estimates\n")
cis[, ver := "new"]
cisj[, ver := "previous"]
prevcovariates <- rownames(resultsJHR[[ii]][[de]][[jj]][[s]][[j]][[ge]][[m]][[clnum]][[7]]$est)
currcovariates <- rownames(results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]][[3]]$est)
CovariatesCommon <- intersect(prevcovariates, currcovariates)
CovariatesOnlyInPrev <- prevcovariates[!prevcovariates %in% currcovariates]
CovariatesOnlyInCurr <- currcovariates[!currcovariates %in% prevcovariates]
```
</details>

<details><summary>Click here to see the R script of main and placebo estimation.</summary>
```{r main and placebo gender BRL 2024, file = "../program/Estimation_MainPlacebo.R", eval = F, echo = T, results = 'hide', warning = F, cache = F}
```
</details>

<!-- Results of 10 - 18, nuclear, boys and girls. Compare with previous results. Previous results also include sex&#42;agHH&#42;yr in specifications 2 to 7. So specification 1 for both estimation and new, spec 4 and previous spec 7 are comparable. -->

```{r find the difference in JHR and current estimation data, echo = F, eval = F}
ii <- jj <-  m <- s <- de <- 1
j <- clnum <- 2; ge <- 3
d1 <- resultsJHR[[ii]][[1]][[jj]][[s]][[j]][[ge]][[m]][[clnum]][[7]]$level.data[, 
  .(uniquid, survey, anyprog, program)]
d2 <- results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]][[3]]$level.data[, 
  .(uniquid, survey, anyprog, FFWProgram, NonFFWProgram)]
all(d1[, anyprog] == d2[, anyprog])
d1[, program2 := d2[, FFWProgram+NonFFWProgram]] 
#### 2 HHs with program == 0 & program2 == 1
#### They are members of BRAC and Grameen Bank. 
d1[program != program2, ]
d2[uniquid %in% d1[program != program2, uniquid] & survey == 2002, ]
zEm.1999[uniquid %in% d1[program != program2, uniquid] & survey == 2002, 
  .(anyprog, program, FFWProgram, NonFFWProgram)]
#### In JHR, program := grepl(“FF|stipe|RRMP|VGD”, anyprog)
#### Currently, BRAC and Grameen Bank => nonFFWProgram := 1
####   FFWProgram := grepl("FFW", anyprog)
####   NonFFWProgram := !is.na(anyprog) & !grepl("FFW|non-m", anyprog)
#### To mimic JHR data, BRAC and Grameen Bank => nonFFWProgram := 0, or 
####   NonFFWProgram := !is.na(anyprog) & !grepl("FFW|non-m|BRA|Gram", anyprog)
```
```{r current and JHR results 1018 nuclear all, echo = F, eval = F}
 rbindlist(list(cisj, cis))
```
<!-- Results of 10 - 18, nuclear, boys.  -->
```{r Show results for main 10 - 18 nuclear boys, echo = F, eval = F}
ii <- jj <-  m <- s <- 1
j <- clnum <- 2 ## extended HH, Satterthwaite
ge <- 3  # boys+girls
ge <- grep("ys$", genderitems)
cis <- lapply(results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci")
cis <- lapply(cis, function(x) x[grepl("^agHH|Prog", x[, "Coef"]), ])
cis <- lapply(cis, data.table)
cis <- lapply(1:length(cis), function(i) cis[[i]][, spec := i])
cis <- rbindlist(cis)
numcols <- colnames(cis)[!grepl("Coef", colnames(cis))]
cis[, (numcols) := lapply(.SD, round, 4), .SDcols = numcols]
de <- 1
cisj <- lapply(resultsJHR[[ii]][[de]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci")
cisj <- lapply(cisj, function(x) x[grepl("^agHH|prog", x[, "Coef"]), ])
cisj <- lapply(cisj, data.table)
cisj <- lapply(1:length(cisj), function(i) cisj[[i]][, spec := i])
cisj <- rbindlist(cisj)
numcols <- colnames(cisj)[!grepl("Coef", colnames(cisj))]
cisj[, (numcols) := lapply(.SD, round, 4), .SDcols = numcols]
cat("Previous and new estimates\n")
cis[, ver := "new"]
cisj[, ver := "previous"]
rbindlist(list(cisj, cis))
```
<!-- Results of 10 - 18, nuclear, girls.  -->
```{r Show results for main 10 - 18 nuclear girls, echo = F, eval = F}
ii <- jj <-  m <- s <- 1
j <- clnum <- 2 ## extended HH, Satterthwaite
ge <- 3  # boys+girls
ge <- grep("^girls$", genderitems)
cis <- lapply(results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci")
cis <- lapply(cis, function(x) x[grepl("^agHH|Prog", x[, "Coef"]), ])
cis <- lapply(cis, data.table)
cis <- lapply(1:length(cis), function(i) cis[[i]][, spec := i])
cis <- rbindlist(cis)
numcols <- colnames(cis)[!grepl("Coef", colnames(cis))]
cis[, (numcols) := lapply(.SD, round, 4), .SDcols = numcols]
de <- 1
cisj <- lapply(resultsJHR[[ii]][[1]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci")
cisj <- lapply(cisj, function(x) x[grepl("^agHH|prog", x[, "Coef"]), ])
cisj <- lapply(cisj, data.table)
cisj <- lapply(1:length(cisj), function(i) cisj[[i]][, spec := i])
cisj <- rbindlist(cisj)
numcols <- colnames(cisj)[!grepl("Coef", colnames(cisj))]
cisj[, (numcols) := lapply(.SD, round, 4), .SDcols = numcols]
cat("Previous and new estimates\n")
cis[, ver := "new"]
cisj[, ver := "previous"]
rbindlist(list(cisj, cis))
```

```{r JHR select results for MainByGenderByAgeLB for agHH0, echo = F, eval = F}
#### These files are compiled for JHR submission.
Res <- qread("../save/TabulatedAllResults.qs")
Enr <- qread("../save/TabulatedAllResultsEnr.qs")
NR <- qread("../save/TabulatedAllResultsNR.qs")
Resj <- qread(paste0(pathsave0, "TabulatedAllResults.qs"))
Enrj <- qread(paste0(pathsave0, "TabulatedAllResultsEnr.qs"))
NRj <- qread(paste0(pathsave0, "TabulatedAllResultsNR.qs"))
ii <- 1
for (rrr in c("", "j")) {
  Res0 <- get(paste0("Res", rrr))
  Enr0 <- get(paste0("Enr", rrr))
  NR0 <- get(paste0("NR", rrr))
  mr0 <- Res0[grepl(agyr, Coef) & grepl("Em.1", data) & grepl(0, agdef)
    & grepl("dir", HHtype)
    # & grepl("4|6|7", reg)
    , 
    .(Coef, data, agdef, agelb, gender, reg, demean, HHtype, inference, beta, p, ci)][
    order(data, reg, HHtype, agdef, inference)]
  mr0[, ci := paste0("[", 
    formatC(CI_L, digits = 2, format = "f"), ", ", 
    formatC(CI_U, digits = 2, format = "f"), "]")]
  mr0[grepl("^L", inference), ci := paste0("(", 
    formatC(CI_L, digits = 2, format = "f"), ", ", 
    formatC(CI_U, digits = 2, format = "f"), ")")]
  agyr <- paste0("^agHH.yr|Sib.*H.*", (2:3)[ii], "$")
  mr0[, Estimate := formatC(beta, digits = 4, format = "f")]
  if (AddStar) {
    mr0[, est := Estimate]
    mr0[, Estimate := paste0(est, "^{\\phantom{***}}")]
    mr0[p < .1, Estimate := paste0(est, "^{*\\phantom{**}}")]
    mr0[p < .05, Estimate := paste0(est, "^{**\\phantom{*}}")]
    mr0[p < .01, Estimate := paste0(est, "^{***}")]
    mr0[est > 0, Estimate := paste0("\\phantom{-}", Estimate)]
    mr0[, est := NULL]
  }
  mr0[, inference := factor(inference, levels = c("LZ", "BRL", "WCB")[1:2])]
  options(width=120)
  nR <- NR[grepl(0, agdef) & grepl("m", data) & grepl("4|6|7", reg)
    & grepl("^di", HHtype) & grepl("B", inference), ]
  enr0 <- Enr[grepl(aghh.defs[m], agdef) & grepl("m", data)
    & grepl("^di", HHtype) & grepl("B", inference), ]
  enr0[, EnRate := formatC(EnRate, digits = 4, format = "f")]
  for (s in 1:3) {
    # tabulate by specification
    mr1 <- mr0[agelb == (10:12)[s], ]
    nR1 <- nR[agelb == (10:12)[s], ]
    enr1 <- enr0[agelb == (10:12)[s], ]
    main <- rbind(
      mr1[grepl("^ag", Coef) & grepl("^B", inference), Estimate]
      ,
      unlist(mr1[grepl("^ag", Coef) & grepl("Z", inference), ci])
      ,
      unlist(mr1[grepl("^ag", Coef) & grepl("B", inference), ci])
    )
    sib <-  rbind(
       mr1[grepl("SibF.*H.*yr", Coef) & grepl("BR", inference), Estimate]
       , 
       mr1[grepl("SibF.*H.*yr", Coef) & grepl("Z", inference), ci]
       ,
       mr1[grepl("SibF.*H.*yr", Coef) & grepl("B", inference), ci]
       ,
       mr1[grepl("SibM.*H.*yr", Coef) & grepl("BR", inference), Estimate]
       , 
       mr1[grepl("SibM.*H.*yr", Coef) & grepl("Z", inference), ci]
       ,
       mr1[grepl("SibM.*H.*yr", Coef) & grepl("B", inference), ci]
     )
     sib <- cbind("", sib[, 1:2], "", sib[, 3:4], "", sib[, 5:6])
     nr <- rbind(
        formatC(nR1[order(reg, gender), R], digits = 4, format = "f")
      , formatC(nR1[order(reg, gender), Yes], digits = 0, format = "f")
      , formatC(nR1[order(reg, gender), n], digits = 0, format = "f")
     )
     enr <- matrix(
       enr1[order(gender, agHH, tee), EnRate]
       , byrow = F, nrow = 4)
     enr <- enr[, rep(1:3, 3)]
     main <- rbind(main, sib, nr, enr)
     assign(paste0("main", s), main)
  }
  # ii = 1: 3 specs * 2 HHtypes = spec 1 all, spec 1 direct off, spec 2 all, ...
  mrtab <- rbind(main1, main2, main3)
  mrtab <- 
    cbind(
        rep(c(
          "Agricultural household * year 2002", 
          "\\hspace{1em} CI (LZ)", "\\hspace{1em} CI (BRL)", 
          "\\underline{\\phantom{mm}} * Older sisters",
          "\\hspace{1em} CI (LZ)", "\\hspace{1em} CI (BRL)", 
          "\\underline{\\phantom{mm}} * Older brothers",
          "\\hspace{1em} CI (LZ)", "\\hspace{1em} CI (BRL)", 
          "$\\bar{R}^{2}$", "N: Agricultural HHs", "N",
          paste0("Mean of ", rep(c("treated", "control"), each = 2), " in ", 
            list(rep(c(1999, 2002), 2), rep(c(2002, 2006), 2))[[1]])
           ), 3
        ), 
     mrtab)
  if (ncol(main)==9) SepCols <- c(3, 6) else SepCols <- c(2, 4) 
  ltb <- latextab(mrtab, delimiterline = NULL, 
      hcenter = c(3, rep(1.3, ncol(mrtab)-1)),
      hleft = c("\\scriptsize", rep("\\hfil\\scriptsize$", ncol(mrtab)-1)), 
      hright = c("\\hfill", rep("$", ncol(mrtab)-1)),
      headercolor = NULL, 
      adjustlineskip = "-.5ex", adjlskiprows = grep("CI", mrtab[, 1])-1,
      addseparatingcols = SepCols, separatingcolwidth = rep(.1, 2), 
      separatingcoltitle = c("\\textsf{Specification 1}", "\\textsf{Specification 2}", "\\textsf{Specification 3}")
    ) 
  ltb <- c(
    ltb[1], "\\hline", 
    ltb[2:grep("cline", ltb), ],
    paste0(
      "&\\textsf{Boys} & \\textsf{Girls} & \\textsf{Boys+Girls}",
      paste(rep("&&\\textsf{Boys} & \\textsf{Girls} & \\textsf{Boys+Girls}", 2), collapse = "")
      , "\\\\"),
    "&\\multicolumn{11}{c}{A. 10 - 18}\\\\",
    paste("&",
      gsub("3\\)", "3)&", gsub("6\\)", "6)&", paste(paste0("(", 1:9, ")", collapse = "&"), "\\\\")))
      ),
    ltb[(grep("cline", ltb)+2):(grep("M.*rol in 2", ltb)[1]), ]
    , 
    "&\\multicolumn{11}{c}{B. 11 - 18}\\\\",
    paste("&",
      gsub("2\\)", "2)&", gsub("5\\)", "5)&", paste(paste0("(", 1:9+9, ")", collapse = "&"), "\\\\")))
      ),
    ltb[(grep("^Ag", ltb)[2]):(grep("M.*rol in 2", ltb)[2]), ],
    "&\\multicolumn{11}{c}{C. 12 - 18}\\\\",
    paste("&",
      gsub("1\\)", "1)&", gsub("4\\)", "4)&", paste(paste0("(", 1:9+18, ")", collapse = "&"), "\\\\")))
      ),
    ltb[(grep("^Ag", ltb)[3]):(grep("M.*rol in 2", ltb)[3]), ], 
    "\\hline",
      ltb[nrow(ltb), ]
    ) 
  ltb <- gsub("CI \\(.*?\\)", "", ltb)
  ltb <- gsub("(^\\\\cline.*$)", "\\1[-1ex]", ltb)
  ltb <- gsub("household", "HH", ltb)
  ltb <- gsub("Number of ol", "Ol", ltb)
  ltb <- ltb[!grepl("Raw", ltb)]
####  write.tablev(ltb
####    ,  paste0(pathsaveThisVer, "MainByGenderByAgeLBAgHH0Results.tex")
####    ,  colnamestrue = F)
}
```

## Age group wise

<details><summary>Click here to see the R script of agewise estimation.</summary>
```{r agewise subsample by gender, file = "../program/Estimation_Agewise.R", echo = T, eval = F, results = 'hide', message = F, warning = F, cache = F}
```
</details>

<details><summary>Click here to see the code of tabulating results age and gender wise.</summary>
```{r tabulate results age gender wise, eval = F}
results <- qread("../save/DID2024_SubsampleAgeGroupGenderResults.qs")
names(results[[1]][[1]])
zsobj <- c("zEm.1999", "zEp.2002", "zEp.1999", "zYp.1999")[-4]
#### results[[ii]][[ge]][[dd]][[m]][[j]][[gg]][[ag]][[cl]][[k]] levels.
#### zsobj <- c("zEm.1999", "zEp.2002", "zEp.1999", "zYp.1999"): ii = 1, 2, 3, 4.
#### ii = data, m = agHHdef, ge = gender, j = HH type, gg = AgeGroup1,  
####  ag = age groups , cl = LiangZeger/satterthwaite
#### age groups
AGEgrouping <- c("agewise", "AgeGroup1", "AgeGroup2", "AgeGroup3")[3:4]
agewise <- as.list(6:18); names(agewise) <- putzeroontop(6:18)
AgeGroup1 <- list(pri=6:10, jsec=11:13, sec=14:15, hsec=16:17, coll=18)
AgeGroup2 <- list(pri=6:10, sec=11:17, coll=18)
AgeGroup3 <- list(young=6:9, junior=10:15, senior=16:18)
names(results[[1]][[ge]][[m]][[j]][[gg]])
Res2 <- NR2 <- Enr2 <- NULL
for (ii in 1:length(zsobj)) {
  thisdata <- zsobj[[ii]]
  for (ge in 1:3) {
      for (m in 1:4) {
        for (j in 1:2) {
          for (gg in 1:length(AGEgrouping)) {
            AGEgroup <- get(AGEgrouping[gg])
            for (ag in 1:length(AGEgroup)) {
              for (clnum in 1:2) {
                estobj <- results[[ii]][[ge]][[m]][[j]][[gg]][[ag]][[clnum]]
                CIs <- lapply(estobj, "[[", "ci")
                if (length(CIs) == 0 || is.null(CIs[[1]])) {
                  cat("Skipped due to no estimation:", 
                    paste0("ii==", zsobj[ii]),
                    paste0("ge==", genderitems[ge]), 
                    paste0("m==", aghh.defs[m]), 
                    paste0("j==", c("all", "direct")[j]), 
                    paste0("gg==", AGEgrouping[gg]), 
                    paste0("ag==", AGEgroup[ag]), "\n")
                  next
                }
                CIs <- lapply(CIs, data.table)
                CIs <- lapply(1:length(CIs), function(i) CIs[[i]][, reg := i])
                CIs <- rbindlist(CIs, use.names = T, fill = T)
                # if clnum == 1, estobj only contains CIs
                if (clnum == 1) {
                  esp <- lapply(estobj, "[[", "est")
                  esp <- lapply(esp, as.matrix)
                  esprn <- unlist(lapply(esp, rownames))
                  esp <- lapply(esp, function(x) as.data.table(x[, ]))
                  dfs <- lapply(lapply(estobj, "[[", "est"), function(x) attributes(x)$df)
                  esp <- lapply(1:length(esp), function(i) esp[[i]][, df := dfs[[i]]])
                  esp <- rbindlist(esp, use.names = T, fill = T)
                  if (any(grepl("z value", colnames(esp)))) esp[, "z value" := NULL]
                  CIs <- cbind(Coef = esprn, esp, CIs)
                  setnames(CIs,  c("Coef", "beta", "SE", "t", "p_val", "df", "CI_L", "CI_U", "reg"))
                  CIs[, t := NULL]
                }
                CIs[, inference := c("LZ", "BRL")[clnum]]
                CIs[, group := names(results[[ii]][[ge]][[m]][[j]][[gg]])[ag]]
                CIs[, agegroup := names(results[[ii]][[ge]][[m]][[j]])[gg]]
                CIs[, agdef := aghh.defs[m]]
                CIs[, HHtype := c("all", "direct", "exonly")[j]]
                CIs[, gender := genderitems[ge]]
                CIs[, data := thisdata]
                CIs[, p_val := round(p_val, 6)]
                CIs[, SE := round(SE, 8)]
                setcolorder(CIs,  c("data", "gender", "agdef", "HHtype", "demean", 
                  "agegroup", "group", "Coef", "beta", "SE", "df", "p_val", "CI_L", "CI_U", "reg", "inference")[-5])
                Res2 <- rbindlist(list(Res2, CIs), use.names = F)
                # n and R2
                nR <- lapply(lapply(estobj, "[[", "reg"), 
                  function(x) t(c(length(summary(x)$res), summary(x)$r.sq)))
                nR <- lapply(nR, data.table)
                nR <- lapply(1:length(nR), function(i) nR[[i]][, spec := i])
                nR <- rbindlist(nR, use.names = T, fill = T)
                nR[, gender := genderitems[ge]]
                setnames(nR, c("n", "R", "spec", "gender"))
                nR[, n := formatC(n, digits = 0, format = "f")]
                nR[, R := formatC(R, digits = 4, format = "f")]
                # number of agHHs
                nR2 <- unique(unlist(lapply(lapply(estobj, "[[", "diff.data"), 
                  function(x) sum(x[, agHH]>0))))
                nR[, Yes := formatC(nR2, digits = 0, format = "f")]
                nR[, inference := c("LZ", "BRL")[clnum]]
                nR[, group := names(results[[ii]][[ge]][[m]][[j]][[gg]])[ag]]
                nR[, agegroup := names(results[[ii]][[ge]][[m]][[j]])[gg]]
                nR[, agdef := aghh.defs[m]]
                nR[, HHtype := c("all", "direct", "exonly")[j]]
                nR[, data := thisdata]
                NR2 <- rbindlist(list(NR2, nR), use.names = F)
                # treated and control means
                zid <- estobj[[1]][["level.data"]]
                zidd <- estobj[[1]][["diff.data"]]
                zid <- zid[uniquid %in% zidd[, uniquid], ]
                zid[eval(parse(text=grepout("agHH$", colnames(x)))) > 0, agHH := 1L]
                zid[eval(parse(text=grepout("agHH$", colnames(x)))) < 0, agHH := 0L]
                zid[, tee := 1:.N, by = uniquid]
                if (any(grepl("Enrolled", colnames(zid)))) setnames(zid, "Enrolled", "schoolp")
                enr <- zid[, .(EnRate = mean(schoolp), Num = .N), by = .(agHH, tee)]
                enr[, inference := c("LZ", "BRL")[clnum]]
                enr[, group := names(results[[ii]][[ge]][[m]][[j]][[gg]])[ag]]
                enr[, agegroup := names(results[[ii]][[ge]][[m]][[j]])[gg]]
                enr[, HHtype := c("all", "direct", "exonly")[j]]
                enr[, agdef := aghh.defs[m]]
                enr[, gender := genderitems[ge]]
                enr[, data := thisdata]
                Enr2 <- rbindlist(list(Enr2, enr), use.names = F)
              } # clnum
            } # ag
          } # gg
        } # j
      } # m
    } # ge
} # ii
setcolorder(Res2, c("data", "gender", "agegroup", "group",  "HHtype", "reg", "agdef",
  grepout("bet|SE|df|CI|^p", colnames(Res2))))
Res2[, agdef := factor(agdef)]
Res2[, gender := factor(gender)]
Res2[, agegroup := factor(agegroup)]
Res2[, reg := factor(reg)]
Res2[, Coef := factor(Coef)]
Res2[, HHtype := factor(HHtype)]
Res2[, inference := factor(inference)]
Res2[, data := factor(data)]
Res2[, gender := factor(gender, levels = genderitems)]
maxageinGroup <- max(as.numeric(as.character(unique(Res2[, group]))), na.rm = T)
Res2[, group := factor(group, levels = c("pri", "sec", "young", "junior", "senior", "coll"))]
Res2[, yintercept := 0]
qsave(Res2, "../save/TabulatedMainResults2.qs")
qsave(Enr2, "../save/TabulatedMainResultsEnr2.qs")
qsave(NR2, "../save/TabulatedMainResultsNR2.qs")
```
</details>
<details><summary>Click here to see the code of tabulating main results.</summary>
```{r tabulate main results, eval = F}
library(qs)
AddStar <- T
results1 <- qread("../save/DID2024_MainResults.qs")
results2 <- qread("../save/DID2024_SubsampleAgeGroupGenderResults.qs")
####results1 <- qread(paste0(pathsaveThisVer, "DID_MainResults.qs"))
####results2 <- qread(paste0(pathsaveThisVer, "DID_SubsampleAgeGroupGenderResults.qs"))
#### results1[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]][[k]]
#### cl: c("LiangZeger", "satterthwaite", "wildclusterboot")
#### at k=4: program is added to covariates
#### ii=2, jj = 1 is zEp.2002, dd = 2 is level interactions
#### results2[[ii]][[ge]][[m]][[j]][[gg]][[ag]][[cl]][[k]]
##### for results1, 
zsobj <- c("zmobj", "zpobj")
zmobj <- c("zEm.1999", "zSm.1999")[1] 
zpobj <- c("zEp.2002", "zSp.2002", "zEp.1999", "zSp.1999", "zYp.1999")[c(1, 3)]
samples <- c("main", "placebo")
z234 <- c("z2", "z3", "z4")
zsobj <- c("zmobj", "zpobj")
zmobj <- c("zEm.1999", "zSm.1999")[1]
zpobj <- c("zEp.2002", "zSp.2002", "zEp.1999", "zSp.1999")[c(1, 3)]
EstGen <- NR <- Enr <- NULL
results <- results1
for (ii in 1:2) {
  zSobj <- get(zsobj[[ii]])
  for (jj in 1:length(zSobj)) {
    thisdata <- zSobj[[jj]]
    for (s in 1:3) {
      for (j in 1:2) {
        for (ge in 1:3) {
          for (m in 1:4) {
            for (clnum in 1:2) {
              # cl: 1: LZ, 2: satterthwaite
              estGen1 <- results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]]
              if (all(unlist(lapply(estGen1, is.null)))) next
              estGen <- lapply(estGen1, "[[", "ci")
              estGen <- lapply(estGen, data.table)
              estGen <- lapply(1:length(estGen), function(i) estGen[[i]][, reg := i])
              estGen <- rbindlist(estGen, use.names = T, fill = T)
              # if clnum == 1, estGen only contain CIs
              if (clnum == 1) {
                esp <- lapply(estGen1, "[[", "est")
                esp <- lapply(esp, as.matrix)
                esprn <- unlist(lapply(esp, rownames))
                esp <- lapply(esp, function(x) as.data.table(x[, ]))
                dfs <- lapply(lapply(estGen1, "[[", "est"), function(x) attributes(x)$df)
                esp <- lapply(1:length(esp), function(i) esp[[i]][, df := dfs[[i]]])
                esp <- rbindlist(esp, use.names = T, fill = T)
                if (any(grepl("z value", colnames(esp)))) esp[, "z value" := NULL]
                estGen <- cbind(Coef = esprn, esp, estGen)
                setnames(estGen,  c("Coef", "beta", "SE", "t", "p_val", "df", "CI_L", "CI_U", "reg"))
                estGen[, t := NULL]
              }
              estGen[, p_val := round(p_val, 6)]
              estGen[, SE := round(SE, 8)]
              estGen[, inference := c("LZ", "BRL")[clnum]]
              estGen[, gender := genderitems[ge]]
              estGen[, agdef := aghh.defs[m]]
              estGen[, agelb := c(10:12)[s]]
              estGen[, HHtype := c("all", "direct", "exonly")[j]]
              estGen[, data := thisdata]
              estGen[, objective := c("main", "placebo")[ii]]
              setcolorder(estGen,  c("objective", "data", "gender", "agdef", "agelb", "HHtype", 
                "demean", "Coef", "beta", "SE", "df", "p_val", "CI_L", "CI_U", "reg", "inference")[-7])
              EstGen <- rbindlist(list(EstGen, estGen), use.names = T, fill = T)
              # n and R2
              nR <- lapply(lapply(estGen1, "[[", "reg"), 
                function(x) t(c(length(summary(x)$res), summary(x)$r.sq)))
              nR <- lapply(nR, data.table)
              nR <- lapply(1:length(nR), function(i) nR[[i]][, spec := i])
              nR <- rbindlist(nR, use.names = T, fill = T)
              nR[, gender := genderitems[ge]]
              setnames(nR, c("n", "R", "spec", "gender"))
              nR[, n := formatC(n, digits = 0, format = "f")]
              nR[, R := formatC(R, digits = 4, format = "f")]
              # number of agHHs
              nR2 <- unique(unlist(lapply(lapply(estGen1, "[[", "diff.data"), 
                function(x) sum(x[, agHH]>0))))
              nR[, Yes := formatC(nR2, digits = 0, format = "f")]
              nR[, agdef := aghh.defs[m]]
              nR[, agelb := c(10:12)[s]]
              nR[, HHtype := c("all", "direct", "exonly")[j]]
              nR[, data := thisdata]
              nR[, objective := c("main", "placebo")[ii]]
              nR[, inference := c("LZ", "BRL")[clnum]]
              NR <- rbind(NR, nR, use.names = T, fill = T)
              # treated and control means
              zid <- lapply(estGen1, "[[", "level.data")
              zidd <- lapply(estGen1, "[[", "diff.data")
              zid <- lapply(1:length(zid), function(i) zid[[i]][uniquid %in% zidd[[i]][, uniquid], ])
              zid <- lapply(zid, function(x) x[eval(parse(text=grepout("agHH$", colnames(x)))) > 0, 
                        agHH := 1L])
              zid <- lapply(zid, function(x) x[eval(parse(text=grepout("agHH$", colnames(x)))) < 0, 
                        agHH := 0L])
              zid <- lapply(zid, function(x) x[, tee := 1:.N, by = uniquid])
              if (any(grepl("Enrolled", colnames(zid[[1]]))))
                lapply(zid, function(x) setnames(x, "Enrolled", "schoolp"))
              enr <- lapply(zid, function(x) x[, .(EnRate = mean(schoolp), Num = .N), by = .(agHH, tee)])
              enr <- lapply(1:length(enr), function(i) enr[[i]][, spec := i])
              enr <- rbindlist(enr, use.names = T, fill = T)
              enr[, gender := genderitems[ge]]
              enr[, agdef := aghh.defs[m]]
              enr <- unique(enr[, spec := NULL])
              enr[, agelb := c(10:12)[s]]
              enr[, HHtype := c("all", "direct", "exonly")[j]]
              enr[, data := thisdata]
              enr[, objective := c("main", "placebo")[ii]]
              enr[, inference := c("LZ", "BRL")[clnum]]
              Enr <- rbind(Enr, enr, use.names = T, fill = T)
            } # clnum
          } # m
        } # ge
      } # j
    } # s
  } # jj
} # ii
####EstGen[grepl("m", objective) & grepl("Em", data) & grepl("b.*g", gender) & agelb == 10 & 
####  HHtype == "all" & grepl("^agHH.yr2$", Coef) & reg == 3 & grepl("B", inference), ]
setnames(EstGen, "p_val", "p")
EstGen[, coeff := as.character(NA)]
EstGen[grepl("^agHH.yr.$", Coef), coeff := "main"]
EstGen[grepl("SibF.*H", Coef), coeff := "older female siblings"]
EstGen[grepl("SibM.*H", Coef), coeff := "older male siblings"]
EstGen[, coeff := factor(coeff)]
EstGen[, Coef := factor(Coef)]
EstGen[, inference := factor(inference)]
EstGen[, objective := factor(objective)]
EstGen[, data := factor(data)]
EstGen[, agdef := factor(agdef)]
EstGen[, gender := factor(gender, levels = genderitems[c(3, 1, 2)])]
Enr[, gender := factor(gender, levels = genderitems[c(3, 1, 2)])]
NR[, gender := factor(gender, levels = genderitems[c(3, 1, 2)])]
#EstGen[, gender := factor(gender, levels = c("boys+girls", "boys", "girls"))]
EstGen[, HHtype := factor(HHtype)]
qsave(EstGen, "../save/TabulatedMainResults1.qs")
qsave(Enr, "../save/TabulatedMainResultsEnr1.qs")
qsave(NR, "../save/TabulatedMainResultsNR1.qs")
```
```{r rbind tabulated main and agewise results, eval = F}
Res1 <- qread("../save/TabulatedMainResults1.qs")
Enr1 <- qread("../save/TabulatedMainResultsEnr1.qs")
NR1 <- qread("../save/TabulatedMainResultsNR1.qs")
Res2 <- qread("../save/TabulatedMainResults2.qs")
Enr2 <- qread("../save/TabulatedMainResultsEnr2.qs")
NR2 <- qread("../save/TabulatedMainResultsNR2.qs")
Res <- rbindlist(list(Res1, Res2), use.names = T, fill = T)
Res[, gender := factor(gender, levels = genderitems[c(3, 1, 2)])]
Res[, agdef := factor(agdef, levels = aghh.defs)]
Res[, reg := as.integer(unlist(reg))]
setnames(Res, "stat", "SattDoF", skip_absent = T)
Res[grepl("F.*H", Coef), coeff := "older female siblings"]
Res[grepl("M.*H", Coef), coeff := "older male siblings"]
Enr <- rbindlist(list(Enr1, Enr2), use.names = T, fill = T)
NR <- rbindlist(list(NR1, NR2), use.names = T, fill = T)
NR[, objective := factor(objective)]
NR[, data := factor(data)]
NR[, agdef := factor(agdef, levels = aghh.defs)]
NR[, gender := factor(gender, levels = genderitems[c(3, 1, 2)])]
NR[, HHtype := factor(HHtype)]
NR[, inference := factor(inference)]
NR[, group := factor(group)]
NR[, agegroup := factor(agegroup)]
setnames(NR, "spec", "reg")
Enr[, objective := factor(objective)]
Enr[, data := factor(data)]
Enr[, agdef := factor(agdef, levels = aghh.defs)]
Enr[, gender := factor(gender, levels = genderitems[c(3, 1, 2)])]
Enr[, HHtype := factor(HHtype)]
Enr[, inference := factor(inference)]
Enr[, group := factor(group)]
Enr[, agegroup := factor(agegroup)]
qsave(Res, "../save/TabulatedAllResults.qs")
qsave(Enr, "../save/TabulatedAllResultsEnr.qs")
qsave(NR, "../save/TabulatedAllResultsNR.qs")
```
</details>

<!--
* For a summary table with est [LZ ci] [Satterthwaite CI]: Use TabulatedMainResults.qs (tabulated results) where "inference" column gives LZ and Satterthwaite information. Construct a table by stacking up est, LZ-CI, LZ-Satterthwaite.  
* For a show-all-results table only with one statistic line per estimate (est, se; est, p; est, ci), use results in a list (DID2024_MainResults.qs) and construct a table.  
-->


## Non-Muslims, flood

<details><summary>Click here to see the R script of non-Muslim estimation.</summary>
```{r non muslim gender, file = "../program/Estimation_NonMuslim.R", echo = T, eval = F, results = 'hide', cache = F, warning = F}
```
</details>


<details><summary>Click here to see the R script of flood estimation.</summary>
Flooded area is defined at thana level. These are \Sexpr{thanas[!grepl("Aailjhar|Chokoria|Kalia|Nilphamary|Mohadebpur", thanas)]}. 
```{r flooded gender, file = "../program/Estimation_Flooded.R", echo = T, eval = F, results = 'hide', message = F, warning = F}
```
</details>

<details><summary>Click here to see the code of tabulating flood nonmuslim results.</summary>
```{r tabulate flooded nonmuslim results, eval = F}
#### Flooded: results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]][[k]]
resultsF <- qread("../save/DID2024_FloodGenderResults.qs")
#### Nonmuslims: results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]][[k]]
resultsM <- qread("../save/DID2024_NonMuslimGenderResults.qs")
zsobj <- c("zmobj", "zpobj")
zmobj <- "zEm.1999"
zpobj <- c("zEp.2002", "zEp.1999")
EstFM <- NR <- Enr <- NULL
for (fm in 1:2) {   # flood or muslim
  for (ii in 1) { # main results only
    zSobj <- get(zsobj[[ii]])
    for (jj in 1:length(zSobj)) {
      thisdata <- zSobj[[jj]]
      for (s in 1:3) {
        for (j in 1:2) {
          for (ge in 1:3) {
            for (m in 1:4) {
              for (clnum in 1:2) {
                if (fm == 1)  {
                  estFM1 <- resultsF[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]]
                } else {
                  estFM1 <- resultsM[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]]
                }
                if (all(unlist(lapply(estFM1, is.null)))) next
                estFM <- lapply(estFM1, "[[", "ci")
                estFM <- lapply(estFM, data.table)
                estFM <- lapply(1:length(estFM), function(i) estFM[[i]][, reg := i])
                estFM <- rbindlist(estFM, use.names = T, fill = T)
                # if clnum == 1, estFM only contain CIs
                if (clnum == 1) {
                  esp <- lapply(estFM1, "[[", "est")
                  esp <- lapply(esp, as.matrix)
                  esprn <- unlist(lapply(esp, rownames))
                  esp <- lapply(esp, function(x) as.data.table(x[, ]))
                  dfs <- lapply(lapply(estFM1, "[[", "est"), function(x) attributes(x)$df)
                  esp <- lapply(1:length(esp), function(i) esp[[i]][, df := dfs[[i]]])
                  esp <- rbindlist(esp, use.names = T, fill = T)
                  if (any(grepl("z value", colnames(esp)))) esp[, "z value" := NULL]
                  estFM <- cbind(Coef = esprn, esp, estFM)
                  setnames(estFM,  c("Coef", "beta", "SE", "t", "p_val", "df", "CI_L", "CI_U", "reg"))
                  estFM[, t := NULL]
                }
                estFM[, p_val := round(p_val, 6)]
                estFM[, SE := round(SE, 8)]
                estFM[, inference := c("LZ", "BRL")[clnum]]
                estFM[, gender := genderitems[ge]]
                estFM[, agdef := aghh.defs[m]]
                estFM[, agelb := c(10:12)[s]]
                estFM[, HHtype := c("all", "direct", "exonly")[j]]
                estFM[, data := thisdata]
                estFM[, objective := c("main", "placebo")[ii]]
                estFM[, file := c("flood", "muslim")[fm]]
                setcolorder(estFM,  c("file", "objective", "data", "gender", "agdef", "agelb", "HHtype", 
                  "demean", "Coef", "beta", "SE", "df", "p_val", "CI_L", "CI_U", "reg", "inference")[-8])
                EstFM <- rbindlist(list(EstFM, estFM), use.names = T, fill = T)
                # n and R2
                nR <- lapply(lapply(estFM1, "[[", "reg"), 
                  function(x) t(c(length(summary(x)$res), summary(x)$r.sq)))
                nR <- lapply(nR, data.table)
                nR <- lapply(1:length(nR), function(i) nR[[i]][, spec := i])
                nR <- rbindlist(nR, use.names = T, fill = T)
                nR[, gender := genderitems[ge]]
                setnames(nR, c("n", "R", "spec", "gender"))
                nR[, n := formatC(n, digits = 0, format = "f")]
                nR[, R := formatC(R, digits = 4, format = "f")]
                # number of agHHs
                nR2 <- unique(unlist(lapply(lapply(estFM1, "[[", "diff.data"), 
                  function(x) sum(x[, agHH]>0))))
                if (fm == 1) 
                  nR3 <- unique(unlist(lapply(lapply(estFM1[-1], "[[", "diff.data"), 
                    function(x) sum(x[, paste0("flooded.yr", ii+1), with = F]>0)))) else
                  nR3 <- unique(unlist(lapply(lapply(estFM1[-1], "[[", "diff.data"), 
                    function(x) sum(x[, paste0("nonmuslim.yr", ii+1), with = F]>0))))
                nR[, Yes := formatC(nR2, digits = 0, format = "f")]
                nR[, Ngroup := formatC(nR3, digits = 0, format = "f")]
                nR[, agdef := aghh.defs[m]]
                nR[, agelb := c(10:12)[s]]
                nR[, HHtype := c("all", "direct", "exonly")[j]]
                nR[, data := thisdata]
                nR[, objective := c("main", "placebo")[ii]]
                nR[, file := c("flood", "muslim")[fm]]
                NR <- rbind(NR, nR, use.names = T, fill = T)
                # treated and control means
                zid <- lapply(estFM1, "[[", "level.data")
                zidd <- lapply(estFM1, "[[", "diff.data")
                zid <- lapply(1:length(zid), function(i) zid[[i]][uniquid %in% zidd[[i]][, uniquid], ])
                zid <- lapply(zid, function(x) x[eval(parse(text=grepout("agHH$", colnames(x)))) > 0, 
                          agHH := 1L])
                zid <- lapply(zid, function(x) x[eval(parse(text=grepout("agHH$", colnames(x)))) < 0, 
                          agHH := 0L])
                zid <- lapply(zid, function(x) x[, tee := 1:.N, by = uniquid])
                if (any(grepl("Enrolled", colnames(zid[[1]]))))
                  lapply(zid, function(x) setnames(x, "Enrolled", "schoolp"))
                enr <- lapply(zid, function(x) x[, .(EnRate = mean(schoolp), Num = .N), by = .(agHH, tee)])
                enr <- lapply(1:length(enr), function(i) enr[[i]][, spec := i])
                enr <- rbindlist(enr, use.names = T, fill = T)
                enr[, gender := genderitems[ge]]
                enr[, agdef := aghh.defs[m]]
                enr <- unique(enr[, spec := NULL])
                enr[, agelb := c(10:12)[s]]
                enr[, HHtype := c("all", "direct", "exonly")[j]]
                enr[, data := thisdata]
                enr[, objective := c("main", "placebo")[ii]]
                enr[, inference := c("LZ", "BRL")[clnum]]
                enr[, file := c("flood", "muslim")[fm]]
                Enr <- rbind(Enr, enr, use.names = T, fill = T)
              } # clnum
            } # m
          } # ge
        } # j
      } # s
    } # jj
  } # ii
} # fm
setnames(EstFM, "p_val", "p")
EstFM[, coeff := as.character(NA)]
EstFM[grepl("^agHH.yr.$", Coef), coeff := "main"]
EstFM[grepl("SibF.*H", Coef), coeff := "older female siblings"]
EstFM[grepl("SibM.*H", Coef), coeff := "older male siblings"]
EstFM[, coeff := factor(coeff)]
EstFM[, Coef := factor(Coef)]
EstFM[, inference := factor(inference)]
EstFM[, objective := factor(objective)]
EstFM[, data := factor(data)]
EstFM[, agdef := factor(agdef, levels = aghh.defs)]
EstFM[, gender := factor(gender, levels = genderitems)]
EstFM[, HHtype := factor(HHtype)]
EstFM[, file := factor(file)]
NR[, objective := factor(objective)]
NR[, data := factor(data)]
NR[, agdef := factor(agdef, levels = aghh.defs)]
NR[, gender := factor(gender, levels = genderitems)]
NR[, HHtype := factor(HHtype)]
NR[, file := factor(file)]
Enr[, inference := factor(inference)]
Enr[, objective := factor(objective)]
Enr[, data := factor(data)]
Enr[, agdef := factor(agdef, levels = aghh.defs)]
Enr[, gender := factor(gender, levels = genderitems)]
Enr[, HHtype := factor(HHtype)]
Enr[, file := factor(file)]
qsave(EstFM, "../save/TabulatedFloodMuslimResults2024.qs")
qsave(Enr, "../save/TabulatedFloodMuslimResultsEnr2024.qs")
qsave(NR, "../save/TabulatedFloodMuslimResultsNR2024.qs")
floodftnote <- "A first-difference estimator with standard errors clustered at \\textit{thana} level. Flood dummy variable is interacted with year 2002 dummy and year 2002 * agricultural HH dummy. "
```
</details>




## Other schooling outcomes



<details><summary><a name="EstimationOtherSchoolingOutcomes"> 
Click here to see the R script of grade progression estimation.</a>
</summary>

```{r num grades impacts by enrollers and by gender, file = "../program/Estimation_NumGrades.R", echo = T, eval = F, results = 'hide', warning = F, cache = F}
```
</details>

<details><summary>Click here to see the R script of days absent estimation.</summary>
```{r days absent of enrollers by gender impacts, file = "../program/Estimation_DaysAbsent.R", echo = T, eval = F, results = 'hide', warning = F, cache = F}
```
</details>


<details><summary>Click here to see the R script of days absent cross section estimation.</summary>
```{r days absent of enrollers cross section, file = "../program/Estimation_DaysAbsentCrossSection.R", echo = T, eval = F, results = 'hide', warning = F, cache = F}
```
</details>

<details><summary>Click here to see the code of tabulating grade progression and days absent.</summary>
```{r tabulate grade absent by gender results, warning = F, eval = F}
#### GradeProgression: resultsGG[[ii]][[jj]][[en]][[s]][[j]][[ge]][[m]][[clnum]][[k]], en = 1, 2
#### DaysAbsent:          resultsDE[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]][[k]]
#### inference is not given unique level clnum. Each k spec has ciLZ and ciBRL.
#### DAbs cross section resultsDC[[ii]][[jj]][[yy]][[rr]][[s]][[j]][[ge]][[m]], yy = 1, 2
#### resultsGG <- qread("save/DID2024_NumGradesEnrollersGenderResults.qs")
#### resultsDE <- qread("save/DID2024_DaysAbsentEnrollersGenderResults.qs")
#### resultsDC <- qread("save/DID2024_DaysAbsentCrossSectionResults.qs")
resultsGG <- qread("../save/DID2024_NumGradesEnrollersGenderResults.qs")
resultsDE <- qread("../save/DID2024_DaysAbsentEnrollersGenderResults.qs")
resultsDC <- qread("../save/DID2024_DaysAbsentCrossSectionResults.qs")
#### DE: results0[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]][[k]] with always enrollers (ss==2, complete panel) only

#### en: 1=initial enrollers of GG, 2=always enrollers of GG, 
####      3=always enrollers of DE, 
####      4=current enrollers OLS of DC, 5=always enrollers OLS of DC
zsobj <- c("zmobj", "zpobj")
zmobj <- "zEm.1999"
zpobj <- c("zEp.2002", "zEp.1999")
eGD <- NR <- Enr <- NULL
rylast <- c(1, 1, 1, 2, 2)
for (gd in 1:5) {
  for (ii in 1) {
    if (ii == 2 & gd > 2) next
    zSobj <- get(zsobj[[ii]])
    for (jj in 1:length(zSobj)) {
      thisdata <- zSobj[[jj]]
      for (yy in 1:rylast[gd]) { 
        if (gd < 4 & yy == 2) next
        for (rr in 1:rylast[gd]) { 
        # if gd == 4, do rr = 1, 2 (AtLeastOnce, BothPeriods) else do rr = 1 only
          for (s in 1:3) {
            for (j in 1:2) {
              for (ge in 1:3) {
                for (m in 1:4) {
                  for (clnum in 1:2) {
                    if (gd <= 2) 
                      # 1: grades, sample of initial enrollers (enrolled in 1999)
                      # 2: grades, sample of all time enrollers (enrolled in both periods)
                      estGDs1 <- resultsGG[[ii]][[jj]][[gd]][[s]][[j]][[ge]][[m]][[clnum]] else 
                      if (gd == 3)
                      # 3: days absent, DID, main sample (ii==1), no placebo estimates
                      #    and who enrolled in both 1999 and 2002. (ss == 2)
                      estGDs1 <- resultsDE[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]] else
                      # 4: OLS cross section, only nuclear (j = 2), current enrollers (rr = 1), 
                      #     of year 1999 (yy = 1) and year 2002 (yy = 2)
                      # 5: OLS cross section, only nuclear (j = 2), always enrollers (rr = 2)
                      #     of year 1999 (yy = 1) and year 2002 (yy = 2)
                      estGDs1 <- resultsDC[[ii]][[jj]][[yy]][[rr]][[s]][[j]][[ge]][[m]]
                    if (gd >= 4) {
                        # Days absent OLS is estimated only for nuclear and BRL
                        if (j == 1) next
                        if (clnum == 1) next
                        estGDs <- lapply(estGDs1, "[[", "ciBRL")
                      } else
                      estGDs <- lapply(estGDs1, "[[", "ci")
                    estGDs <- lapply(estGDs, data.table)
                    estGDs <- lapply(1:length(estGDs), function(i) estGDs[[i]][, reg := i])
                    estGDs <- rbindlist(estGDs)
                    # if clnum == 1, estGDs only contains CIs
                    if (clnum == 1) {
                      if (gd < 4)
                        esp <- lapply(estGDs1, "[[", "est") else
                        esp <- lapply(estGDs1, "[[", "estLZ")
                      esp <- lapply(esp, as.matrix)
                      esprn <- unlist(lapply(esp, rownames))
                      esp <- lapply(esp, function(x) as.data.table(x[, ]))
                      dfs <- lapply(lapply(estGDs1, "[[", "est"), function(x) attributes(x)$df)
                      esp <- lapply(1:length(esp), function(i) esp[[i]][, df := dfs[[i]]])
                      esp <- rbindlist(esp, use.names = T, fill = T)
                      if (any(grepl("z value", colnames(esp)))) esp[, "z value" := NULL]
                      estGDs <- cbind(Coef = esprn, esp, estGDs)
                      setnames(estGDs,  c("Coef", "beta", "SE", "t", "p_val", "df", "CI_L", "CI_U", "reg"))
                      estGDs[, t := NULL]
                    }
                    setcolorder(estGDs,  c("Coef", "beta", "SE", "df", "p_val", "CI_L", "CI_U", "reg"))
                    estGD <- estGDs
                    ####estGD[, file := c("grade", "absent", "grade enr", "grade initial enr", "absent enr")[gd]]
                    estGD[, file := gdfiles[gd]]
                    estGD[, CrossSecYear := c(1999, 2002)[yy]]
                    estGD[, CrossSecEnrollers := c("AtLeastOnce", "BothPeriods")[rr]]
                    estGD[, agelb := (10:12)[s]]
                    estGD[, agdef := aghh.defs[m]]
                    estGD[, HHtype := c("all", "direct")[j]]
                    estGD[, inference := c("LZ", "BRL")[clnum]]
                    estGD[, gender := genderitems[ge]]
                    estGD[, data := thisdata]
                    eGD <- rbind(eGD, estGD, use.names = T)
                    # n and R2
                    nR <- lapply(lapply(estGDs1, "[[", "reg"), 
                      function(x) t(c(length(summary(x)$res), summary(x)$r.sq)))
                    nR <- lapply(nR, data.table)
                    nR <- lapply(1:length(nR), function(i) nR[[i]][, reg := i])
                    nR <- rbindlist(nR)
                    nR[, file := gdfiles[gd]]
                    nR[, CrossSecYear := c(1999, 2002)[yy]]
                    nR[, CrossSecEnrollers := c("AtLeastOnce", "BothPeriods")[rr]]
                    nR[, agelb := (10:12)[s]]
                    nR[, agdef := aghh.defs[m]]
                    nR[, HHtype := c("all", "direct")[j]]
                    nR[, gender := genderitems[ge]]
                    nR[, data := thisdata]
                    setnames(nR, paste0("V", 1:2), c("n", "R"))
                    nR[, n := formatC(n, digits = 0, format = "f")]
                    nR[, R := formatC(R, digits = 4, format = "f")]
                    # number of agHHs
                    if (gd < 4) {
                      nR2 <- unique(unlist(lapply(lapply(estGDs1, "[[", "diff.data"), 
                        function(x) sum(x[, agHH]>0)))) 
                    } else {
                      nR2 <- unique(unlist(lapply(lapply(estGDs1, "[[", "level.data"), 
                        function(x) sum(x[, agHH]>0)))) 
                    }
                    nR[, Yes := formatC(nR2, digits = 0, format = "f")]
                    NR <- rbind(NR, nR, use.names = T, fill = T)
                    # treated and control means
                    if (gd < 4) {
                      zid <- lapply(estGDs1, "[[", "level.data")
                      zidd <- lapply(estGDs1, "[[", "diff.data")
                      zid <- lapply(1:length(zid), function(i) zid[[i]][uniquid %in% zidd[[i]][, uniquid], ])
                      zid <- lapply(zid, function(x) x[eval(parse(text=grepout("agHH$", colnames(x)))) > 0, 
                                agHH := 1L])
                      zid <- lapply(zid, function(x) x[eval(parse(text=grepout("agHH$", colnames(x)))) <= 0, 
                                agHH := 0L])
                      zid <- lapply(zid, function(x) x[, tee := 1:.N, by = uniquid])
                      if (gd %in% 1:2) 
                        lapply(zid, function(x) setnames(x, "NumGrades", "LHS")) else
                        lapply(zid, function(x) setnames(x, "DaysAbsent", "LHS"))
                      enr <- lapply(zid, function(x) x[, .(EnRate = mean(LHS), Num = .N), by = .(agHH, tee)])
                    } else {
                      zid <- lapply(estGDs1, "[[", "level.data")
                      lapply(zid, function(x) setnames(x, "DaysAbsent", "LHS", skip_absent = T))
                      enr <- lapply(zid, function(x) x[, .(EnRate = mean(LHS), Num = .N), by = agHH])
                      lapply(enr, function(x) x[, tee := yy])
                    }
                    enr <- lapply(1:length(enr), function(i) enr[[i]][, spec := i])
                    enr <- rbindlist(enr)
                    enr[, agelb := (10:12)[s]]
                    enr[, agdef := aghh.defs[m]]
                    enr[, HHtype := c("all", "direct")[j]]
                    enr[, gender := genderitems[ge]]
                    enr[, data := thisdata]
                    enr[, file := gdfiles[gd]]
                    enr[, CrossSecYear := c(1999, 2002)[yy]]
                    enr[, CrossSecEnrollers := c("AtLeastOnce", "BothPeriods")[rr]]
                    enr <- unique(enr[, spec := NULL])
                    Enr <- rbind(Enr, enr, use.names = T)
                  } # clnum
                } # m
              } # ge
            } # j
          } # s
        } # rr: Cross section. For enrollers of AtLeastOnce, BothPeriods
      } # yy: Cross section. 1999, 2002
    } # jj
  } # ii
} # gd
eGD[, coeff := as.character(NA)]
eGD[grepl("^agHH.yr.$", Coef), coeff := "main"]
eGD[grepl("SibF.*H", Coef), coeff := "older female siblings"]
eGD[grepl("SibM.*H", Coef), coeff := "older male siblings"]
eGD[grepl("^Sti", Coef), coeff := "stipend program"]
eGD[grepl("^NonS", Coef), coeff := "non-stipend program"]
eGD[, coeff := factor(coeff)]
eGD[, Coef := factor(Coef)]
eGD[, inference := factor(inference)]
eGD[, data := factor(data)]
eGD[, agdef := factor(agdef, levels = aghh.defs)]
eGD[, gender := factor(gender, levels = genderitems)]
eGD[, HHtype := factor(HHtype)]
eGD[, file := factor(file)]
eGD[, CrossSecYear := factor(CrossSecYear)]
eGD[, CrossSecEnrollers := factor(CrossSecEnrollers)]
eGD[, reg := factor(reg)]
eGD[, agelb := factor(agelb)]
NR[, data := factor(data)]
NR[, agdef := factor(agdef, levels = aghh.defs)]
NR[, gender := factor(gender, levels = genderitems)]
NR[, HHtype := factor(HHtype)]
NR[, file := factor(file)]
NR[, CrossSecYear := factor(CrossSecYear)]
NR[, CrossSecEnrollers := factor(CrossSecEnrollers)]
NR[, reg := factor(reg)]
NR[, agelb := factor(agelb)]
Enr[, data := factor(data)]
Enr[, agdef := factor(agdef, levels = aghh.defs)]
Enr[, gender := factor(gender, levels = genderitems)]
Enr[, HHtype := factor(HHtype)]
Enr[, file := factor(file)]
Enr[, CrossSecYear := factor(CrossSecYear)]
Enr[, CrossSecEnrollers := factor(CrossSecEnrollers)]
Enr[, agelb := factor(agelb)]
qsave(eGD, "../save/GenderGradeDaysAbsentTabulated2024.qs")
qsave(NR, "../save/GenderGradeDaysAbsentTabulatedNR2024.qs")
qsave(Enr, "../save/GenderGradeDaysAbsentTabulatedEnr2024.qs")
####qsave(eGD, "save/GenderGradeDaysAbsentTabulated2024.qs")
####qsave(NR, "save/GenderGradeDaysAbsentTabulatedNR2024.qs")
####qsave(Enr, "save/GenderGradeDaysAbsentTabulatedEnr2024.qs")
```
</details>



# Results

## Main estimation results

Main results in text. For full results, see <a name = "ResultsTableMain">[the full table in appendix.](#FullResultsMain)</a> Agricultural household definition is based on `r Aghh.defs[3]`(`r aghh.defs[3]`)  

<details><summary>Click here to see the code of showing main results.</summary>
```{r show main table, echo = T, eval = T, warning = F}
#### Uses tabs2latex4
Enr <- qread("../save/TabulatedAllResultsEnr.qs")
NR <- qread("../save/TabulatedAllResultsNR.qs")
#### results <- qread("save/DID2024_MainResults.qs")
#### Enr <- qread("save/TabulatedAllResultsEnr.qs")
#### NR <- qread("save/TabulatedAllResultsNR.qs")
ii <- jj <-   s <- de <- 1
j <- clnum <- 2
#### aghh.defs[c(1, 2, 3)] =  "agHH0" "isagHH",  "hdagHH"
nR <- NR[agelb == (10:12)[1] & grepl("m", data) & grepl("^B", inference) & grepl("^d", HHtype), ]
enr0 <- Enr[agelb == (10:12)[1] & grepl("m", data) & grepl("B", inference) & grepl("^d", HHtype), ]
enr0[, EnRate := formatC(EnRate, digits = 4, format = "f")]
Tab <- NULL
source(paste0(pathprogram, "tabulate_est.R"))
for (ge in c(3, 1, 2)){
  Tab0 <- NULL
  for (m in 3) {
    cis0 <- lapply(results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci")
    cis0 <- lapply(cis0, data.table)
    cis <- lapply(cis0, function(x) x[, df := NULL])
    cis <- lapply(cis, function(x) {
     dm <- data.frame(x[, -1])
     rownames(dm) <- as.character(unlist(x[, 1]))
     dm
     })
    tab0 <- tabs2latex4(cis, informat = "sattCI", outformat = OUTFORMAT, xx.yyy = T,
      AddStarIntabstarP = ADDStar, CIIntinysize = T, Pparenthesis = "brace", 
      UseHTML = T)
    tab0 <- tab0[grepl("^agHH.yr\\d|\\{agHH.yr\\d|Sib..a", rownames(tab0)), ]
    vs <- c("^agHH.yr\\d", "^OldSibF.a.*$", "^OldSibM.a.*$")
    #### Select rows of vs + se, p, CI (plusrow = 3) if espc
    #### Select rows of vs + se or p, CI (plusrow = 2) if e[sp]c
    nums <- NULL
    for (vv in vs) nums <- c(nums, grep(vv, rownames(tab0))+0:plusrows)
    tab0 <- tab0[nums, ]
    nr <- rbind(
      formatC(nR[grepl(aghh.defs[m], agdef) & grepl(genderregexpr[ge], gender), ][
        order(reg), R], digits = 4, format = "f")
    , formatC(nR[grepl(aghh.defs[m], agdef) & grepl(genderregexpr[ge], gender), ][
        order(reg), Yes], digits = 0, format = "f")
    , formatC(nR[grepl(aghh.defs[m], agdef) & grepl(genderregexpr[ge], gender), ][
        order(reg), n], digits = 0, format = "f")
    )
    enr <- matrix(
     enr0[grepl(aghh.defs[m], agdef) & grepl(genderregexpr[ge], gender), ][
       order(tee, agHH), EnRate], byrow = F, nrow = 4)
    enr <- data.table(enr[, rep(1, 3)])
    nr <- data.table(nr)
    nr[2:3, c(1, 3) := ""]
    enr[, c(1, 3) := ""]
    tab <- rbindlist(list(tab0, rbind(nr, enr)), use.names = F)
    tabmat <- as.matrix(tab)
    Tab0 <- cbind(Tab0, tabmat)
  }
  gg <- which(ge==c(3, 1, 2))
  #Tab0 <- rbind(paste0("(", (gg-1)*6+1:ncol(Tab0), ")"), Tab0) 
  Tab0 <- rbind((gg-1)*3+1:ncol(Tab0), Tab0) 
  Tab <- cbind(Tab, Tab0)
}
rn <- rownames(tab0)
#rn[grepl("^CI|^p", rn)] <- ""
rn2 <- c("R2", "N: agHH", "N", 
  paste0("mean of ", rep(c("control in ", "treated in "), 2), 
    rep(c(1999, 2002), each = 2)))
rnm <- rep(c(" ", rn, rn2), 1)
####  replace variable names, deleting std error names
for (k in 1:nrow(sbt)){
  if (any(grepl(sbt[k, "org"], rnm))) 
    rnm[grep(sbt[k, "org"], rnm)] <- sbt[k, "changedto"]
}
rnm <- gsub("^\\\\hspace\\{.*\\}", "", rnm)
rnm <- gsub("^Agricultural household", 
  "Agricultural household * year 2002", rnm)
rnm <- gsub("Number of ol", "Ol", rnm)
rnm <- gsub("female siblings", "sisters", rnm)
rnm <- gsub("male siblings", "brothers", rnm)
rnm <- gsub("Older", 
  "$\\\\underline{\\\\phantom{mm}}$ * Older", rnm)
Tab <- cbind(covariates = rnm, Tab)
Tab <- rbind(Tab, 
  "Covariates, thana trends" = 
    c("\\hspace{.5em}Covariates, thana trends", 
      rep(c("", "Y", "Y"), 3)),
  "HH trends" = 
    c("\\hspace{.5em}HH trends", rep(c("", "", "Y"), 3)))
#### LaTeX output
SepCols <- c(3, 6) 
ltb <- latextab(Tab, delimiterline = NULL, 
    hcenter = c(3.25, rep(1.5, ncol(Tab)-1)),
    hleft = c("\\scriptsize", rep("\\hfil\\scriptsize$", ncol(Tab)-1)), 
    hright = c("\\hfill", rep("$", ncol(Tab)-1)),
    headercolor = NULL, 
    adjustlineskip = "-.5ex", 
    adjlskiprows = rep(grep("CI", Tab[, 1]), each = plusrows)-(plusrows:1),
    addseparatingcols = SepCols, separatingcolwidth = rep(.1, length(SepCols)), 
    separatingcoltitle = c("\\textsf{Boys+girls}", "\\textsf{Boys}", "\\textsf{Girls}")
  ) 
aghhrows <- grep("Agricultural h", ltb)
ltb <- c(
  ltb[1:(length(ltb)-3)],
  "\\multicolumn{12}{l}{\\scriptsize Common specifications}\\\\",
  ltb[(length(ltb)-2):length(ltb)]
  )
ltb <- gsub("\\$CI.*\\$|CI\\$.*\\$", "", ltb)
ltb <- gsub("\\$p.*\\$|p\\$.*\\$", "", ltb)
ltb <- gsub("\\$se.*\\$|se\\$.*\\$", "", ltb)
ltb <- gsub("(^\\\\cline.*$)", "\\1[-1ex]", ltb)
ltb <- gsub("household", "HH", ltb)
ltb <- gsub("Y", "\\\\mbox{Y}", ltb)
ltb <- gsub("R2", "$\\\\bar{R}^{2}$", ltb)
allcovrows <- which(grepl("\\w", ltb) & 
  !grepl("trend|^N|^R2|[mM]ea.*1999|[mM]ea.*200|^\\\\|^ +?\\&|CI|p\\$|\\\\bar", ltb))
for (i in allcovrows+2) ltb[i] <- gsub("\\{(.*?)\\}", "\\\\{\\1\\\\}", ltb[i])
#### \{123\}^\{\phantom{**}\} => \{123\}^{\phantom{**}}
ltb <- gsub("\\^\\\\\\{(.*?)\\\\\\}", "^\\{\\1\\}", ltb)
ltb <- ltb[!grepl("Raw", ltb)]
ltb <- ltb[!grepl("1 \\& 2 \\& 3 ", ltb)]
ltb <- c(
  ltb[1], "\\hline",
  ltb[2:3],
  paste0("\\makebox[3.25cm]{Covariates}",
    paste0("&\\makebox[1.3cm]{(", 1:3, ")}", collapse = ""),
    "&",
    paste0("&\\makebox[1.3cm]{(", 3+1:3, ")}", collapse = ""),
    "&",
    paste0("&\\makebox[1.3cm]{(", 6+1:3, ")}", collapse = ""),
    "\\\\"),
  ltb[5:(length(ltb)-1)], "\\hline",
  ltb[length(ltb)]
  )
#### for (iii in 1:18) {
####   ltb <- gsub(paste("\\&", iii, "\\&"), paste0("& (", iii, ") &"), ltb)
####   ltb <- gsub(paste0("\\& ", iii, "\\\\\\\\"), 
####    paste0("& (", iii, ") \\\\\\\\"), ltb)
#### }
write.tablev(ltb
  ,  paste0("../save/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "ByGenderResults.tex")
  ,  colnamestrue = F)
write.tablev(ltb
  ,  paste0("../draft/Tables/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "ByGenderResults.tex")
  ,  colnamestrue = F)
#### Concise table (dropping estimates on siblings)
sibrows <- grep("Old.*ib", ltb)
if (length(sibrows) > 0) {
  ltbshort <- ltb[-(sibrows+rep(0:2, length(sibrows)))]
  ####othrows <- grep("ea.*rol.*02|ea.*tre", ltbshort)
  ####ltbshort <- ltbshort[-othrows]
  write.tablev(ltbshort
    ,  paste0("../save/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
         "ByGenderResultsConcise.tex")
    ,  colnamestrue = F)
}
#### HTML output
library(kableExtra)
Tab[, 1] <- gsub("^\\\\hspace\\{.*\\}", "", Tab[, 1])
Tab[, 1] <- gsub("CI\\$.*\\$", "", Tab[, 1])
Tab[, 1] <- gsub("se\\$.*\\$", "", Tab[, 1])
Tab[, 1] <- gsub("p\\$.*\\$", "", Tab[, 1])
colnames(Tab) <- c("variables", rep(c("raw DID", 
  "+covariates", "+HH trends"), 3))
for (iii in 2:ncol(Tab)) {
  Tab[, iii] <- gsub("\\\\mbox\\{\\\\tiny ?(.*)\\}", "\\1", Tab[, iii])
  Tab[, iii] <- gsub("\\\\phantom\\{.*?\\}", "", Tab[, iii])
  Tab[, iii] <- gsub("\\^\\{(.*)\\}", "", Tab[, iii])
}
bgcolor <- "#ffcc99"
#### kt <- kbl(Tab, align = paste0("r", paste0(rep("c", ncol(Tab)-1), collapse = "")), 
####   row.names = F, caption = 
####   paste("Main results: Enrollment impacts for year 1999-2002,",
####     "10-18 years old, direct offspring, Satterthwaite correction"))
#### kt <- kable_styling(kt, full_width = F, position = "left", fixed_thead = T, 
####   ####html_font = "Roboto", html_font = "Crimson Text", 
####   html_font = "Cambria", bootstrap_options = c("condensed"))
#### kt <- add_header_above(kt, c(" " = 1, "Boys+girls" = 3, "Boys" = 3, "Girls" = 3),
####   background = bgcolor)
#### kt <- row_spec(kt, 0, align = paste0(rep("c", ncol(Tab)-1), collapse = ""), 
####   background = bgcolor)
#### kt <- row_spec(kt, grep("Agri", Tab[, "variables"])+0:plusrows, bold = F, 
####   color = "black", background = "#87cefa")
#### kt <- pack_rows(kt, group_label="Common specifications", 
####   grep("Co.*ana", Tab[, 1]), grep("HH tre", Tab[, 1]))
#### kt <- scroll_box(kt, height = "800px")
#### kt <- footnote(kt, 
####          general = "Sample of direct offspring of household heads. ",
####          number = c(SpecMemo1html, 
####          SEMemoForSelectedResultsNoStarhtml)
####        )
#### Using kable shows title above the table
#### Using kbl shows title in the side note
kt <- kable(data.table(Tab), 
  align = paste0("r", paste0(rep("c", ncol(Tab)-1), collapse = "")), 
  caption = 
  paste("Main results: Enrollment impacts for year 1999-2002,",
    "10-18 years old, direct offspring, Satterthwaite correction"))
kt <- add_header_above(kt, c(" " = 1, "Boys+girls" = 3, "Boys" = 3, "Girls" = 3),
  background = bgcolor)
kt <- row_spec(kt, 0, align = paste0(rep("c", ncol(Tab)-1), collapse = ""), 
  background = bgcolor)
kt <- row_spec(kt, grep("Agri", Tab[, "variables"])+0:plusrows, bold = F, 
  color = "black", background = "#87cefa")
kt <- row_spec(kt, grep("Agri", Tab[, "variables"])+plusrows, font_size = 11)
kt <- row_spec(kt, grep("Older", Tab[, "variables"])+plusrows, font_size = 11)
kt <- pack_rows(kt, group_label="Common specifications", 
  grep("Co.*ana", Tab[, 1]), grep("HH tre", Tab[, 1]))
kt <- column_spec(kt, 1, width = "6cm; min-width:6cm;")
kt <- column_spec(kt, 2:10, width = "2.25cm; min-width:2.25cm;")
kt <- scroll_box(kt, height = "800px")
kt <- footnote(kt, 
         general = "Sample of direct offspring of household heads. ",
         number = c(SpecMemo1html, 
         SEMemoForSelectedResultsNoStarhtml)
       )
```
</details>
```{r , echo = F}
kt
```

* We use head's reply for the agricultural household definition.  
   * This follows the questionnaire of original IFPRI data set.  
   * The questionnaire asks the household head on the income generating activities and specifies the contents of agricultural activies.  
* In appendix, we show that impacts under other agHH definitions. The impact estimates based on head's reply tend to have smaller SEs. This is due to possible measurement errors in the occupation based definition or in the income based definition.  
   * Head's reply based and income based definitions have a high correlation. Occupation based definition have lower correlations with the other two.  
* <Blue>Impacts are strongest among the boys.</Blues>  
* Impacts on girls are negative, but the size is small and estimates are noisy.  
* Note: Corr(lowMeanY, highMeanY)=.193 using regression data for boys, nuclear, 10 - 18. So the estimates on these covariates are not suffering from biases arising from multicollinearity.  

## Age group wise estimation results

Primary = 6-10. Secondary = 11-17.  

<details><summary>Click here to see the code of shoring age group wise results.</summary>
```{r show age group table, eval = T, warning = F}
#### Uses tabs2latex4
resultsag <- qread("../save/DID2024_SubsampleAgeGroupGenderResults.qs")
Enrag <- qread("../save/TabulatedAllResultsEnr.qs")
NRag <- qread("../save/TabulatedAllResultsNR.qs")
#### resultsag <- qread("save/DID2024_SubsampleAgeGroupGenderResults.qs")
#### Enrag <- qread("save/TabulatedAllResultsEnr.qs")
#### NRag <- qread("save/TabulatedAllResultsNR.qs")
ii <- jj <-   s <- de <-  gg <- 1
j <- clnum <- 2
m <- 3
nR <- NRag[grepl("A.*2", agegroup) & grepl(aghh.defs[m], agdef) & grepl("m", data) & 
  grepl("^B", inference) & grepl("^d", HHtype), ]
enr0 <- Enrag[grepl("A.*2", agegroup) & grepl(aghh.defs[m], agdef) & grepl("m", data) & 
  grepl("B", inference) & grepl("^d", HHtype), ]
enr0[, EnRate := formatC(EnRate, digits = 4, format = "f")]
#### aghh.defs[c(1, 3)] =  "agHH0"  "hdagHH"
Tab <- NULL
for (ag in 1:2){
  Tab0 <- NULL
  for (ge in c(3, 1, 2)){
    #### [[ii]][[ge]][[m]][[j]][[gg]][[ag]][[clnum]][[k]]
    cis0 <- lapply(resultsag[[ii]][[ge]][[m]][[j]][[gg]][[ag]][[clnum]], "[[", "ci")
    cis0 <- lapply(cis0, data.table)
    cis <- lapply(cis0, function(x) x[, df := NULL])
    cis <- lapply(cis, function(x) {
     dm <- data.frame(x[, -1])
     rownames(dm) <- as.character(unlist(x[, 1]))
     dm
     })
    tab0 <- tabs2latex4(cis, informat = "sattCI", outformat = OUTFORMAT, 
      xx.yyy = T, AddStarIntabstarP = ADDStar, CIIntinysize = T, 
      Pparenthesis = "brace", UseHTML = T)
    tab0 <- tab0[grepl("^agHH.yr\\d|\\{agHH.yr\\d|Sib..a", rownames(tab0)), ]
    vs <- c("^agHH.yr\\d", "^OldSibF.a.*yr.$", "^OldSibM.a.*yr.$")
    nums <- NULL
    for (vv in vs) nums <- c(nums, grep(vv, rownames(tab0))+0:plusrows)
    tab0 <- tab0[nums, ]
    nr <- rbind(
      formatC(nR[grepl(genderregexpr[ge], gender) & grepl(agitems[ag], group), ][
        order(reg), R], digits = 4, format = "f")
    , formatC(nR[grepl(genderregexpr[ge], gender) & grepl(agitems[ag], group), ][
        order(reg), Yes], digits = 0, format = "f")
    , formatC(nR[grepl(genderregexpr[ge], gender) & grepl(agitems[ag], group), ][
        order(reg), n], digits = 0, format = "f")
    )
    enr <- matrix(
     enr0[grepl(genderregexpr[ge], gender) & grepl(agitems[ag], group), ][
       order(tee, agHH), EnRate], byrow = F, nrow = 4)
    enr <- data.table(formatC(enr, digits = 4, format = "f")[, rep(1, 3)])
    nr <- data.table(nr)
    nr[2:3, c(1, 3) := ""]
    enr[, c(1, 3) := ""]
    tab <- rbindlist(list(tab0, rbind(nr, enr)), use.names = F)
    tabmat <- as.matrix(tab)
    Tab0 <- cbind(Tab0, tabmat)
  }
  ####Tab0 <- rbind(paste0("(", (ag-1)*9+1:ncol(Tab0), ")"), Tab0) 
  Tab0 <- rbind((ag-1)*9+1:ncol(Tab0), Tab0) 
  Tab <- rbind(Tab, Tab0)
}
rn <- rownames(tab0)
rn2 <- c("R2", "N: agHH", "N", 
  paste0("mean of ", rep(c("control in ", "treated in "), 2), rep(c(1999, 2002), each = 2)))
rnm <- rep(c(" ", rn, rn2), 2)
####  replace variable names, deleting std error names
for (k in 1:nrow(sbt)){
  if (any(grepl(sbt[k, "org"], rnm))) 
    rnm[grep(sbt[k, "org"], rnm)] <- sbt[k, "changedto"]
}
rnm <- gsub("^\\\\hspace\\{.*\\}", "", rnm)
rnm <- gsub("^Agricultural household", "Agricultural household * year 2002", rnm)
rnm <- gsub("Number of ol", "Ol", rnm)
rnm <- gsub("female siblings", "sisters", rnm)
rnm <- gsub("male siblings", "brothers", rnm)
rnm <- gsub("Older", "$\\\\underline{\\\\phantom{mm}}$ * Older", rnm)
Tab <- cbind(covariates = rnm, Tab)
Tab <- rbind(Tab, 
  "Covariates, thana trends" = c("\\hspace{.5em}Covariates, thana trends", rep(c("", "Y", "Y"), 3)),
  "HH trends" = c("\\hspace{.5em}HH trends", rep(c("", "", "Y"), 3)))
#### LaTeX output
SepCols <- c(3, 6)
ltb <- latextab(Tab, delimiterline = NULL, 
    hcenter = c(3, rep(1.3, ncol(Tab)-1)),
    hleft = c("\\scriptsize", rep("\\hfil\\scriptsize$", ncol(Tab)-1)), 
    hright = c("\\hfill", rep("$", ncol(Tab)-1)),
    headercolor = NULL, 
    adjustlineskip = "-.5ex", 
    adjlskiprows = rep(grep("CI", Tab[, 1]), each = plusrows)-(plusrows:1),
    addseparatingcols = SepCols, separatingcolwidth = rep(.1, length(SepCols)), 
    separatingcoltitle = c("\\textsf{Boys+Girls}", "\\textsf{Boys}", "\\textsf{Girls}")
  ) 
aghhrows <- grep("Agricultural h", ltb)
ltb <- c(
  ltb[1], "\\hline",
  ltb[2:grep("cline", ltb)],
  "&\\multicolumn{11}{c}{\\scriptsize A. Primary school ages}\\\\",
  ltb[(aghhrows[1]-1):(aghhrows[2]-2)],
  "&\\multicolumn{11}{c}{\\scriptsize B. Secodary school ages}\\\\",
  ltb[(aghhrows[2]-1):(length(ltb)-3)],
  "\\multicolumn{8}{l}{\\scriptsize Common specifications}\\\\",
  ltb[(length(ltb)-2):(length(ltb)-1)], 
  "\\hline", ltb[length(ltb)]
  )
ltb <- gsub("CI\\$.*\\$", "", ltb)
ltb <- gsub("p\\$.*\\$", "", ltb)
ltb <- gsub("se\\$.*\\$", "", ltb)
allcovrows <- which(grepl("\\w", ltb) & 
  !grepl("trend|^N|^R2|[mM]ea.*1999|[mM]ea.*200|^\\\\|^ ?\\&|CI|p\\$|\\\\bar", ltb))
for (i in allcovrows+2) ltb[i] <- gsub("\\{(.*?)\\}", "\\\\{\\1\\\\}", ltb[i])
ltb <- gsub("\\^\\\\\\{(.*?)\\\\\\}", "^\\{\\1\\}", ltb)
ltb <- gsub("(^\\\\cline.*$)", "\\1[-1ex]", ltb)
ltb <- gsub("household", "HH", ltb)
ltb <- gsub("Y", "\\\\mbox{Y}", ltb)
ltb <- gsub("R2", "$\\\\bar{R}^{2}$", ltb)
ltb <- ltb[!grepl("Raw", ltb)]
ltb <- gsub(".* 1 .* 3 .* 5 .* 6.*", "&(1)&(2)&(3)&&(4)&(5)&(6)&&(7)&(8)&(9)\\\\\\\\", ltb)
ltb <- gsub(".* 10 .* 13 .* 15 .*", "&(10)&(11)&(12)&&(13)&(14)&(15)&&(16)&(17)&(18)\\\\\\\\", ltb)
ltb1 <- c(ltb[1:(aghhrows[2]-2)], ltb[length(ltb)-2:0])
ltb2 <- c(ltb[1:grep("cline", ltb)], ltb[(aghhrows[2]-1):length(ltb)])
write.tablev(ltb1
  ,  paste0("../save/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "ByGenderByAgeGroup2Results1.tex")
  ,  colnamestrue = F)
write.tablev(ltb2
  ,  paste0("../save/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "ByGenderByAgeGroup2Results2.tex")
  ,  colnamestrue = F)
#### Concise table (dropping estimates on siblings) with A. BG, B. Boys, C. Girls
sibrows <- grep("Older", ltb)
ltbshort <- ltb[-(sibrows+rep(0:2, length(sibrows)))]
####othrows <- grep("ea.*tre", ltbshort)
####ltbshort <- ltbshort[-othrows]
write.tablev(ltbshort
  ,  paste0("../save/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "ByGenderByAgeGroup2Results.tex")
  ,  colnamestrue = F)
#### More concise table for main text
aghhrows <- grep("Agricultural H", ltb)
r2rows <- grep("\\{R\\}", ltb)
ltb4 <- ltb[
    c(1:(aghhrows[1]+2), r2rows[1]+c(0, 2, 3:6),
       aghhrows[2]+(-2:2), r2rows[2]+c(0, 2, 3:6), length(ltb)-4:0)
    ]
write.tablev(ltb4
  ,  paste0("../save/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "ByGenderByAgeGroup2ResultsConcise.tex")
  ,  colnamestrue = F)
#### HTML output
Tab[, 1] <- gsub("se\\$.*\\$", "", Tab[, 1])
Tab[, 1] <- gsub("p\\$.*\\$", "", Tab[, 1])
Tab[, 1] <- gsub("CI\\$.*\\$", "", Tab[, 1])
Tab[, 1] <- gsub("\\\\hspace\\{.*?\\}", "",
####  "<span><span style=\"margin-left: 1em\" />", 
####  "<img src=\"transparent.png\" height=\".1px\" width=\".5em\">", rnm)
Tab[, 1])
for (iii in 2:ncol(Tab)) {
  Tab[, iii] <- gsub("\\\\mbox\\{\\\\tiny ?(.*)\\}", "\\1", Tab[, iii])
  Tab[, iii] <- gsub("\\\\phantom\\{.*?\\}", "", Tab[, iii])
  Tab[, iii] <- gsub("\\^\\{(.*)\\}", "", Tab[, iii])
}
library(kableExtra)
colnames(Tab) <- c("variables", rep(c("raw DID", 
  "+covariates", "+HH trends"), 3))
bgcolor <- "#ffcc99"
#### kt <- kbl(Tab, align = paste0("r", paste0(rep("c", ncol(Tab)-1), collapse = "")), 
####   row.names = F, caption = 
####   "Main results: Enrollment impacts for year 1999-2002 by school age group, direct offspring, Satterthwaite correction")
#### kt <- add_header_above(kt, c(" " = 1, "boys+girls" = 3, "boys" = 3, "girls" = 3),
####   background = bgcolor)
#### kt <- kable_styling(kt, full_width = F, position = "left", fixed_thead = T, 
####   ####html_font = "Crimson Text",   html_font = "Roboto", 
####   html_font = "Cambria", bootstrap_options = c("condensed"))
#### kt <- row_spec(kt, 0, align = paste0(rep("c", ncol(Tab)-1), collapse = ""), 
####   background = bgcolor)
#### kt <- row_spec(kt, grep("Agri", Tab[, "variables"])+0:plusrows, bold = F, 
####   color = "black", background = "#87cefa")
#### kt <- pack_rows(kt, group_label="Primary", grep("Agri", rnm)[1]-1, grep("Agri", rnm)[2]-2)
#### kt <- pack_rows(kt, group_label="Secondary", grep("Agri", rnm)[2]-1, grep("mean.*2002", rnm)[2])
#### kt <- pack_rows(kt, group_label="Common specifications", grep("Cov.*ana", Tab[, 1]), grep("HH tr", Tab[, 1]))
#### kt <- scroll_box(kt, height = "800px")
#### kt <- footnote(kt, 
####            general = "Sample of direct offspring of household heads. ",
####            number = c(SpecMemoAgeGroupwisehtml, SEMemoForSelectedResultsNoStarhtml)
####            )
kt <- kable(data.table(Tab), align = paste0("r", paste0(rep("c", ncol(Tab)-1), collapse = "")), 
  caption = 
  paste("Main results: Enrollment impacts for year 1999-2002",
  "by school age group, direct offspring, Satterthwaite correction"
    ))
kt <- add_header_above(kt, c(" " = 1, "Boys+girls" = 3, "Boys" = 3, "Girls" = 3),
  background = bgcolor)
kt <- row_spec(kt, 0, align = paste0(rep("c", ncol(Tab)-1), collapse = ""), 
  background = bgcolor)
aghhrows <- grep("Agri", Tab[, "variables"])
kt <- row_spec(kt, 
  rep(aghhrows, each = plusrows+1)+rep(0:plusrows, length(aghhrows)), 
  bold = F, color = "black", background = "#87cefa")
kt <- row_spec(kt, grep("Agri", Tab[, "variables"])+plusrows, font_size = 11)
kt <- row_spec(kt, grep("Older", Tab[, "variables"])+plusrows, font_size = 11)
kt <- pack_rows(kt, group_label="Primary", grep("Agri", rnm)[1]-1, grep("Agri", rnm)[2]-2)
kt <- pack_rows(kt, group_label="Secondary", grep("Agri", rnm)[2]-1, grep("mean.*2002", rnm)[2])
kt <- pack_rows(kt, group_label="Common specifications", grep("Cov.*ana", Tab[, 1]), grep("HH tr", Tab[, 1]))
kt <- column_spec(kt, 1, width = "6cm; min-width:6cm;")
kt <- column_spec(kt, 2:10, width = "2.25cm; min-width:2.25cm;")
kt <- scroll_box(kt, height = "800px")
kt <- footnote(kt, 
           general = "Sample of direct offspring of household heads. ",
           number = c(SpecMemoAgeGroupwisehtml, SEMemoForSelectedResultsNoStarhtml)
           )
```
</details>
```{r , echo = F}
kt
```

* Results show that <Blue>the effects are mainly found among secondary school goers, mostly boys.</Blue>  
* Primary school aged children may be too young to get affected.  
* Looking from a different subsample, results by different age lowerbound in the appendix show impacts to be larger among the sample with older boys.  

## Placebo estimation results

Placebo test estimates non-existing impacts between 2002-2006.  

 * 1999 cohort: 10-18 in 1999. 13-21 in 2002.  
 * 2002 cohort: 10-18 in 2002.  

<details><summary>Click here to see the code of showing placebo results.</summary>
```{r show placebo table, eval = T, warning = F}
#### Uses tabs2latex4
#### results <- qread("../save/DID2024_MainResults.qs")
Enr <- qread("../save/TabulatedAllResultsEnr.qs")
NR <- qread("../save/TabulatedAllResultsNR.qs")
#### results <- qread("save/DID2024_MainResults.qs")	
#### Enr <- qread("save/TabulatedAllResultsEnr.qs")
#### NR <- qread("save/TabulatedAllResultsNR.qs")
nR <- NR[agelb == (10:12)[1] & grepl("^B", inference) & grepl("^d", HHtype), ]
enr0 <- Enr[agelb == (10:12)[1] & grepl("B", inference) & grepl("^d", HHtype), ]
enr0[, EnRate := formatC(EnRate, digits = 4, format = "f")]
s <- de <- 1
ii <- j <- clnum <- 2
Tab <- NULL
for (jj in 1:2) {
  Tab0 <- NULL
  for (m in c(3, 2, 4, 1)) {
    Tab00 <- NULL
    for (ge in c(3, 1, 2)) {
      cis0 <- lapply(results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci")
	      cis0 <- lapply(cis0, data.table)
      cis <- lapply(cis0, function(x) x[, df := NULL])
      cis <- lapply(cis, function(x) {
       dm <- data.frame(x[, -1])
       rownames(dm) <- as.character(unlist(x[, 1]))
       dm
       })
      tab0 <- tabs2latex4(cis, informat = "sattCI", outformat = OUTFORMAT, 
        xx.yyy = T, AddStarIntabstarP = ADDStar, CIIntinysize = T, 
        Pparenthesis = "brace", UseHTML = T)
      tab0 <- tab0[grepl("^agHH.yr\\d|\\{agHH.yr\\d|Sib..a", rownames(tab0)), ]
      vs <- c("^agHH.yr\\d", "^OldSibF.a.*$", "^OldSibM.a.*$")
      nums <- NULL
      for (vv in vs) nums <- c(nums, grep(vv, rownames(tab0))+0:plusrows)
      tab0 <- tab0[nums, ]
      nr <- rbind(
        formatC(nR[grepl(aghh.defs[m], agdef) & grepl(c("p.2", "p.1")[jj], data)
          & grepl(genderregexpr[ge], gender), ][
          order(reg), R], digits = 4, format = "f")
      , formatC(nR[grepl(aghh.defs[m], agdef) & grepl(c("p.2", "p.1")[jj], data)
         & grepl(genderregexpr[ge], gender), ][
          order(reg), Yes], digits = 0, format = "f")
      , formatC(nR[grepl(aghh.defs[m], agdef) & grepl(c("p.2", "p.1")[jj], data)
         & grepl(genderregexpr[ge], gender), ][
          order(reg), n], digits = 0, format = "f")
      )
      enr <- matrix(
       enr0[grepl(aghh.defs[m], agdef) & grepl(c("p.2", "p.1")[jj], data)
         & grepl(genderregexpr[ge], gender), ][
         order(tee, agHH), EnRate], byrow = F, nrow = 4)
      enr <- data.table(enr[, rep(1, 3)])
      nr <- data.table(nr)
      nr[2:3, c(1, 3) := ""]
      enr[, c(1, 3) := ""]
      tab <- rbindlist(list(tab0, rbind(nr, enr)), use.names = F)
      tabmat <- as.matrix(tab)
      #### Tab00: (boys+girls)*3specs, boys*3specs, girls*3specs
      Tab00 <- cbind(Tab00, tabmat)
    } # end of ge loop
    #### Tab0: rbind(Tab00.hdagHH, Tab00.isagHH, Tab00.ocagHH, Tab00.agHH0)
    mm <- which(m==c(3, 2, 4, 1))
    Tab00 <- rbind((jj-1)*9*4+(mm-1)*9+1:ncol(Tab00), Tab00) 
    assign(paste0("T", jj, m), Tab00)
    Tab0 <- rbind(Tab0, Tab00)
  } # end of m loop
  rn <- rownames(tab0)
  #rn[grepl("^CI|^p", rn)] <- ""
  rn2 <- c("R2", "N: agHH", "N", 
    paste0("mean of ", rep(c("control in ", "treated in "), 2), rep(c(2002, 2006), each = 2)))
  rnm <- rep(c(" ", rn, rn2), 1)
  ####  replace variable names, deleting std error names
  for (k in 1:nrow(sbt)){
    if (any(grepl(sbt[k, "org"], rnm))) 
      rnm[grep(sbt[k, "org"], rnm)] <- sbt[k, "changedto"]
  }
  rnm <- gsub("^\\\\hspace\\{.*\\}", "", rnm)
  rnm <- gsub("^Agricultural household", "Agricultural household * year 2006", rnm)
  rnm <- gsub("Number of ol", "Ol", rnm)
  rnm <- gsub("female siblings", "sisters", rnm)
  rnm <- gsub("male siblings", "brothers", rnm)
  rnm <- gsub("Older", "$\\\\underline{\\\\phantom{mm}}$ * Older", rnm)
  Tab0 <- cbind(covariates = rnm, Tab0)
  Tab0 <- rbind(Tab0, 
    "Covariates, thana trends" = c("\\hspace{.5em}Covariates, thana trends", rep(c("", "Y", "Y"), 3)),
    "HH trends" = c("\\hspace{.5em}HH trends", rep(c("", "", "Y"), 3)))
  Tab <- rbind(Tab, Tab0)
  #### Tab: rbind(Tab0.2002cohort, Tab0.1999cohort)
}
TabPla = copy(Tab)
#### LaTeX output
#### Pick only head reply based results
comspec <-  rbind(
  "Covariates, thana trends" = c("\\hspace{.5em}Covariates, thana trends", rep(c("", "Y", "Y"), 3)),
  "HH trends" = c("\\hspace{.5em}HH trends", rep(c("", "", "Y"), 3)))
T3 <- rbind(cbind(rnm, T13)[-1, ], comspec, cbind(rnm, T23)[-1, ], comspec)
SepCols <- c(3, 6) 
ltb <- latextab(T3, delimiterline = NULL, 
    hcenter = c(3.5, rep(1.5, ncol(T3)-1)),
    hleft = c("\\scriptsize", rep("\\hfil\\scriptsize$", ncol(T3)-1)), 
    hright = c("\\hfill", rep("$", ncol(T3)-1)),
    headercolor = NULL, 
    adjustlineskip = "-.5ex", 
    adjlskiprows = rep(grep("CI", T3[, 1]), each = plusrows)-(plusrows:1),
    addseparatingcols = SepCols, separatingcolwidth = rep(.1, length(SepCols)), 
    separatingcoltitle = c("\\textsf{Boys+Girls}", "\\textsf{Boys}", "\\textsf{Girls}")
  ) 
aghhrows <- grep("Agricultural h", ltb)
ltb <- c(
  ltb[1], "\\hline", 
  ltb[2:grep("cline", ltb)],
  "&\\multicolumn{11}{c}{\\scriptsize A. 2002 cohort}\\\\",
  ltb[(aghhrows[1]-1):(aghhrows[2]-3)],
  "\\multicolumn{12}{l}{\\scriptsize Common specifications}\\\\",
  ltb[(aghhrows[2]-2):(aghhrows[2]-1)],
  "&\\multicolumn{11}{c}{\\scriptsize B. 1999 cohort}\\\\",
  paste(paste0("&", paste0("(", 10:18, ")"), collapse = ""), "\\\\"),
  ltb[(aghhrows[2]):(length(ltb)-3)],
  "\\multicolumn{12}{l}{\\scriptsize Common specifications}\\\\",
  ltb[(length(ltb)-2):(length(ltb)-1)],
  "\\hline", ltb[length(ltb)]
  )
ltb <- gsub("CI\\$.*\\$", "", ltb)
ltb <- gsub("p\\$.*\\$", "", ltb)
ltb <- gsub("se\\$.*\\$", "", ltb)
allcovrows <- which(grepl("\\w", ltb) & 
  !grepl("trend|^N|^R2|[mM]ea.*1999|[mM]ea.*200|^\\\\|^ ?\\&|CI|p\\$|\\\\bar", ltb))
for (i in allcovrows+2) ltb[i] <- gsub("\\{(.*?)\\}", "\\\\{\\1\\\\}", ltb[i])
ltb <- gsub("\\^\\\\\\{(.*?)\\\\\\}", "^\\{\\1\\}", ltb)
ltb <- gsub("(^\\\\cline.*$)", "\\1[-1ex]", ltb)
ltb <- gsub("Y", "\\\\mbox{Y}", ltb)
ltb <- gsub("R2", "$\\\\bar{R}^{2}$", ltb)
ltb <- gsub("household", "HH", ltb)
ltb <- ltb[!grepl("Raw", ltb)]
for (iii in 1:18) {
  ltb <- gsub(paste("\\&", iii, "\\&"), paste0("& (", iii, ") &"), ltb)
  ltb <- gsub(paste0("\\& ", iii, "\\\\\\\\"), paste0("& (", iii, ") \\\\\\\\"), ltb)
}
write.tablev(ltb
  ,  paste0("../save/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "ByGenderResults.tex")
  ,  colnamestrue = F)
if (s == 1)
write.tablev(ltb
  ,  paste0("../draft/Tables/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "ByGenderResults.tex")
  ,  colnamestrue = F)
#### concise table for main text
iii <- grep("\\* Older", ltb)
ltb2 <- ltb[-(rep(iii, each = 3)+0:2)]
write.tablev(ltb2
  ,  paste0("../save/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "ByGenderResultsConcise.tex")
  ,  colnamestrue = F)
write.tablev(ltb2
  ,  paste0("../draft/Tables/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "ByGenderResultsConcise.tex")
  ,  colnamestrue = F)
#### HTML output
library(kableExtra)
aghhrows <- grep("Agri", T3[, 1])
T3h <- rbind(
    c(" ", 1:9), T3[1:(aghhrows[2]-1), ], 
    c(" ", 1:9+9), T3[aghhrows[2]:nrow(T3), ]
  )
TabObj <- c("T3h", "TabPla")
for (tt in 1:length(TabObj)) {
  Tab <- get(TabObj[tt])
  colnames(Tab) <- c("variables", 
    rep(c("raw DID", "+covariates", "+HH trends"), 3))
  Tab[, 1] <- gsub("CI\\$.*\\$", "", Tab[, 1])
  Tab[, 1] <- gsub("p\\$.*\\$", "", Tab[, 1])
  Tab[, 1] <- gsub("se\\$.*\\$", "", Tab[, 1])
  Tab[, 1] <- gsub("\\\\hspace\\{.5em\\}", "    ", Tab[, 1])
  for (iii in 2:ncol(Tab)) {
    Tab[, iii] <- gsub("\\\\mbox\\{\\\\tiny ?(.*)\\}", "\\1", Tab[, iii])
    Tab[, iii] <- gsub("\\\\phantom\\{.*?\\}", "", Tab[, iii])
    Tab[, iii] <- gsub("\\^\\{(.*)\\}", "", Tab[, iii])
  }
  bgcolor <- "#ffcc99"
  Tab <- data.table(Tab)
  kt <- kable(data.table(Tab), align = paste0("r", paste0(rep("c", ncol(Tab)-1), collapse = "")), 
    caption = 
    "Enrollment placebo impacts: Year 2002-2006, 10-18 years old, direct offspring, Satterthwaite correction")
  kt <- add_header_above(kt, c(" " = 1, "Boys+girls" = 3, "Boys" = 3, "Girls" = 3),
    background = bgcolor)
  ####kt <- kable_styling(kt, full_width = F, position = "left", fixed_thead = T, 
  ####  html_font = "Cambria", bootstrap_options = c("condensed"))
  #### Header row
  kt <- row_spec(kt, 0, align = paste0(rep("c", ncol(Tab)-1), collapse = ""), 
    background = bgcolor)
  #### Hilight main effects
  aghhrows <- grep("Agri", Tab[, variables])
  kt <- row_spec(kt, 
    rep(aghhrows, each = plusrows+1)+rep(0:plusrows, length(aghhrows)), 
    bold = F, color = "black", background = "#87cefa")
  kt <- row_spec(kt, grep("Agri", Tab[, variables])+plusrows, font_size = 11)
  kt <- row_spec(kt, grep("Older", Tab[, variables])+plusrows, font_size = 11)
  kt <- column_spec(kt, 1, width = "6.5cm; min-width:6.5cm;")
  kt <- column_spec(kt, 2:10, width = "2.25cm; min-width:2.25cm;")
  #### Grouping rows
  RowGenderGroupCSS <- "background-color: #666; color: #fff;"
  kt <- pack_rows(kt, group_label="2002 cohort", aghhrows[1]-1, aghhrows[2]-2,
    label_row_css = RowGenderGroupCSS)
  aghhrows <- grep("^Ag", Tab[, variables])
  if (TabObj[tt]=="TabPla") {
    iichange <- 5
    #### Group by ag def
    #### Tab0: rbind(Tab00.hdagHH, Tab00.isagHH, Tab00.ocagHH, Tab00.agHH0)
    #### 3, 2, 4, 1 in Aghh.defs
    for (iii in 1:8) 
      kt <- pack_rows(kt, group_label=Aghh.defs[c(rep(c(3, 2, 4, 1), 2))[iii]], 
        aghhrows[iii]-1, aghhrows[iii]+plusrows)
  } else iichange <- 2
  kt <- pack_rows(kt, group_label="1999 cohort", aghhrows[iichange]-2, # 2, because label is inserted
    grep("Co.*ana", Tab[, variables])[2]-2, 
    label_row_css = RowGenderGroupCSS)
  kt <- pack_rows(kt, group_label="Common specifications", 
    grep("Co.*ana", Tab[, variables])[1], grep("HH tre", Tab[, variables])[1])
  kt <- pack_rows(kt, group_label="Common specifications", 
    grep("Co.*ana", Tab[, variables])[2], grep("HH tre", Tab[, variables])[2])
  kt <- scroll_box(kt, height = "800px")
  kt <- footnote(kt, 
             general = "Sample of direct offspring of household heads. ",
             number = c(SpecMemo1Placebohtml, SEMemoForSelectedResultsNoStarhtml)
             )
  assign(paste0("kt", tt), kt)
}
```
</details>
```{r , echo = F}
kt2
```

<details><summary>Click here to see the code of plotting main vs placebo.</summary>
```{r plot main vs placebo, eval = T}
#### results <- qread("../save/DID2024_MainResults.qs")
#### results <- qread("save/DID2024_MainResults.qs")
s <- de <- 1
j <- clnum <- 2
cis <- NULL
for (ii in 1:2) {
  jjmax <- 1
  if (ii == 2) jjmax <- 2
  for (jj in 1:jjmax) {
    for (ge in c(3, 1, 2)) {
      for (m in c(2:4, 1)) {
        cis0 <- lapply(results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci")
        cis0 <- lapply(cis0, data.table)
        cis0 <- lapply(cis0, function(x) x[, data := c("main", "placebo")[ii]])
        cis0 <- lapply(cis0, function(x) x[, cohort := c("1999", "2002")[jj]])
        cis0 <- lapply(cis0, function(x) x[, gender := genderitems[ge]])
        cis0 <- lapply(cis0, function(x) x[, agdef := aghh.defs[m]])
        cis0 <- lapply(1:length(cis0), function(i) cis0[[i]][, spec := i])
        cis0 <- rbindlist(cis0)
        cis <- rbindlist(list(cis, cis0))
      }
    }
  }
}
cis <- cis[grepl("^agHH.yr", Coef), ]
cis[, Agdef := factor(agdef)]
#### levels(cis[, Agdef])= "agHH0"  "hdagHH" "isagHH" "ocagHH"
#### == Aghh.defs[c(1, 3, 2, 4)]
#### Aghh.defs = "Combined" "Income source" "Head's reply"  "Occupation"
cis[, Agdef := factor(Agdef, labels = Aghh.defs[c(1, 3, 2, 4)])]
#### Reorder to "hdagHH" "isagHH" "ocagHH" "aggHH0"
cis[, Agdef := factor(Agdef, levels = Aghh.defs[c(3, 2, 4, 1)])]
cis[, group := factor(paste0(data, cohort), 
  levels = c("main1999", "placebo2002", "placebo1999"))]
cis[, group := factor(group, labels = c("main", "placebo2002", "placebo1999"))]
cis[, spec := factor(spec)]
cis[, yintercept := 0]
cis[, gender := factor(gender, levels = genderitems[c(3, 1, 2)])]
library(ggplot2)
PointRange <-  geom_pointrange(aes(ymin = CI_L, ymax = CI_U),
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .25))
g <- ggplot(data = cis, 
    aes(x = group, y = beta, group = spec, fill = spec, shape = spec, colour = spec)) + 
  PointRange + ThisTheme + facet_grid(Agdef ~ gender) +
  xlab("data") + 
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  labs(color  = "regression specifications", fill = "regression specifications", 
    shape = "regression specifications") +
  ThisThemeEnd +
  guides(
    colour = guide_legend(title = "regression specifications", nrow = 1),
    fill = guide_legend(title = "regression specifications", nrow = 1),
    shape = guide_legend(title = "regression specifications", nrow = 1)
    ) +
  geom_hline(aes(yintercept = yintercept), colour = "lightgreen")
pdf(
  "../save/MainVsPlaceboPlotsByAgdefByGender.pdf"
  , width = 2*12/2.54, height = 2*8/2.54)
print(g)
whatever <- dev.off()
pdf(
  "../draft/Figures/App_MainVsPlaceboPlotsByAgdefByGender.pdf"
  , width = 2.5*12/2.54, height = 2.5*8/2.54)
print(g)
whatever <- dev.off()
```
</details>
```{r , echo = F}
g
```

* Verdict: <Blue>No impacts found in placebo samples.</Blue>  
* Placebo estimation shows that, although $p$ values are around 7-10%, boys from the agricultural households have higher dropout rates when there are elder sisters.  
* This is only true for cohorts of 2002 but not of 1999. It suggests that this effect may be at work only for the ages between 10-18.  
* To better satisfy the common trend assumption, one should use the interaction terms between agHH and number of elder sisters.  
* Main effects remain statistically zero in the specifications with or without the interaction terms between agHH and elder sisters.  


## Non Muslim and Flooded 

```{r thana names, echo = F}
thanas <- as.character(lapply(unique(yzw[, thana]), function(x) 
  paste0(toupper(substring(x, 1, 1)), substring(x, 2, 30))))
thanas <- thanas[!grepl("NA", thanas)]
```

Results for non Muslims.

<details><summary>Click here to see the code of showing non-muslims and flooded.</summary>
```{r read nonmuslim flood results, eval = T, echo = F, warning = F}
resultsM <- qread("../save/DID2024_NonMuslimGenderResults.qs")
resultsF <- qread("../save/DID2024_FloodGenderResults.qs")
EnrFM <- qread("../save/TabulatedFloodMuslimResultsEnr2024.qs")
NRFM <- qread("../save/TabulatedFloodMuslimResultsNR2024.qs")
```
```{r show nonmuslim results, eval = F}
#### results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]][[k]] 
ii <- jj <- s <- 1
j <- m <- clnum <- 2
Tab <- NULL
for (ge in 1:3) {
  cis0 <- lapply(resultsM[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci")
  cis0 <- lapply(cis0, data.table)
  cis <- lapply(cis0, function(x) x[, df := NULL])
  cis <- lapply(cis, function(x) {
   dm <- data.frame(x[, -1])
   rownames(dm) <- as.character(unlist(x[, 1]))
   dm
   })
  tab <- tabs2latex4(cis, informat = "sattCI", outformat = OUTFORMAT, 
    xx.yyy = T, AddStarIntabstarP = ADDStar, CIIntinysize = T, 
    Pparenthesis = "brace", UseHTML = T)
  tab <- tab[grepl("^agHH.yr\\d|\\{agHH.yr\\d|nonm", rownames(tab)), ]
  vs <- c("^agHH.yr\\d", "n.*m.yr.$", "^no.*ag")
  nums <- NULL
  for (vv in vs) nums <- c(nums, grep(vv, rownames(tab))+0:plusrows)
  tab <- tab[nums, ]
  rn <- rownames(tab)
  tabmat <- as.matrix(tab)
  rownames(tabmat) <- rn
  Tab <- rbind(Tab, tab)
}
rn <- rownames(Tab)
rn[-seq(1, length(rn), 3)] <- ""
rn <- gsub("1$", "", rn)
rn <- gsub("22$", "2", rn)
rn <- gsub("m2$", "m", rn)
####  replace variable names, deleting std error names
for (k in 1:nrow(sbt)){
  if (any(grepl(sbt[k, "org"], rn))) 
    rn[grep(sbt[k, "org"], rn)] <- sbt[k, "changedto"]
}
rn <- gsub("\\\\hspace\\{.5em\\}", "    ", rn)
Tab <- cbind(covariates = rn, Tab)
Tab <- rbind(Tab, 
  "Thana fixed trends" = c("Thana fixed trends", "", "Y", "Y"),
  "HH fixed trends" = c("HH fixed trends", "", "", "Y"))
#### HTML output
library(kableExtra)
colnames(Tab) <- c("variables", "raw DID", "+covariates", "+HH trends")
Tab <- data.table(rbind(c(" ", 1:3), Tab))
kt <- kable(Tab, align = paste0("r", paste0(rep("c", ncol(Tab)-1), collapse = "")), 
  caption = 
  "Enrollment impacts with non Muslims: Year 1999-2002, 10-18 years old, direct offspring, Satterthwaite correction")
kt <- add_header_above(kt, c(" " = 1, "Boys+girls" = 3, "Boys" = 3, "Girls" = 3),
  background = bgcolor)
kt <- row_spec(kt, 0:1, align = paste0(rep("c", ncol(Tab)-1), collapse = ""), 
  background = "#ffcc99")
kt <- row_spec(kt, grep("Agri", Tab[, variables])+0:plusrows, bold = F, 
  color = "black", background = "#87cefa")
kt <- pack_rows(kt, group_label="Boys", grep("Agri", rn)[1], grep(" Non", rn)[1]+2)
kt <- pack_rows(kt, group_label="Girls", grep("Agri", rn)[2], grep(" Non", rn)[2]+2)
kt <- pack_rows(kt, group_label="Boys+Girls", grep("Agri", rn)[3], grep(" Non", rn)[3]+2)
kt <- scroll_box(kt, height = "800px")
ktM <- footnote(kt, 
           general = "Sample of direct offspring of household heads. ",
           number = c(SpecMemo1, SEMemoForSelectedResultsNoStarhtml)
           )
```
```{r show flooded results, eval = F}
#### results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]][[k]] 
ii <- jj <- s <- 1
j <- m <- clnum <- 2
Tab <- NULL
for (ge in 1:3) {
  cis0 <- lapply(resultsF[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci")
  cis0 <- lapply(cis0, data.table)
  cis <- lapply(cis0, function(x) x[, df := NULL])
  cis <- lapply(cis, function(x) {
   dm <- data.frame(x[, -1])
   rownames(dm) <- as.character(unlist(x[, 1]))
   dm
   })
  tab <- tabs2latex4(cis, informat = "sattCI", outformat = OUTFORMAT, 
    xx.yyy = T, Pparenthesis = "brace", UseHTML = T)
  vs <- c("^agHH.yr\\d", "flooded$", "^fl.*ag")
  nums <- NULL
  for (vv in vs) nums <- c(nums, grep(vv, rownames(tab))+0:plusrows)
  tab <- tab[nums, ]
  rn <- rownames(tab)
  tabmat <- as.matrix(tab)
  rownames(tabmat) <- rn
  Tab <- rbind(Tab, tab)
}
rn <- rownames(Tab)
rn[-seq(1, length(rn), 3)] <- ""
rn <- gsub("1$", "", rn)
rn <- gsub("22$", "2", rn)
rn <- gsub("d2$", "d", rn)
####  replace variable names, deleting std error names
for (k in 1:nrow(sbt)){
  if (any(grepl(sbt[k, "org"], rn))) 
    rn[grep(sbt[k, "org"], rn)] <- sbt[k, "changedto"]
}
rn <- gsub("\\\\hspace\\{.5em\\}", "    ", rn)
Tab <- cbind(covariates = rn, Tab)
Tab <- rbind(Tab, 
  "Thana fixed trends" = c("Thana fixed trends", "", "", ""),
  "HH fixed trends" = c("HH fixed trends", "", "", "Y"))
library(kableExtra)
colnames(Tab) <- c("variables", "raw DID", "+covariates", "+HH trends")
Tab <- data.table(rbind(c(" ", 1:3), Tab))
kt <- kable(Tab, align = paste0("r", paste0(rep("c", ncol(Tab)-1), collapse = "")), 
  caption = 
  "Enrollment impacts with flood dummy: Year 1999-2002, 10-18 years old, direct offspring, Satterthwaite correction")
kt <- add_header_above(kt, c(" " = 1, "Boys+girls" = 3, "Boys" = 3, "Girls" = 3),
  background = bgcolor)
kt <- row_spec(kt, 0:1, align = paste0(rep("c", ncol(Tab)-1), collapse = ""), 
  background = "#ffcc99")
kt <- row_spec(kt, grep("Agri", Tab[, variables])+0:plusrows, bold = F, 
  color = "black", background = "#87cefa")
kt <- pack_rows(kt, group_label="Boys", grep("Agri", rn)[1], grep(" Fl.*ag", rn)[1]+2)
kt <- pack_rows(kt, group_label="Girls", grep("Agri", rn)[2], grep(" Fl.*ag", rn)[2]+2)
kt <- pack_rows(kt, group_label="Boys+Girls", grep("Agri", rn)[3], grep(" Fl.*ag", rn)[3]+2)
kt <- scroll_box(kt, height = "800px")
ktF <- footnote(kt, 
           general = "Sample of direct offspring of household heads. ",
           number = c(SpecMemo1, SEMemoForSelectedResultsNoStarhtml)
           )
```
</details>

<details><summary>Click here to see the code of showing nonmuslim flooded results.</summary>
```{r show nonmuslim flooded results, eval = T}
#### Uses tabs2latex4
#### results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]][[k]] 
nR0 <- unique(NRFM[agelb == (10:12)[1] & grepl("hd", agdef) & grepl("^d", HHtype), ])
enr00 <- EnrFM[agelb == (10:12)[1] & grepl("B", inference) & 
  grepl("hd", agdef) & grepl("^d", HHtype), ]
enr00[, EnRate := formatC(EnRate, digits = 4, format = "f")]
ii <- jj <- s <- 1
j <- clnum <- 2
m <- 3
Tab <- rnames <- NULL
for (fm in 1:2) {   # flood or muslim
  nR <- nR0[grepl(c("mu", "fl")[fm], file), ]
  enr0 <- enr00[grepl(c("mu", "fl")[fm], file), ]
  if (fm == 1) {
    rFM <- resultsM 
    pickstr <- "^agHH.yr\\d|\\{agHH.yr\\d|nonm"
    vs <- c("^agHH.yr\\d", "n.*m.yr.$", "^no.*ag")
  } else {
    rFM <- resultsF
    pickstr <- "^agHH.yr\\d|\\{agHH.yr\\d|floo"
    vs <- c("^agHH.yr\\d", "flooded$", "^fl.*ag")
  }
  for (ge in 1:3) {
    cis0 <- lapply(rFM[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci")
    cis0 <- lapply(cis0, data.table)
    cis <- lapply(cis0, function(x) x[, df := NULL])
    cis <- lapply(cis, function(x) {
     dm <- data.frame(x[, -1])
     rownames(dm) <- as.character(unlist(x[, 1]))
     dm
     })
    tab0 <- tabs2latex4(cis, informat = "sattCI", outformat = OUTFORMAT, 
      xx.yyy = T, AddStarIntabstarP = ADDStar, CIIntinysize = T, 
      Pparenthesis = "brace", UseHTML = T)
    tab0 <- tab0[grepl(pickstr, rownames(tab0)), ]
    nums <- NULL
    for (vv in vs) nums <- c(nums, grep(vv, rownames(tab0))+0:plusrows)
    tab0 <- tab0[nums, ]
    nr <- rbind(
      formatC(nR[grepl(genderregexpr[ge], gender), ][
        order(spec), R], digits = 4, format = "f")
    , formatC(nR[grepl(aghh.defs[m], agdef) & grepl(genderregexpr[ge], gender), ][
        order(spec), Yes], digits = 0, format = "f")
    , formatC(nR[grepl(aghh.defs[m], agdef) & grepl(genderregexpr[ge], gender), ][
        order(spec), Ngroup], digits = 0, format = "f")
    , formatC(nR[grepl(aghh.defs[m], agdef) & grepl(genderregexpr[ge], gender), ][
        order(spec), n], digits = 0, format = "f")
    )
    enr <- matrix(
     enr0[grepl(aghh.defs[m], agdef) & grepl(genderregexpr[ge], gender), ][
       order(tee, agHH), EnRate], byrow = F, nrow = 4)
    enr <- data.table(enr[, rep(1, 3)])
    nr <- data.table(nr)
    nr[2:4, c(1, 3) := ""]
    enr[, c(1, 3) := ""]
    rn <- c(rownames(tab0), "R2", "N: agHH", "N: Muslims", "N", 
      paste0("mean of ", rep(c("control in ", "treated in "), 2), rep(c(1999, 2002), each = 2)))
    if (fm == 2) rn <- gsub("N: Muslims", "N: Flooded", rn)
    tab <- rbindlist(list(tab0, rbind(nr, enr)), use.names = F)
    tabmat <- as.matrix(tab)
    assign(paste0("t", fm, ge), tab)
    assign(paste0("t", ge), tab)
  }
  Tab0 <- cbind(t3, t1, t2)
  rnames <- c(rnames, rn)
  Tab <- rbind(Tab, Tab0)
}
rn <- rnames
####  replace variable names, deleting std error names
for (k in 1:nrow(sbt)){
  if (any(grepl(sbt[k, "org"], rnames))) 
    rnames[grep(sbt[k, "org"], rnames)] <- sbt[k, "changedto"]
}
rnames <- gsub("^\\\\hspace\\{.*\\}", "", rnames)
rnames <- gsub("^Agricultural household", "Agricultural household * year 2002", rnames)
rnames <- gsub("Number of ol", "Ol", rnames)
rnames <- gsub("female siblings", "sisters", rnames)
rnames <- gsub("male siblings", "brothers", rnames)
rnames <- gsub("Non.*m$", "Non-Muslim * year 2002", rnames)
rnames <- gsub("Flood$", "Flood * year 2002", rnames)
rnames <- gsub("Non.*HH", "$\\\\underline{\\\\phantom{mm}}$ * Ag HH", rnames)
rnames <- gsub("Flo.*HH", "$\\\\underline{\\\\phantom{mm}}$ * Ag HH", rnames)
rnames <- gsub("\\\\hspace\\{.5em\\}", "", rnames)
Tab <- as.matrix(cbind(covariates = rnames, Tab))
Tab <- rbind(Tab, 
  "Covariates, thana trends" = c("Covariates, thana trends", rep(c("", "", "Y"), 3)),
  "HH trends" = c("HH trends", rep(c("", "", "Y"), 3)))
#### LaTeX output
SepCols <- c(3, 6) 
ltb <- latextab(Tab, delimiterline = NULL, 
    hcenter = c(3.25, rep(1.5, ncol(Tab)-1)),
    hleft = c("\\scriptsize", rep("\\hfil\\scriptsize$", ncol(Tab)-1)), 
    hright = c("\\hfill", rep("$", ncol(Tab)-1)),
    headercolor = NULL, 
    adjustlineskip = "-.5ex", 
    adjlskiprows = rep(grep("CI", Tab[, 1]), each = plusrows)-(plusrows:1),
    addseparatingcols = SepCols, separatingcolwidth = rep(.1, length(SepCols)), 
    separatingcoltitle = c("\\textsf{Boys+girls}", "\\textsf{Boys}", "\\textsf{Girls}")
  ) 
ltb <- gsub("CI\\$.*\\$", "", ltb)
ltb <- gsub("p\\$.*\\$", "", ltb)
ltb <- gsub("se\\$.*\\$", "", ltb)
allcovrows <- which(grepl("\\w", ltb) & 
  !grepl("trend|^N|^R2|[mM]ea.*1999|[mM]ea.*200|^\\\\|^ ?\\&|CI|p\\$|\\\\bar", ltb))
for (i in allcovrows+2) ltb[i] <- gsub("\\{(.*?)\\}", "\\\\{\\1\\\\}", ltb[i])
ltb <- gsub("\\^\\\\\\{(.*?)\\\\\\}", "^\\{\\1\\}", ltb)
ltb <- gsub("(^\\\\cline.*$)", "\\1[-1ex]", ltb)
ltb <- gsub("household", "HH", ltb)
ltb <- gsub("R2", "$\\\\bar{R}^{2}$", ltb)
ltb <- ltb[!grepl("Raw", ltb)]
aghhrows <- grep("Agricu", ltb)
ltb <- c(
  ltb[1], "\\hline", 
  ltb[2:(aghhrows[1]-2)],
  "&\\multicolumn{11}{c}{\\scriptsize A. Non Muslims}\\\\",
  paste0("\\makebox[3.25cm]{Covariates}",
    paste0("&\\makebox[1.3cm]{(", 1:3, ")}", collapse = ""),
    "&",
    paste0("&\\makebox[1.3cm]{(", 3+1:3, ")}", collapse = ""),
    "&",
    paste0("&\\makebox[1.3cm]{(", 6+1:3, ")}", collapse = ""),
    "\\\\"),
  ltb[(aghhrows[1]):(aghhrows[2]-1)],
  "&\\multicolumn{11}{c}{\\scriptsize B. Flooded}\\\\",
  paste0("\\makebox[3.25cm]{Covariates}",
    paste0("&\\makebox[1.3cm]{(", 9+1:3, ")}", collapse = ""),
    "&",
    paste0("&\\makebox[1.3cm]{(", 9+3+1:3, ")}", collapse = ""),
    "&",
    paste0("&\\makebox[1.3cm]{(", 9+6+1:3, ")}", collapse = ""),
    "\\\\"),
  ltb[aghhrows[2]:(length(ltb)-3)],
  "\\multicolumn{11}{l}{\\scriptsize Common specifications}\\\\",
  ltb[(length(ltb)-2):(length(ltb)-1)],
  "\\hline", ltb[length(ltb)]
  )
write.tablev(ltb
  ,  paste0("../save/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "MuslimFloodResults.tex")
  ,  colnamestrue = F)
aghhrows <- grep("[A-Z]\\. ", ltb)
ltb1 <- c(ltb[1:(aghhrows[2]-1)], ltb[length(ltb)-4:0])
ltb2 <- c(ltb[1:grep("cline", ltb)], ltb[(aghhrows[2]):length(ltb)])
write.tablev(ltb1
  ,  paste0("../save/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "MuslimFloodResults1.tex")
  ,  colnamestrue = F)
write.tablev(ltb2
  ,  paste0("../save/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "MuslimFloodResults2.tex")
  ,  colnamestrue = F)
#### More concise table for main text
aghhrows <- grep("Agricultural", ltb)
r2rows <- grep("bar.R", ltb)
ltb4 <- ltb[
    c(1:(aghhrows[1]+8), r2rows[1]+c(0, 2, 3:6),
       aghhrows[2]+(-2:8), r2rows[2]+c(0, 2, 3:6), length(ltb)-4:0)
    ]
write.tablev(ltb4
  ,  paste0("../save/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "MuslimFloodResultsConcise.tex")
  ,  colnamestrue = F)
write.tablev(ltb4
  ,  paste0("../draft/Tables/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "MuslimFloodResultsConcise.tex")
  ,  colnamestrue = F)
#### HTML output
Tab[, 1] <- gsub("CI\\$.*\\$", "", Tab[, 1])
Tab[, 1] <- gsub("p\\$.*\\$", "", Tab[, 1])
Tab[, 1] <- gsub("se\\$.*\\$", "", Tab[, 1])
Tab[, 1] <- gsub("\\\\hspace\\{.*?\\}", "", Tab[, 1])
Tab[, 1] <- gsub("1$", "", Tab[, 1])
Tab[, 1] <- gsub("22$", "2", Tab[, 1])
Tab[, 1] <- gsub("m2$", "m", Tab[, 1])
colnames(Tab) <- c("variables", rep(c("raw DID", "+covariates", "+HH trends"), 3))
for (iii in 2:ncol(Tab)) {
  Tab[, iii] <- gsub("\\\\mbox\\{\\\\tiny ?(.*)\\}", "\\1", Tab[, iii])
  Tab[, iii] <- gsub("\\\\phantom\\{.*?\\}", "", Tab[, iii])
  Tab[, iii] <- gsub("\\^\\{(.*)\\}", "", Tab[, iii])
}
aghhrows <- grep("Agri", Tab[, 1])
Tab <- rbind(
  t(c("", 1:(ncol(Tab)-1))), Tab[1:(aghhrows[2]-1), ],
  c("", ncol(Tab)+1:(ncol(Tab)-1)), Tab[aghhrows[2]:nrow(Tab), ]
  )
library(kableExtra)
bgcolor <- "#ffcc99"
aghhrows <- grep("Agri", Tab[, 1])
kt <- kable(data.table(Tab), align = paste0("r", paste0(rep("c", ncol(Tab)-1), collapse = "")), 
  caption = 
  "Enrollment impacts with non Muslims and flood: Year 1999-2002, 10-18 years old, direct offspring, Satterthwaite correction")
kt <- add_header_above(kt, c(" " = 1, "Boys+girls" = 3, "Boys" = 3, "Girls" = 3),
  background = bgcolor)
kt <- row_spec(kt, 0:1, align = paste0(rep("c", ncol(Tab)-1), collapse = ""), 
  background = bgcolor)
kt <- row_spec(kt, 
  rep(aghhrows, each = plusrows+1)+rep(0:plusrows, length(aghhrows)), 
  bold = F, color = "black", background = "#87cefa")
kt <- row_spec(kt, grep("Ag|^Non|^Fl", Tab[, "variables"])+plusrows, font_size = 11)
kt <- column_spec(kt, 1, width = "6cm; min-width:6cm;")
kt <- column_spec(kt, 2:10, width = "2.25cm; min-width:2.25cm;")
kt <- pack_rows(kt, group_label="Non Muslims", aghhrows[1]-1, aghhrows[2]-2)
kt <- pack_rows(kt, group_label="Flooded", aghhrows[2]-1, grep("^Co", Tab[, 1])-1)
kt <- pack_rows(kt, group_label="Common specifications", grep("^Co", Tab[, 1]), grep("HH tr", Tab[, 1]))
kt <- scroll_box(kt, height = "800px")
kt <- footnote(kt, 
           general = "Sample of direct offspring of household heads. ",
           number = c(SpecMemoNonMuslimFloodhtml, SEMemoForSelectedResultsNoStarhtml)
           )
qsave(kt, paste0("../save/", c("M", "P")[ii], c(9, 2)[jj], (10:12)[s], "MuslimFloodH.qs"))
rm(rFM)
rm(resultsM)
rm(resultsF)
```
</details>
```{r, echo = F}
kt
```

* Verdict: Main estimates do not change when we control for Non-Muslims or flooded areas.  
* Neither non-Muslim interaction terms nor flood interaction terms have small $p$ values. 
* There is <Blue>no evidence that the main estimates are due to fasting or festivities related to Ramadan.</Blue>  
* There is <Blue>no evidence that the main estimates are due to damages related to flood.</Blue>  
* Non-Muslim boys seem to reduce enrollment rates after the Ramadan-harvest overlap ends (small net negative estimates on non-Muslim * 2002 and non-Muslim * agHH * 2002) when they are not affected by festivity or fasting related confounders. Whatever the negative confounder is at work, it affects less on Muslims and more on non-Muslims. But the estimates are imprecise and nothing conclusive can be drawn.  
* Girls of non-agricultural households in flooded areas decrease enrollment rates (they increase in agricultural households although the $p$ values are not small).  

## Other schooling outcomes: Grade progression and days absent per month


<details><summary>Click here to see the code of showing num grades and days absent.</summary>
```{r read num grades days absent results, eval = T, warning = F}
resultsG <- qread("../save/DID2024_NumGradesEnrollersGenderResults.qs")
resultsD <- qread("../save/DID2024_DaysAbsentEnrollersGenderResults.qs")
resultsC <- qread("../save/DID2024_DaysAbsentCrossSectionResults.qs")
```

```{r show num grades days absent results, eval = T}
#### Uses tabs2latex4
####resultsG[[ii]][[jj]][[en]][[s]][[j]][[ge]][[m]][[clnum]][[k]]
####resultsD[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]][[k]]
####resultsC[[ii]][[jj]][[yy]][[rr]][[s]][[j]][[ge]][[m]], rr, yy = 1, 2
#### resultsG <- qread("save/DID2024_NumGradesEnrollersGenderResults.qs")
#### resultsD <- qread("save/DID2024_DaysAbsentEnrollersGenderResults.qs")
#### resultsC <- qread("save/DID2024_DaysAbsentCrossSectionResults.qs")
#### NRGD <- qread("save/GenderGradeDaysAbsentTabulatedNR2024.qs")
#### EnrGD <- qread("save/GenderGradeDaysAbsentTabulatedEnr2024.qs")
#### For keeping NR and Enr to up to date, need to run the chunk
####   "tabulate grade absent by gender results"
NRGD <- qread("../save/GenderGradeDaysAbsentTabulatedNR2024.qs")
EnrGD <- qread("../save/GenderGradeDaysAbsentTabulatedEnr2024.qs")
nR0 <- unique(NRGD[agelb == (10:12)[1] & grepl("hd", agdef) & grepl("^d", HHtype), ])
Enr0 <- unique(EnrGD[agelb == (10:12)[1] & grepl("hd", agdef) & grepl("^d", HHtype), ])
Enr0[, EnRate := formatC(EnRate, digits = 4, format = "f")]
aghh.defs2 <- aghh.defs[c(3, 2, 4, 1)]
Aghh.defs2 <- Aghh.defs[c(3, 2, 4, 1)]
Enr0[, agdef := factor(agdef, levels = aghh.defs2)]
nR0[, agdef := factor(agdef, levels = aghh.defs2)]
setorder(nR0, agdef)
setorder(Enr0, tee, agdef)
gdcode <- c("NIP", "NCP", "DCP", "DCC", "DCA")
#### NIP: num grade, incomplete panel
#### NCP: num grade, complete panel
#### DCP: days absent, incomplete panel
#### DCC: days absent, cross section current enrollers (year 2000 and 2003)
#### DCA: days absent, cross section all time enrollers (year 2000 and 2003)
jj <- en <- s <- 1
j <- clnum <-  2
m <- 3 
#### enrs <- c("initial", "all time", "others")[en]
#### rr=2: Enrolled in both peirods
rylast <- c(1, 1, 1, 2, 2)
Tab <- NULL
tabnum <- 0
for (ii in 1:2) {
#### ii 1: main estimates, 2: placebo estimates
#### jj 1: 2002 cohort for placebo
  Tab0 <- NULL
  for (gd in 1:5) {
    #gd 1: NumGrade 1999 enrollers, 2: NumGrade complete panel enrollers, 
    #    3: DaysAbsent 1999 enrollers, 4: DaysAbsent OLS current enrollers
    #    5: DaysAbsent OLS always enrollers
    # DaysAbsent panel on always enrollers: 
    #   both stipend program and nonstipend program are used
    #   see regressorsM2024
    # DaysAbsent OLS current enrollers and always enrollers: 
    #   only stipend program used, nonstipend program not used
    #   see regressorsM2024Apr10
    # Placebo is estimated only for NumGrades. No DaysAbsent data collected in 2006.
      # For gd = 2, 3, always enrollers => rr = 2. (rr = 1 does not exist.)
      # For gd >= 4, rr=1: current enrollers, rr=2: always enrollers
      # Year 2002 impacts are only for cross sections. Panel estimates (gd < 4) needs to skip
    # gd = 1: ii = 1, 2, yy = 1,     rr = 1
    # gd = 2: ii = 1, 2, yy = 1,     rr = 2
    # gd = 3: ii = 1,     yy = 1,     rr = 2
    # gd = 4: ii = 1,     yy = 1, 2, rr = 1
    # gd = 5: ii = 1,     yy = 1, 2, rr = 2
    if (gd > 2 & ii == 2) next
    Tab00 <- NULL
    for (rr in 1:2) {
      if (gd == 1 & rr == 2) next
      if ((gd == 2 | gd == 3) & rr == 1) next
      if (gd == 4 & rr == 2) next
      if (gd == 5 & rr == 1) next
      Tab000 <- NULL
      for (yy in 1:2) { 
      # For gd == 4, yy = 2 (2002, July-August, asked in Sep-Oct) covers 
      # 2 months of planting season absenteeism in a 3 month recall question.
        if (gd < 4 & yy == 2) next
        Tab0000 <- NULL
        for (ge in c(3, 1, 2)) {
          if (gd < 3) 
            cis0 <- lapply(resultsG[[ii]][[jj]][[gd]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci") else
          if (gd == 3) 
            cis0 <- lapply(resultsD[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci") else
            cis0 <- lapply(resultsC[[ii]][[jj]][[yy]][[rr]][[s]][[j]][[ge]][[m]], "[[", "ciBRL")
          cis0 <- lapply(cis0, data.table)
          cis <- lapply(cis0, function(x) x[, df := NULL])
          cis <- lapply(cis, function(x) {
           dm <- data.frame(x[, -1])
           rownames(dm) <- as.character(unlist(x[, 1]))
           dm
           })
          tab <- tabs2latex4(cis, informat = "sattCI", outformat = OUTFORMAT, 
            xx.yyy = T, AddStarIntabstarP = ADDStar, CIIntinysize = T, 
            Pparenthesis = "brace", UseHTML = T)
          tab <- tab[grepl("^agHH.yr\\d|\\{agHH.yr\\d|^agHH$|\\{agHH\\}|Prog", rownames(tab)), ]
          vs <- c("^agHH", "^Sti", "^NonS")
          nums <- NULL
          for (vv in vs) nums <- c(nums, grep(vv, rownames(tab))+0:plusrows)
          tab0 <- tab[nums, ]
          rn <- rownames(tab0)
          #rn[grepl("^CI|^p", rn)] <- ""
          assign(paste0("rn", gd, ii),  rn)
          if (gd >= 4) {
            nR <- nR0[CrossSecEnrollers == c("AtLeastOnce", "BothPeriods")[rr], ] 
            enr0 <- Enr0[CrossSecEnrollers == c("AtLeastOnce", "BothPeriods")[rr], ] 
          } else {
            nR <- nR0
            enr0 <- Enr0
          }
          if (gd < 4) {
            nr <- rbind(
              formatC(nR[file == gdfiles[gd] & grepl(genderregexpr[ge], gender), ][
                order(reg), R], digits = 4, format = "f")
            , formatC(nR[file == gdfiles[gd] & grepl(genderregexpr[ge], gender), ][
                order(reg), Yes], digits = 0, format = "f")
            , formatC(nR[file == gdfiles[gd] & grepl(genderregexpr[ge], gender), ][
                order(reg), n], digits = 0, format = "f")
            ) 
            enronumrows <- 4
            enr <- matrix(
              enr0[file == gdfiles[gd] & grepl(genderregexpr[ge], gender) &
                CrossSecYear == c(1999, 2002)[yy], ][
                order(tee, agHH), EnRate], byrow = F, nrow = enronumrows)
          } else {
            nr <- rbind(
              formatC(nR[file == gdfiles[gd] & grepl(genderregexpr[ge], gender) &
                CrossSecYear == c(1999, 2002)[yy] & 
                CrossSecEnrollers == c("AtLeastOnce", "BothPeriods")[rr], ][
                order(reg), R], digits = 4, format = "f")
            , formatC(nR[file == gdfiles[gd] & grepl(genderregexpr[ge], gender) &
                CrossSecYear == c(1999, 2002)[yy] & 
                CrossSecEnrollers == c("AtLeastOnce", "BothPeriods")[rr], ][
                order(reg), Yes], digits = 0, format = "f")
            , formatC(nR[file == gdfiles[gd] & grepl(genderregexpr[ge], gender) &
                CrossSecYear == c(1999, 2002)[yy] & 
                CrossSecEnrollers == c("AtLeastOnce", "BothPeriods")[rr], ][
                order(reg), n], digits = 0, format = "f")
            )
            enronumrows <- 2
            enr <- matrix(
              enr0[file == gdfiles[gd] & grepl(genderregexpr[ge], gender) &
                CrossSecYear == c(1999, 2002)[yy] & 
                CrossSecEnrollers == c("AtLeastOnce", "BothPeriods")[rr], ][
                order(tee, agHH), EnRate], byrow = F, nrow = enronumrows)
          }
          enr <- data.table(enr[, rep(1, 3)])
          nr <- data.table(nr)
          nr[2:3, c(1, 3) := ""]
          enr[, c(1, 3) := ""]
          tab2 <- rbindlist(list(tab0, rbind(nr, enr)), use.names = F)
          assign(
              paste0(c("M", "P")[ii], gdcode[gd], c("b", "g", "bg")[ge], c("CU", "AL")[rr], c(9, 2)[yy]) 
            # N: NumGrade, D: DaysAbsent
            # IP: incomplete panel (1999 enrollers), CP: complete panel (1999 and 2002 enrollers)
            # CS: cross section
            , tab2)
          Tab0000 <- cbind(Tab0000, tab2)
        } # ge
        tabnum <- tabnum + ncol(Tab0000)
        if (ii == 1 & gd == 1) tabnum <- 0
        colnum <- max(tabnum)+1:ncol(Tab0000)
        Tab0000 <- rbind(t(matrix(colnum)), Tab0000, use.names = F) 
        assign(
            paste0(c("M", "P")[ii], gdcode[gd], c("CU", "AL")[rr], c(9, 2)[yy]) 
          , Tab0000)
        Tab000 <- rbind(Tab000, Tab0000)
      } # yy
      assign(
          paste0(c("M", "P")[ii], gdcode[gd], c("CU", "AL")[rr]) 
        , Tab000)
      Tab00 <- rbind(Tab00, Tab000)
    } # rr
    assign(
        paste0(c("M", "P")[ii], gdcode[gd]) 
      , Tab00)
    Tab0 <- rbind(Tab0, Tab00)
    ####cat("ii", ii, "gd", gd,  "dim", dim(Tab00), "\n")
  } # gd
  assign(
      paste0("ND", c("M", "P")[ii]) 
    , Tab0)
  Tab <- rbind(Tab, Tab0)
} # ii
r2n1 <- c("R2", "N: agHH", "N", 
  paste0("Mean of ", rep(c("control in ", "treated in "), 2), rep(c(1999, 2002), each = 2)))
r2n2 <- c("R2", "N: agHH", "N", 
  paste0("Mean of ", rep(c("control in ", "treated in "), 2), rep(c(2002, 2006), each = 2)))
r2ncross9 <- c("R2", "N: agHH", "N", paste0("Mean of ", c("control in ", "treated in "), 1999))
r2ncross2 <- c("R2", "N: agHH", "N", paste0("Mean of ", c("control in ", "treated in "), 2002))
#### main
#### num grades, incomplete and complete panel
rnm11 <- c(" ", rn11, r2n1)
rnm21 <- c(" ", rn21, r2n1)
#### days absent, complete panel
rnm31 <- c(" ", rn31, r2n1)
#### days absent, OLS, current enrollers, 1999, 2002
rnm41 <- c(" ", rn41, r2ncross9)
rnm42 <- c(" ", rn41, r2ncross2)
#### days absent, OLS, always enrollers, 1999, 2002
rnm51 <- c(" ", rn51, r2ncross9)
rnm52 <- c(" ", rn51, r2ncross2)
#### placebo: use rn41 not rn21 or rn22
rnm12 <- c(" ", rn22, r2n2)
rnm22 <- c(" ", rn22, r2n2)
rnm <- c(rnm11, rnm21, rnm31, rnm41, rnm42, rnm51, rnm52, rnm12, rnm22)
####  replace variable names, deleting std error names
for (k in 1:nrow(sbt)){
  if (any(grepl(sbt[k, "org"], rnm))) 
    rnm[grep(sbt[k, "org"], rnm)] <- sbt[k, "changedto"]
}
rnm <- gsub("\\\\hspace\\{.5em\\}", "    ", rnm)
Tab <- as.matrix(cbind(covariates = rnm, Tab))
Tab <- rbind(Tab, 
  "Covariates, thana trends" = c("Covariates, thana trends", rep(c("", "Y", "Y"), 3)),
  "HH trends" = c("HH trends", rep(c("", "", "Y"), 3)))
TabGD = copy(Tab)
#### LaTeX output
SepCols <- c(3, 6) 
ltb <- latextab(Tab, delimiterline = NULL, 
    hcenter = c(4.0, rep(1.3, ncol(Tab)-1)),
    hleft = c("\\scriptsize", rep("\\hfil\\scriptsize$", ncol(Tab)-1)), 
    hright = c("\\hfill", rep("$", ncol(Tab)-1)),
    headercolor = NULL, 
    adjustlineskip = "-.5ex", 
    adjlskiprows = rep(grep("CI", Tab[, 1]), each = plusrows)-(plusrows:1),
    addseparatingcols = SepCols, separatingcolwidth = rep(.1, length(SepCols)), 
    separatingcoltitle = c("\\textsf{Boys+girls}", "\\textsf{Boys}", "\\textsf{Girls}")
  ) 
paneltitles <- c(
  "Grade progression: Students enrolled in 1999", 
  "Grade progression: Students enrolled in 1999 and 2002", 
  "Days absent: Students enrolled in 1999 and 2002", 
  "Days absent: Students enrolled in 1999, cross section OLS of 2000", 
  "Days absent: Students enrolled in 2002, cross section OLS of 2003", 
  "Days absent: Students enrolled in 1999 and 2002, cross section OLS of 2000", 
  "Days absent: Students enrolled in 1999 and 2002, cross section OLS of 2003", 
  "Grade progression: Placebo estimation of 2002 cohort enrolled in 2002", 
  "Grade progression: Placebo estimation of 1999 cohort enrolled in 2002", 
  "Common specifications")
for (iii in 1:(length(paneltitles)-1)) {
  aghhrows <- grep("Agri", ltb)
  ltb <- c(
      ltb[1:(aghhrows[iii]-2)],
      paste0("&\\multicolumn{11}{c}{\\scriptsize  ", LETTERS[iii], ". ", paneltitles[iii], "}\\\\"),
      ltb[(aghhrows[iii]-1):length(ltb)]
    )
}
ltb <- c(
    ltb[1:(grep("Cov.*ana", ltb)-1)],
    "\\multicolumn{12}{l}{\\scriptsize Common specifications}\\\\",
    ltb[(grep("Cov.*ana", ltb)):length(ltb)]
  )
ltb <- gsub("CI\\$.*\\$", "", ltb)
ltb <- gsub("p\\$.*\\$", "", ltb)
ltb <- gsub("se\\$.*\\$", "", ltb)
allcovrows <- which(grepl("\\w", ltb) & 
  !grepl("trend|^N|^R2|[mM]ea.*1999|[mM]ea.*200|^\\\\|^ ?\\&|CI|p\\$|\\\\bar", ltb))
for (i in allcovrows+2) ltb[i] <- gsub("\\{(.*?)\\}", "\\\\{\\1\\\\}", ltb[i])
ltb <- gsub("\\^\\\\\\{(.*?)\\\\\\}", "^\\{\\1\\}", ltb)
ltb <- gsub("(^\\\\cline.*$)", "\\1[-1ex]", ltb)
ltb <- gsub("household", "HH", ltb)
ltb <- gsub("Y", "\\\\mbox{Y}", ltb)
ltb <- ltb[!grepl("Raw", ltb)]
ltb <- ltb[!grepl("NA", ltb)]
ltb <- gsub(".* 1 .* 3 .* 5 .* 6.*", "&(1)&(2)&(3)&&(4)&(5)&(6)&&(7)&(8)&(9)\\\\\\\\", ltb)
ltb <- gsub(".* 10 .* 13 .* 15 .* 16.*", "&(10)&(11)&(12)&&(13)&(14)&(15)&&(16)&(17)&(18)\\\\\\\\", ltb)
ltb <- gsub(".* 19 .* 20 .* 21 .* 23.*", "&(19)&(20)&(21)&&(22)&(23)&(24)&&(25)&(26)&(27)\\\\\\\\", ltb)
ltb <- gsub(".* 28 .* 29 .* 31 .* 33.*", "&(28)&(29)&(30)&&(31)&(32)&(33)&&(34)&(35)&(36)\\\\\\\\", ltb)
ltb <- gsub(".* 37 .* 39 .* 41 .* 43.*", "&(37)&(38)&(39)&&(40)&(41)&(42)&&(43)&(44)&(45)\\\\\\\\", ltb)
ltb <- gsub(".* 46 * 49 .* 51 .* 53 .*", "&(46)&(47)&(48)&&(49)&(50)&(51)&&(52)&(53)&(54)\\\\\\\\", ltb)
ltb <- gsub(".* 56 * 59 .* 61 .* 63 .*", "&(55)&(56)&(57)&&(58)&(59)&(60)&&(61)&(62)&(63)\\\\\\\\", ltb)
ltb <- gsub(".* 65 * 68 .* 70 .* 72 .*", "&(64)&(65)&(66)&&(67)&(68)&(69)&&(70)&(71)&(72)\\\\\\\\", ltb)
ltb <- gsub(".* 74 * 77 .* 79 .* 80 .*", "&(73)&(74)&(75)&&(76)&(77)&(78)&&(79)&(80)&(81)\\\\\\\\", ltb)
ii <- jj <- en <- s <- 1
j <- clnum <- rr <- 2
m <-  3
write.tablev(ltb
  ,  paste0("../save/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "NumGradeDaysAbsentAllResults.tex")
  ,  colnamestrue = F)
```

```{r show num grades days absent results concise, eval = T}
#### Used tabs2latex4
#### LaTeX output: Results shown in main texts
#### paste0(c("M", "P")[ii], c("NIP" "NCP" "DCP" "DCC" "DCA")[gd], 
####   c("b", "g", "bg")[ge], c("CU", "AL")[rr], c(9, 2)[yy]) 
row1 <- MNIPbgCU9 # Main NumGrade incomplete panel boys+girls 1999
setnames(row1, as.character(1:ncol(row1)))
row1 <- data.table(rbind(1:3, as.matrix(row1)))
row2 <- cbind(MNCPbgAL9, MDCPbgAL9) # Main NumGrade DaysAbsent comp panel boys+girls 1999, 2002
setnames(row2, as.character(1:ncol(row2)))
row2 <- data.table(rbind(3+1:ncol(row2), as.matrix(row2)))
row3 <- MDCCbgCU9 # Main DaysAbsent cross section, current enrollers boys+girls 1999
setnames(row3, as.character(3+1:ncol(row3)))
row3 <- data.table(rbind(9+1:ncol(row3), as.matrix(row3)))
row4 <- MDCCbgCU2 # Main DaysAbsent cross section, current enrollers boys+girls 2002
setnames(row4, as.character(3+1:ncol(row4)))
row4 <- data.table(rbind(12+1:ncol(row4), as.matrix(row4)))
MNDbg <- rbindlist(list(row1, row2, row3, row4), use.names = T, fill = T) # Bind all
rnm <- c("", rn11, r2n1, "", rn11, r2n1, "", rn41, r2ncross9, "", rn41, r2ncross2)
####  replace variable names, deleting std error names
for (k in 1:nrow(sbt)){
  if (any(grepl(sbt[k, "org"], rnm))) 
    rnm[grep(sbt[k, "org"], rnm)] <- sbt[k, "changedto"]
}
rnm <- gsub("Number of ol", "Ol", rnm)
MNDbg <- as.matrix(cbind(rnm, MNDbg))
iii <- grep("^Stipend|^Non", MNDbg)
MNDbg <- MNDbg[-(rep(iii, each = plusrows+1)+0:plusrows), ]
MNDbg <- rbind(MNDbg, 
  "Covariates, thana trends" = c("Covariates, thana trends", rep(c("", "Y", "Y"), 2)),
  "HH trends" = c("HH trends", rep(c("", "", "Y"), 2)))
SepCols <- c(3) 
ltb <- latextab(MNDbg, delimiterline = NULL, 
    hcenter = c(4, rep(1.5, ncol(MNDbg)-1)),
    hleft = c("\\scriptsize", rep("\\hfil\\scriptsize$", ncol(MNDbg)-1)), 
    hright = c("\\hfill", rep("$", ncol(MNDbg)-1)),
    headercolor = NULL, 
    adjustlineskip = "-.5ex", 
    adjlskiprows = rep(grep("CI", MNDbg[, 1]), each = plusrows)-(plusrows:1),
    addseparatingcols = SepCols, separatingcolwidth = rep(.1, length(SepCols)), 
    separatingcoltitle = c("\\textsf{Grade progression}", "\\textsf{Days absent}")
  ) 
ltb <- ltb[!grepl("rnm", ltb)]
paneltitles <- c(
  "Students enrolled in 1999", 
  "Students enrolled in 1999 and 2002", 
  "Students enrolled in 1999, cross section OLS of 2000", 
  "Students enrolled in 2002, cross section OLS of 2003", 
  "Common specifications")
for (iii in 1:(length(paneltitles)-1)) {
  aghhrows <- grep("Agri", ltb)
  ltb <- c(
      ltb[1:(aghhrows[iii]-2)],
      paste0("&\\multicolumn{7}{c}{\\scriptsize ", LETTERS[iii], ". ", paneltitles[iii], "}\\\\"),
      ltb[(aghhrows[iii]-1):length(ltb)]
    )
}
ltb <- c(
    ltb[1], "\\hline", 
    ltb[2:(grep("Cov.*ana", ltb)-1)],
    "\\multicolumn{8}{l}{\\scriptsize Common specifications}\\\\",
    ltb[(grep("Cov.*ana", ltb)):(length(ltb)-1)],
    "\\hline", ltb[length(ltb)]
  )
ltb <- gsub("NA", "", ltb)
ltb <- gsub("se\\$.*\\$", "", ltb)
ltb <- gsub("CI\\$.*\\$|p\\$.*\\$|^se\\$.*", "", ltb)
ltb <- gsub("R2", "$\\\\bar{R}^{2}$", ltb)
ltb <- gsub("(^\\\\cline.*$)", "\\1[-1ex]", ltb)
ltb <- gsub("household", "HH", ltb)
ltb <- gsub("Y", "\\\\mbox{Y}", ltb)
ltb <- gsub("NA", "", ltb)
ltb <- gsub("^\\\\hspace\\{.*?\\}", "", ltb)
allcovrows <- which(grepl("\\w", ltb) & 
  !grepl("trend|^N|^R2|[mM]ea.*1999|[mM]ea.*200|^\\\\|^ ?\\&|CI|p\\$|\\\\bar", ltb))
for (i in allcovrows+2) ltb[i] <- gsub("\\{(.*?)\\}", "\\\\{\\1\\\\}", ltb[i])
ltb <- gsub("\\^\\\\\\{(.*?)\\\\\\}", "^\\{\\1\\}", ltb)
ltb <- gsub("(Cov.*ana trend)", "\\\\hspace{.5em}\\1", ltb)
ltb <- gsub("(HH trend)", "\\\\hspace{.5em}\\1", ltb)
ltb <- ltb[!grepl("Raw", ltb)]
ltb <- gsub(".* 1 .* 2 .* 3.*", "&(1)&(2)&(3)&&&&\\\\\\\\", ltb)
ltb <- gsub(".* 4 .* 5 .* 6 .* 7 .*", "&(4)&(5)&(6)&&(7)&(8)&(9)\\\\\\\\", ltb)
ltb <- gsub(".* 10 .* 11 .* 12.*", "&&&&&(10)&(11)&(12)\\\\\\\\", ltb)
ltb <- gsub(".* 13 .* 14 .* 15.*", "&&&&&(13)&(14)&(15)\\\\\\\\", ltb)
ii <- jj <- en <- s <- m <-  1
j <- clnum <- rr <- 2
write.tablev(ltb
  ,  paste0("../save/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "NumGradeDaysAbsentResults.tex")
  ,  colnamestrue = F)
write.tablev(ltb
  ,  paste0("../draft/Tables/", c("Main", "Placebo")[ii], "Older", (10:12)[s], 
       "NumGradeDaysAbsentResults.tex")
  ,  colnamestrue = F)
#### HTML output
library(kableExtra)
Tab <- MNDbg
colnames(Tab) <- c("variables", rep(c("raw DID", "+covariates", "+HH trends"), 2))
Tab[, 1] <- gsub("CI\\$.*\\$", "", Tab[, 1])
Tab[, 1] <- gsub("p\\$.*\\$", "", Tab[, 1])
Tab[, 1] <- gsub("se\\$.*\\$", "", Tab[, 1])
Tab[, 1] <- gsub("(^\\\\cline.*$)", "\\1[-1ex]", Tab[, 1])
Tab[, 1] <- gsub("household", "HH", Tab[, 1])
Tab[, 1] <- gsub("\\\\hspace\\{.*\\}", "", Tab[, 1])
Tab[, 1] <- Tab[, 1][!grepl("Raw", Tab[, 1])]
for (iii in 2:ncol(Tab)) {
  Tab[, iii] <- gsub("\\\\mbox\\{\\\\tiny ?(.*)\\}", "\\1", Tab[, iii])
  Tab[, iii] <- gsub("\\\\phantom\\{.*?\\}", "", Tab[, iii])
  Tab[, iii] <- gsub("\\^\\{(.*)\\}", "", Tab[, iii])
}
if (any(is.na(Tab))) Tab[is.na(Tab)] <- ""
bgcolor <- "#ffcc99"
Tab <- data.table(Tab)
kt <- kable(Tab, align = paste0("r", paste0(rep("c", ncol(Tab)-1), collapse = "")),
  caption = 
  "Other outcome impacts: 10-18 years old, direct offspring, Satterthwaite correction")
kt <- add_header_above(kt, c(" " = 1, "Grade progression" = 3, "Days absent" = 3),
  background = bgcolor)
allcovrows <- which(grepl("\\w", Tab[, variables]) & 
  !grepl("trend|^N$|^N:|^R2|200|199", Tab[, variables]))
kt <- row_spec(kt, allcovrows+plusrows, font_size = 11)
kt <- row_spec(kt, 0, align = paste0(rep("c", ncol(Tab)), collapse = ""), 
  background = bgcolor)
aghhrows <- grep("Agri", Tab[, variables])
kt <- row_spec(kt, 
  rep(aghhrows, each = plusrows+1)+rep(0:plusrows, length(aghhrows)), 
  bold = F, color = "black", background = "#87cefa")
kt <- column_spec(kt, 1, width = "6cm; min-width:6cm;")
kt <- column_spec(kt, 2:7, width = "2.25cm; min-width:2.25cm;")
RowGenderGroupCSS <- "background-color: #666; color: #fff;"
packrowtext <- c(
  "Students enrolled in 1999", 
  "Students enrolled in 1999 and 2002", 
  "Students enrolled in 1999, cross section OLS of 2000")
for (iii in 1:length(packrowtext))
  kt <- pack_rows(kt, group_label=packrowtext[iii], 
  aghhrows[iii]-1, aghhrows[iii+1]-1)
kt <- pack_rows(kt, group_label="Students enrolled in 2002, cross section OLS of 2003", 
  aghhrows[length(packrowtext)+1]-1, grep("Cov.*ana", Tab[, variables])-1)
kt <- pack_rows(kt, group_label="Common specifications", 
  grep("Cov.*ana", Tab[, variables]), grep("HH tr", Tab[, variables]))
kt <- scroll_box(kt, height = "800px")
kt <- footnote(kt, 
           general = "Sample of direct offspring of household heads. ",
           number = c(SpecMemo1, SEMemoForSelectedResultsNoStarhtml)
           )
```
</details>
```{r, echo = F}
kt
```

* Grade progreesion and days absent impacts are consistent with main results.  
* <Blue>Grade progression impact estimates are negative.</Blue> Exam-harvest overlap delays progression by .46 years (`r round((c(.46))*12, 2)` months).   
* One year impact: As the calendar was favorable in 1999-2001, we consider these estimates as a one year impact because the negative effects were realised only in the academic year of 2002 which were captured in the survey in 2003.   
* What this means: <Blue>Even when the children of agricultural households are not dropping out of school, at least a quarter of them lag behind in grade progression</Blue> relative to the children of non-agricultural households.  
* Point estimates are larger in magnitude for boys (see [Appendix table](#NumGradeDaysAbsentResults)).  
* <Blue>Absence impact estimates are noisy</Blue> at best. 
* They increase about .56-.82 day per month by panel estimates. A monthly 1.5 - 2.9 day increase in cross sectional estimates in 2000 (using enrollers of 1999 and 2002), .54 - .62 day increase in cross sectional estimates in 2003 (using enrollers of 1999 and 2002).  
* A possible reason for the small magnitude on days absent is attenuation. This variable reports a three month recall, so the interview dates for some households may be off harvesting periods, therefore it may contain measurement errors. The survey asks about the days absent of June - August of respective years, which coincide with July-August planting period.  



# Appendix figures and tables

## Full results

<a name="FullResultsMain">Results for boys and girls.</a>

For [a more concise table](#ResultsTableMain), refer to the main text.

<details><summary>Click here to see the code of showing full results.</summary>
```{r ShowMainResults, eval = T, warning = F, warning = F}
#### Uses tabs2latex4
##### results <- qread("../save/DID2024_MainResults.qs")
jj <- s <- de <- 1
j <- clnum <- 2
m <- 3
ii <- 1
for (ge in c(3, 1, 2)) {
  rgs <- lapply(results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "reg")
  cis0 <- lapply(results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci")
  source("../program/tabulate_est.R")
  #### Need: estimates, SE, p, lb, ub,
  cis0 <- lapply(cis0, data.table)
  cis <- lapply(cis0, function(x) x[, df := NULL])
  cis <- lapply(cis, function(x) {
   dm <- data.frame(x[, -1])
   rownames(dm) <- as.character(unlist(x[, 1]))
   dm
   })
  tab <- tabs2latex4(cis, informat = "sattCI", outformat = OUTFORMAT, 
    xx.yyy = T, AddStarIntabstarP = ADDStar, CIIntinysize = T, 
    Pparenthesis = "brace", UseHTML = T)
  rn <- rownames(tab)
  rn[-seq(1, length(rn), plusrows+1)] <- ""
  tabmat <- as.matrix(tab)
  rownames(tabmat) <- rn
  ####  replace variable names, deleting std error names
  rnm <- rn
  for (k in 1:nrow(sbt)){
    if (any(grepl(sbt[k, "org"], rnm))) 
      rnm[grep(sbt[k, "org"], rnm)] <- sbt[k, "changedto"]
  }
  rnm <- gsub("Number of ol", "Ol", rnm)
  rnm <- gsub("\\$\\\\times\\$ year.*", "", rnm)
  rnm <- gsub("\\$\\\\times\\$ ag ?HH", "", rnm)
  rnm <- gsub("\\\\hspace\\{.*?\\}", "", rnm)
  rownames(tabmat) <- rnm
  for (iii in 1:ncol(tabmat)) {
    tabmat[, iii] <- gsub("\\\\mbox\\{\\\\tiny ?(.*)\\}", "\\1", tabmat[, iii])
    tabmat[, iii] <- gsub("\\\\phantom\\{.*?\\}", "", tabmat[, iii])
    tabmat[, iii] <- gsub("\\^\\{(.*)\\}", "", tabmat[, iii])
  }
  tabmat <- rbind(tabmat, 
  ####  "Thana fixed trends" = c("", "Y", "Y", "Y"),
  ####  "HH fixed trends" = c("", "", "Y", "Y"),
  ####  "HH*agHH fixed trends" = c("", "", "", "Y")
    "Covariates, thana trends" = c("", "Y", "Y"),
    "HH trends" = c("", "", "Y"))
  library(kableExtra)
  tcol1 <- rownames(tabmat)
  tabmat <- cbind("Variables" = tcol1, tabmat)
  colnames(tabmat) <- c("variables", "raw DID", "+covariates", "+HH trends", 
    "+HH*agHH fixed trends")[-4]
  tabmat <- rbind(c(" ", 1:3), tabmat)
  tabmat <- data.table(tabmat)
  #### Using kbl shows title in the side note (need explicitly row.names = F)
  kt <- kbl(tabmat, align = paste0("r", paste0(rep("c", ncol(tabmat)-1), collapse = "")), 
    row.names = F, caption = 
    paste0("Enrollment impacts: Year 1999-2002, ",  genderitems[ge], 
    ", 10-18 years old, direct offspring, Satterthwaite correction"))
  kt <- kable_styling(kt, full_width = F, position = "left", fixed_thead = T, 
    html_font = "Cambria", bootstrap_options = c("condensed"))
  kt <- row_spec(kt, 0:1, align = paste0(rep("c", ncol(tabmat)), collapse = ""), background = "#ffcc99")
  aghhrows <- grep("^Agr", tabmat[, variables])
  kt <- row_spec(kt, 
    rep(aghhrows, each = plusrows+1)+rep(0:plusrows, length(aghhrows)), 
    bold = F, color = "black", background = "#87cefa")
  allcovrows <- which(grepl("\\w", tabmat[, variables]) & 
    !grepl("trend", tabmat[, variables]))
  kt <- row_spec(kt, allcovrows+plusrows, font_size = 11)
  kt <- column_spec(kt, 1, width = "6cm; min-width:6cm;")
  kt <- column_spec(kt, 2:4, width = "2.25cm; min-width:2.25cm;")
  kt <- pack_rows(kt, group_label="Time varying covariates", 
    grep("^\\(Interce", tabmat[, variables])+plusrows+1, grep("Agr", tabmat[, variables])-1)
  if (ge == 3) 
    secondrow <- grep("sex", tabmat[, variables])[2] else
    secondrow <- grep("land ho", tabmat[, variables])[2]
  kt <- pack_rows(kt, group_label="Interaction with year 2002", 
    grep("Agr", tabmat[, variables]), secondrow-1)
  kt <- pack_rows(kt, group_label="Interaction with agHH*year 2002", 
    secondrow, grep("^Cov.*tha", tabmat[, variables]))
  kt <- scroll_box(kt, height = "800px")
  kt <- footnote(kt, 
             general = "Sample consists of direct offspring of household heads. ",
             number = c(SpecMemo1, SEMemoForSelectedResultsNoStar)
             )
  assign(paste0("FullResults", ge), kt)
}
```
</details>
```{r , echo = F}
FullResults3
```

Results for boys.

```{r show main results for boys, echo = F, eval = T}
FullResults1
```

Results for girls.

```{r show main results for girls, echo = F, eval = T}
FullResults2
```

Placebo 2002 cohort results (ages 10-18 in 2002).

<details><summary>Click here to see the code of shoring full placebo results.</summary>
```{r show placebo 1999 and 2002 cohort results, eval = T}
#### Uses tabs2latex4
s <- de <- 1
j <- clnum <- 2
m <- 3
ii <- 2
#### jj: 1=2002, 2=1999 cohort
for (jj in 1:2) {
  Tab <- NULL
  for (ge in c(3, 1, 2)) {
    cis0 <- lapply(results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci")
    cis0 <- lapply(cis0, data.table)
    cis <- lapply(cis0, function(x) x[, df := NULL])
    cis <- lapply(cis, function(x) {
     dm <- data.frame(x[, -1])
     rownames(dm) <- as.character(unlist(x[, 1]))
     dm
     })
    tab <- tabs2latex4(cis, informat = "sattCI", outformat = OUTFORMAT, 
      xx.yyy = T, AddStarIntabstarP = ADDStar, CIIntinysize = T, 
      Pparenthesis = "brace", UseHTML = T)
    rn <- rownames(tab)
    tabmat <- as.matrix(tab)
    rownames(tabmat) <- rn
    Tab <- rbind(Tab, tab)
  }
  rn <- rownames(Tab)
  rn[grepl("^p\\$|^CI|^se\\$", rn)] <- ""
  rn <- gsub("3.$", "3", rn)
  rn <- gsub("[12]$", "", rn)
  rnm <- rn
  for (k in 1:nrow(sbt)){
    if (any(grepl(sbt[k, "org"], rnm))) 
      rnm[grep(sbt[k, "org"], rnm)] <- sbt[k, "changedto"]
  }
  rnm <- gsub("Number of ol", "Ol", rnm)
  Tab <- cbind(covariates = rnm, Tab)
  for (iii in 1:ncol(Tab)) {
    Tab[, iii] <- gsub("\\\\mbox\\{\\\\tiny ?(.*)\\}", "\\1", Tab[, iii])
    Tab[, iii] <- gsub("\\\\phantom\\{.*?\\}", "", Tab[, iii])
    Tab[, iii] <- gsub("\\^\\{(.*)\\}", "", Tab[, iii])
    Tab[, iii] <- gsub("\\\\hspace\\{(.*)\\}", "", Tab[, iii])
  }
  Tab <- rbind(Tab, 
  ####  "Thana fixed trends" = c("", "Y", "Y", "Y"),
  ####  "HH fixed trends" = c("", "", "Y", "Y"),
  ####  "HH*agHH fixed trends" = c("", "", "", "Y"))
    "Covariates, thana trends"=c("Covariates, thana trends", "", "Y", "Y"),
    "HH trends"=c("HH trends", "", "", "Y"))
  library(kableExtra)
  colnames(Tab) <- c("variables", "raw DID", "+covariates", "+HH trends", 
    "+HH*agHH fixed trends")[-4]
  Tab <- data.table(Tab)
  kt <- kable(Tab, align = paste0("r", paste0(rep("c", ncol(Tab)-1), collapse = "")), 
    caption = 
    paste0("Enrollment placebo impacts: ", c(2002, 1999)[jj], 
      " cohort, year 2002-2006, 10-18 years old, direct offspring, Satterthwaite correction"))
  kt <- kable_styling(kt, full_width = F, position = "left", fixed_thead = T, 
    bootstrap_options = c("condensed"), html_font = "Cambria")
  kt <- row_spec(kt, 0, align = paste0(rep("c", ncol(Tab)-1), collapse = ""), 
    background = "#ffcc99")
  aghhrows <- grep("^[aA]gr", Tab[, variables])
  kt <- row_spec(kt, 
    rep(aghhrows, each = plusrows+1)+rep(0:plusrows, length(aghhrows)), 
    bold = F, color = "black", background = "#87cefa")
  allcovrows <- which(grepl("\\w", Tab[, variables]) & 
    !grepl("trend", Tab[, variables]))
  kt <- row_spec(kt, allcovrows+plusrows, font_size = 11)
  kt <- column_spec(kt, 1, width = "6cm; min-width:6cm;")
  kt <- column_spec(kt, 2:4, width = "2.25cm; min-width:2.25cm;")
  aghhrows <- grep("^.Intercept", Tab[, variables])
  #### Grouping rows
  for (ge in c(3, 1, 2)) {
    kt <- pack_rows(kt, group_label="Time varying covariates", 
      grep("^\\(Interce", Tab[, variables])[ge]+plusrows+1, 
      grep("^[aA]gr|^ag.H", Tab[, variables])[ge]-1)
    if (ge == 3) {
      firstrow <- grep("Agr", Tab[, variables])[1]
      secondrow <- grep("sex", Tab[, variables])[2] 
      thirdrow <- grep("Inter", Tab[, variables])[2]-1
    } else if (ge == 1) {
      firstrow <- grep("Agr", Tab[, variables])[2]
      secondrow <- grep("land ho", Tab[, variables])[4]
      thirdrow <- grep("Inter", Tab[, variables])[3]-1
    } else if (ge == 2) {
      firstrow <- grep("Agr", Tab[, variables])[3]
      secondrow <- grep("land ho", Tab[, variables])[6]
      thirdrow <- grep("^Cov.*tha", Tab[, variables])-1
    }
    kt <- pack_rows(kt, group_label="Interaction with year 2006", 
      firstrow, secondrow-1)
    kt <- pack_rows(kt, group_label="Interaction with agHH*year 2006", 
      secondrow, thirdrow)
  }
  #### css:
  RowGenderGroupCSS <- "background-color: #666; color: #fff;"
  kt <- pack_rows(kt, group_label="Boys+girls", aghhrows[1], aghhrows[2]-1,
    label_row_css = RowGenderGroupCSS)
  kt <- pack_rows(kt, group_label="Boys", aghhrows[2], aghhrows[3]-1,
    label_row_css = RowGenderGroupCSS)
  kt <- pack_rows(kt, group_label="Girls", aghhrows[3], 
    grep("^Cov.*th", Tab[, variables])-1,
    label_row_css = RowGenderGroupCSS)
  kt <- pack_rows(kt, group_label="Common specifications", 
    grep("^Cov.*th", Tab[, variables]), grep("^HH", Tab[, variables]),
    label_row_css = RowGenderGroupCSS)
  kt <- scroll_box(kt, height = "800px")
  kt <- footnote(kt, 
             general = "Sample of 2002 cohort, direct offspring of household heads. ",
             number = c(SpecMemo1html, SEMemoForSelectedResultsNoStarhtml)
             )
  assign(paste0("FullPlaceboResults", c(2, 9)[jj]), kt)
}
```
</details>
```{r, echo = F}
FullPlaceboResults2
```

Placebo 1999 cohort results (ages 13-21 in 2002).

```{r show placebo 1999 cohort results, echo = F, eval = T}
FullPlaceboResults9
```


## Main

### By gender and by aghh def

<details><summary>Click here to see the code of main results by gender, ag HH definitions.</summary>
```{r select results for MainByGenderByAgHHdef for given Agelb, eval = T, warning = F}
#### Does not use tabs2latex4, choose brace types in resl
library(kableExtra)
Res <- qread("../save/TabulatedAllResults.qs")
Enr <- qread("../save/TabulatedAllResultsEnr.qs")
NR <- qread("../save/TabulatedAllResultsNR.qs")
#### Res <- qread("save/TabulatedAllResults.qs")
#### Enr <- qread("save/TabulatedAllResultsEnr.qs")
#### NR <- qread("save/TabulatedAllResultsNR.qs")
aghh.defs2 <- aghh.defs[c(3, 2, 4, 1)]
Aghh.defs2 <- Aghh.defs[c(3, 2, 4, 1)]
Res[, agdef := factor(agdef, levels = aghh.defs2)]
Res[, Agdef := factor(agdef, labels = Aghh.defs2)]
Enr[, agdef := factor(agdef, levels = aghh.defs2)]
Enr[, Agdef := factor(agdef, labels = Aghh.defs2)]
NR[, agdef := factor(agdef, levels = aghh.defs2)]
NR[, Agdef := factor(agdef, labels = Aghh.defs2)]
for (ii in 1:2) {
  agyr <- paste0("^agHH.yr|Sib.*H.*", (2:3)[ii], "$")
  resl <- Res[grepl(agyr, Coef) & grepl(c("main", "placebo")[ii], objective) 
    & grepl("di", HHtype), 
    .(Coef, data, gender, agdef, Agdef, agelb, reg, HHtype, inference, beta, SE, p, CI_L, CI_U)][
    order(data, gender, reg, HHtype, Agdef, inference)]
  resl[, Estimate := formatC(beta, digits = 4, format = "f")]
  resl[, ci := paste0("\\mbox{\\tiny [", 
    formatC(CI_L, digits = 3, format = "f"), ", ", 
    formatC(CI_U, digits = 3, format = "f"), "]}")]
  resl[grepl("^L", inference), ci := paste0("\\mbox{\\tiny (", 
    formatC(CI_L, digits = 3, format = "f"), ", ", 
    formatC(CI_U, digits = 3, format = "f"), ")}")]
  resl[, pv := paste0("\\{", formatC(p*100, digits = 1, format = "f"), "\\}")]
  resl[, se := paste0("(", formatC(SE, digits = 3, format = "f"), ")")]
  NR0 <- NR[grepl("di", HHtype) & grepl("^B", inference), ]
  Enr0 <- Enr[grepl("di", HHtype) & grepl("B", inference), ]
  AddStar <- T
  if (AddStar) {
    resl[, est := Estimate]
    resl[, Estimate := paste0(est, "^{\\phantom{***}}")]
    resl[p < .1, Estimate := paste0(est, "^{*\\phantom{**}}")]
    resl[p < .05, Estimate := paste0(est, "^{**\\phantom{*}}")]
    resl[p < .01, Estimate := paste0(est, "^{***}")]
    resl[est > 0, Estimate := paste0("\\phantom{-}", Estimate)]
    resl[, est := NULL]
  }
  options(width=120)
  #### column order: b+g s1, s2, s3; b s1, s2, s3; g s1, s2, s3
  setkey(resl, Coef, gender, reg)
  setkey(NR0, gender, reg)
  if (ii == 1) jmax <- 1 else jmax <- 2
  for (jj in 1:jmax) {
    if (ii == 2) thisdata <- c("Ep.1", "Ep.2")[jj] else thisdata <- "Em.1"
    for (s in 1:3) {
      mr <- resl[grepl(thisdata, data) & agelb == (10:12)[s], ]
      nr0 <- NR0[grepl(thisdata, data) & agelb == (10:12)[s], ]
      enr0 <- Enr0[grepl(thisdata, data) & agelb == (10:12)[s], ]
      enr0[, EnRate := formatC(EnRate, digits = 4, format = "f")]
      for (m in 1:4) {
        # tabulate by specification
        main <- rbind(
          mr[grepl(aghh.defs2[m], agdef) & grepl("^ag", Coef) & grepl("^B", inference), Estimate]
          ,
          mr[grepl(aghh.defs2[m], agdef) & grepl("^ag", Coef) & grepl("^B", inference), se]
          ,
          mr[grepl(aghh.defs2[m], agdef) & grepl("^ag", Coef) & grepl("^B", inference), pv]
          ,
          unlist(mr[grepl(aghh.defs2[m], agdef) & grepl("^ag", Coef) & grepl("B", inference), ci])
        )
        sib <-  rbind(
           mr[grepl(aghh.defs2[m], agdef)  & grepl("SibF.*H.*yr", Coef) & grepl("BR", inference), Estimate]
           , 
           mr[grepl(aghh.defs2[m], agdef) & grepl("SibF.*H.*yr", Coef) & grepl("B", inference), se]
           , 
           mr[grepl(aghh.defs2[m], agdef) & grepl("SibF.*H.*yr", Coef) & grepl("B", inference), pv]
           ,
           mr[grepl(aghh.defs2[m], agdef) & grepl("SibF.*H.*yr", Coef) & grepl("B", inference), ci]
           ,
           mr[grepl(aghh.defs2[m], agdef) & grepl("SibM.*H.*yr", Coef) & grepl("BR", inference), Estimate]
           , 
           mr[grepl(aghh.defs2[m], agdef) & grepl("SibM.*H.*yr", Coef) & grepl("B", inference), se]
           , 
           mr[grepl(aghh.defs2[m], agdef) & grepl("SibM.*H.*yr", Coef) & grepl("B", inference), pv]
           ,
           mr[grepl(aghh.defs2[m], agdef) & grepl("SibM.*H.*yr", Coef) & grepl("B", inference), ci]
         )
         sib <- cbind("", "", sib[, 1], "", "", sib[, 2], "", "", sib[, 3])
         nr <- rbind(
            formatC(nr0[grepl(aghh.defs2[m], agdef), ][order(gender, reg), R], digits = 4, format = "f")
          , formatC(nr0[grepl(aghh.defs2[m], agdef), ][order(gender, reg), Yes], digits = 0, format = "f")
          , formatC(nr0[grepl(aghh.defs2[m], agdef), ][order(gender, reg), n], digits = 0, format = "f")
         )
         nr <- data.table(nr)
         nr[2:3, c(1, 3, 4, 6, 7, 9) := " "]
         nr <- as.matrix(nr)
         enr <- matrix(
           enr0[grepl(aghh.defs2[m], agdef), ][order(gender, tee, agHH), EnRate]
           , byrow = F, nrow = 4)
         enr <- data.table(enr[, rep(1:3, each = 3)])
         enr[, c(1, 3, 4, 6, 7, 9) := " "]
         enr <- as.matrix(enr)
         main <- rbind(main, sib, nr, enr)
         assign(paste0("main", m), main)
      }
      # ii = 1: 3 specs = spec 1 direct, spec 2 direct, ...
      mrtab <- rbind(main1, main2, main3, main4)
      mrtab <- 
        cbind(
            rep(c(
              "Agricultural household * year 2002", 
              "\\hspace{1em} SE", "\\hspace{1em} $p$ value", "\\hspace{1em} CI (BRL)", 
              "\\underline{\\phantom{mm}} * Older sisters",
              "\\hspace{1em} SE","\\hspace{1em} $p$ value", "\\hspace{1em} CI (BRL)", 
              "\\underline{\\phantom{mm}} * Older brothers",
              "\\hspace{1em} SE","\\hspace{1em} $p$ value", "\\hspace{1em} CI (BRL)", 
              "$\\bar{R}^{2}$", "N: Agricultural HHs", "N",
              paste0("Mean of ", rep(c("control", "treated"), 2), " in ", 
                list(rep(c(1999, 2002), each = 2), rep(c(2002, 2006), each = 2))[[ii]])
               ), 4
            ), 
         mrtab)
      #### LaTeX output
      #allcovrows <- which(grepl("\\w", mrtab[, 1]) & 
      #  !grepl("trend|^N|^R2|\\\\bar\\{|Mea.*1999|Mea.*200|^\\\\hspace", mrtab[, 1]))
      #### pval: change bracket to brace
      #for (i in allcovrows+2) mrtab[i, ] <- gsub("\\((.*?)\\)", "\\\\{\\1\\\\}", mrtab[i, ])
      SepCols <- c(3, 6) 
      ltb <- latextab(mrtab, delimiterline = NULL, 
          hcenter = c(3, rep(1.3, ncol(mrtab)-1)),
          hleft = c("\\scriptsize", rep("\\hfil\\scriptsize$", ncol(mrtab)-1)), 
          hright = c("\\hfill", rep("$", ncol(mrtab)-1)),
          headercolor = NULL, 
          adjustlineskip = "-.5ex", 
          adjlskiprows = grep("CI|^SE\\$|p..val", mrtab[, 1])-1,
          addseparatingcols = SepCols, separatingcolwidth = rep(.1, 2), 
          separatingcoltitle = c("\\textsf{Boys+girls}", "\\textsf{Boys}", "\\textsf{Girls}")
        ) 
      ltb <- c(
        ltb[1], "\\hline", 
        ltb[2:grep("cline", ltb), ],
        paste0(
          "&\\textsf{Spec 1} & \\textsf{Spec 2} & \\textsf{Spec 3}",
          paste(rep("&&\\textsf{Spec 1} & \\textsf{Spec 2} & \\textsf{Spec 3}", 2), collapse = "")
          , "\\\\"),
        "&\\multicolumn{11}{l}{}\\\\",
        paste("A. AgHH def:", Aghh.defs2[1], "&",
          gsub("3\\)", "3)&", gsub("6\\)", "6)&", paste(paste0("(", 1:9, ")", collapse = "&"), "\\\\")))
          ),
        ltb[(grep("cline", ltb)+2):(grep("M.*ed in 2", ltb)[1]), ], 
        "&\\multicolumn{11}{l}{}\\\\",
        paste("B. AgHH def:", Aghh.defs2[2], "&",
          gsub("2\\)", "2)&", gsub("5\\)", "5)&", paste(paste0("(", 1:9+9, ")", collapse = "&"), "\\\\")))
          ),
        ltb[(grep("^Ag", ltb)[2]):(grep("M.*ed in 2", ltb)[2]), ],
        "&\\multicolumn{11}{l}{}\\\\",
        paste("C. AgHH def:", Aghh.defs2[3], "&",
          gsub("1\\)", "1)&", gsub("4\\)", "4)&", paste(paste0("(", 1:9+18, ")", collapse = "&"), "\\\\")))
          ),
        ltb[(grep("^Ag", ltb)[3]):(grep("M.*ed in 2", ltb)[3]), ], 
        "&\\multicolumn{11}{l}{}\\\\",
        paste("D. AgHH def:", Aghh.defs2[4], "&",
          gsub("0\\)", "0)&", gsub("3\\)", "3)&", paste(paste0("(", 1:9+27, ")", collapse = "&"), "\\\\")))
          ),
        ltb[(grep("^Ag", ltb)[4]):(grep("M.*ed in 2", ltb)[4]), ], "\\hline",
          ltb[nrow(ltb), ]
        ) 
      ltb <- gsub("CI \\(.*?\\)|SE.*|.p..value", "", ltb)
      ltb <- gsub("CI\\$.*\\$|.p. value|^se\\$.*\\$", "", ltb)
      ltb <- gsub("(^\\\\cline.*$)", "\\1[-1ex]", ltb)
      ltb <- gsub("household", "HH", ltb)
      ltb <- gsub("Number of ol", "Ol", ltb)
      ltb <- ltb[!grepl("Raw", ltb)]
      write.tablev(ltb
        ,  paste0("../save/", c("Main", "Placebo")[ii], c(1999, 2002)[jj], "Older", (10:12)[s], 
             "ByGenderByAgHHdefResults.tex")
        ,  colnamestrue = F)
      aghhrows <- grep("AgHH def", ltb)
      ltb1 <- c(ltb[1:(aghhrows[3]-2)], ltb[length(ltb)-1:0])
      ltb2 <- c(ltb[1:grep("cline", ltb)], ltb[(aghhrows[3]-1):length(ltb)])
      write.tablev(ltb1
        ,  paste0("../save/", c("Main", "Placebo")[ii], c(1999, 2002)[jj], "Older", (10:12)[s], 
             "ByGenderByAgHHdefResults1.tex")
        ,  colnamestrue = F)
      write.tablev(ltb2
        ,  paste0("../save/", c("Main", "Placebo")[ii], c(1999, 2002)[jj], "Older", (10:12)[s], 
             "ByGenderByAgHHdefResults2.tex")
        ,  colnamestrue = F)
      #### Concise table for appendix
      sibrows <- grep("Older", ltb)
      ltbshort <- ltb[-(sibrows+rep(0:2, length(sibrows)))]
      write.tablev(ltbshort
        ,  paste0("../save/", c("Main", "Placebo")[ii], c(1999, 2002)[jj], "Older", (10:12)[s], 
             "ByGenderByAgHHdefResultsConcise.tex")
        ,  colnamestrue = F)
      if (s == 1)
        write.tablev(ltbshort
          ,  paste0("../draft/Tables/App_", c("Main", "Placebo")[ii], c(1999, 2002)[jj], "Older", (10:12)[s], 
               "ByGenderByAgHHdefResultsConcise.tex")
          ,  colnamestrue = F)
      #### HTML output
      mrtab <- rbind(mrtab, 
        "Covariates, thana trends" = c("Covariates, thana trends", rep(c("", "Y", "Y"), 3)),
        "HH trends" = c("HH trends", rep(c("", "", "Y"), 3)))
      Tab <- data.table(mrtab)
      setnames(Tab, paste0("v", 1:ncol(Tab)))
      aghhrows <- grep("^Ag", Tab[, v1])
      nt <- ncol(Tab)-1
      Tab <- rbind(t(c("", 1:nt)), Tab, use.names = F)
      for (iii in 2:length(aghhrows)) {
        setnames(Tab, paste0("v", 1:ncol(Tab)))
        aghhrows <- grep("^Ag", Tab[, v1])
        Tab <- rbind(
          Tab[1:(aghhrows[iii]-1), ],
          t(c("", nt*(iii-1)+1:nt)), 
          Tab[aghhrows[iii]:nrow(Tab), ], use.names = F) 
      }
      setnames(Tab, c("variables", paste0("v", 1:nt)))
      Tab <- lapply(Tab, function(x) gsub("\\\\mbox\\{\\\\tiny(.*)\\}", "\\1", x))
      Tab <- lapply(Tab, function(x) gsub("\\^.*", "", x))
      Tab <- lapply(Tab, function(x) gsub("\\\\phantom\\{-\\}", " ", x))
      Tab <- lapply(Tab, function(x) gsub("\\\\hspace\\{.*\\}", " ", x))
      Tab <- lapply(Tab, function(x) gsub(" *CI *\\(.*", " ", x))
      Tab <- lapply(Tab, function(x) gsub(" .p. value", " ", x))
      Tab <- lapply(Tab, function(x) gsub(" +SE ? ?", " ", x))
      Tab <- lapply(Tab, function(x) gsub("\\\\underline\\{.*\\}", "____", x))
      Tab <- lapply(Tab, function(x) gsub("^.*bar.R.*", "R2", x))
      Tab <- lapply(Tab, function(x) gsub("\\\\phantom\\{.*?\\}", "", x))
      Tab <- lapply(Tab, function(x) gsub("\\^\\{(.*)\\}", "", x))
      Tab <- do.call(cbind, Tab)
      colnames(Tab) <- c("variables", rep(c("raw DID", "+covariates", 
        "+HH trends", "+HH*agHH fixed trends")[-4], 3))
      Tab <- data.table(Tab)
      #### pval: change bracket to brace
      #allcovrows <- which(grepl("\\w", Tab[, variables]) & 
      #  !grepl("trend|^N|^R2|Mea.*1999|Mea.*200", Tab[, variables]))
      #for (i in allcovrows+2) for (j in 2:ncol(Tab)) set(Tab, i, j, value = gsub("\\)", "\\}", Tab[[j]][i]))
      #for (i in allcovrows+2) for (j in 2:ncol(Tab)) set(Tab, i, j, value = gsub("\\(", "\\{", Tab[[j]][i]))
      bgcolor <- "#ffcc99"
      kt <- kable(Tab, align = paste0("r", paste0(rep("c", ncol(Tab)-1), collapse = "")), 
        caption = 
        paste("Main results: Enrollment impacts for year 1999-2002,", 
          "10-18 years old, direct offspring, Satterthwaite correction"))
      kt <- add_header_above(kt, c(" " = 1, "Boys+girls" = 3, "Boys" = 3, "Girls" = 3),
        background = bgcolor)
      kt <- row_spec(kt, 0, align = paste0(rep("c", ncol(Tab)-1), collapse = ""), 
        background = bgcolor)
      aghhrows <- grep("^Ag", Tab[, variables])
      kt <- row_spec(kt, rep(aghhrows, each = plusrows+1)+0:plusrows, bold = F, 
        color = "black", background = "#87cefa") 
      allcovrows <- which(grepl("\\w", Tab[, variables]) & 
        !grepl("trend|^N|^R2|Mea.*1999|Mea.*200", Tab[, variables]))
      kt <- row_spec(kt, allcovrows+plusrows, font_size = 11)
      for (iii in 1:length(aghhrows)) 
        kt <- pack_rows(kt, group_label=Aghh.defs2[iii], aghhrows[iii]-1, aghhrows[iii]+plusrows)
      kt <- pack_rows(kt, group_label="Common specifications", 
        grep("^Cova.*tha", Tab[, variables]), grep("^HH", Tab[, variables]))
      kt <- column_spec(kt, 1, width = "6.25cm; min-width:6.25cm;")
      kt <- column_spec(kt, 2:10, width = "2.25cm; min-width:2.25cm;")
      kt <- scroll_box(kt, height = "800px")
      kt <- footnote(kt, 
                 general = "Sample of direct offspring of household heads. ",
                 number = c(SpecMemo1html, SEMemoForSelectedResultshtml)
                 )
      assign(paste0(c("M", "P")[ii], c(9, 2)[jj], (10:12)[s], "L"), ltb)
      assign(paste0(c("M", "P")[ii], c(9, 2)[jj], (10:12)[s]), mrtab)
      assign(paste0(c("M", "P")[ii], c(9, 2)[jj], (10:12)[s], "H"), kt)
      qsave(kt, paste0("../save/", c("M", "P")[ii], c(9, 2)[jj], (10:12)[s], "H.qs"))
    } # s
  } # jj
} # ii
```
</details>
```{r, echo = F}
M910H
```

### By different age cutoff

<details><summary>Click here to see the code of results by different age lowerbound.</summary>
```{r M9 10-12, warning = F}
ii <- jj <- 1
aghhrows <- grep("^Agri", M910L)
tft <- c("Thana fixed trends", rep(c("", "", "Y", ""), 3))
tft <- paste(tft[-length(tft)], collapse = "&")
tft <- paste(tft, "\\\\")
hft <- c("HH fixed trends", rep(c("", "", "Y", ""), 3))
hft <- paste(hft[-length(hft)], collapse = "&")
hft <- paste(hft, "\\\\")
#### Below gives head reply def of ag HH
#### M9L <- c(M910L[1:(aghhrows[2]-3)], 
####   M911L[(aghhrows[1]-1):(aghhrows[2]-3)],
####   M912L[(aghhrows[1]-1):(aghhrows[2]-3)],
####   tft, hft,
####   M912L[(length(M912L)-1):length(M912L)])
#### Below gives income source def of ag HH
M9L <- c(
  M910L[1:(aghhrows[1]-3)], 
  M910L[(aghhrows[2]-1):(aghhrows[3]-3)], 
  M911L[(aghhrows[2]-1):(aghhrows[3]-3)],
  M912L[(aghhrows[2]-1):(aghhrows[3]-3)],
  tft, hft,
  M912L[(length(M912L)-1):length(M912L)])
M9L <- gsub(
  paste(
    paste(paste0("\\(", 10:12, "\\)"), collapse = "."),
    paste(paste0("\\(", 3+10:12, "\\)"), collapse = "."),
    paste(paste0("\\(", 6+10:12, "\\)"), collapse = "."),
    sep = "..")
  ,
  paste(
    paste(paste0("(", 1:3, ")"), collapse = "&"),
    paste(paste0("(", 3+1:3, ")"), collapse = "&"),
    paste(paste0("(", 6+1:3, ")"), collapse = "&"),
    sep = "&&")
  , M9L)
aghhrows <- grep("AgHH def", M9L)
for (iii in 1:length(aghhrows))
  M9L[aghhrows[iii]] <- gsub("AgHH def:.*?\\&", 
    paste0("Age lowerbound: ", c(10:12)[iii], "&"), M9L[aghhrows[iii]])
M9L <- gsub("B. Age lowerbound: 10", "A. Age lowerbound: 10", M9L)
M9L <- gsub("B. Age lowerbound: 12", "C. Age lowerbound: 12", M9L)
write.tablev(M9L
  ,  paste0("../save/", c("Main", "Placebo")[ii], c(1999, 2002)[jj], 
       "ByGenderByAgeLBResults.tex")
  ,  colnamestrue = F)
write.tablev(M9L
  ,  paste0("../draft/Tables/App_", c("Main", "Placebo")[ii], c(1999, 2002)[jj], 
       "ByGenderByAgeLBResults.tex")
  ,  colnamestrue = F)
#### HTML output
aghhrows <- grep("^Ag", M910[, 1])
M9 <- rbind(M910[(aghhrows[2]):(aghhrows[3]-1), ], 
  M911[(aghhrows[2]):(aghhrows[3]-1), ],
  M912[c((aghhrows[2]):(aghhrows[3]-1), 
    grep("^Cova.*tr", M912[, 1]):grep("^HH", M912[, 1])), ])
#### M9L <- 
#### rbind(M910[1:(aghhrows[2]-1), ], 
####   M911[aghhrows[2]:(aghhrows[3]-1), ],
####   M912[c(aghhrows[3]:(aghhrows[4]-1), 
####     grep("^Tha", M910[, 1]):grep("^HH", M910[, 1])), ])
allcovrows <- which(grepl("\\w", M9[, 1]) & 
  !grepl("trend|^N|^R2|[mM]ea.*1999|[mM]ea.*200|^\\\\|^ ?\\&|CI|p\\$|\\\\bar", M9[, 1]))
#### pval: change bracket to brace
for (i in allcovrows+2) M9[i, ] <- gsub("\\((.*?)\\)", "\\\\{\\1\\\\}", M9[i, ])
nt <- ncol(M9)-1
colnames(M9) <- c("variables", paste0("v", 1:nt))
M9 <- data.table(M9)
M9 <- lapply(M9, function(x) gsub("\\^\\\\\\{(.*?)\\\\\\}", "^\\{\\1\\}", x))
M9 <- lapply(M9, function(x) gsub("\\\\mbox\\{\\\\tiny(.*)\\}", "\\1", x))
M9 <- lapply(M9, function(x) gsub("\\^.*", "", x))
M9 <- lapply(M9, function(x) gsub("\\\\phantom\\{-\\}", " ", x))
M9 <- lapply(M9, function(x) gsub("\\\\hspace\\{.*\\}", " ", x))
M9 <- lapply(M9, function(x) gsub(" *CI *\\(.*", " ", x))
M9 <- lapply(M9, function(x) gsub(" .p. value", " ", x))
M9 <- lapply(M9, function(x) gsub(" *SE", " ", x))
M9 <- lapply(M9, function(x) gsub("\\\\underline\\{.*\\}", "____", x))
M9 <- lapply(M9, function(x) gsub("^.*bar.R.*", "R2", x))
M9 <- do.call(cbind, M9)
colnames(M9) <- c("variables", rep(c("raw DID", "+covariates", 
  "+HH trends", "+HH*agHH fixed trends")[-4], 3))
M9 <- data.table(M9)
#### pval: change bracket to brace
allcovrows <- which(grepl("\\w", M9[, variables]) & 
  !grepl("trend|^N|^R2|Mea.*1999|Mea.*200", M9[, variables]))
for (i in allcovrows+2) for (j in 2:ncol(M9)) set(M9, i, j, value = gsub("\\)", "\\}", M9[[j]][i]))
for (i in allcovrows+2) for (j in 2:ncol(M9)) set(M9, i, j, value = gsub("\\(", "\\{", M9[[j]][i]))
bgcolor <- "#ffcc99"
kt <- kable(M9, align = paste0("r", paste0(rep("c", ncol(M9)-1), collapse = "")), 
  caption = 
  paste("Main results: Enrollment impacts for year 1999-2002,",
    "different age lowerbound, direct offspring, Satterthwaite correction"))
kt <- add_header_above(kt, c(" " = 1, "Boys+girls" = 3, "Boys" = 3, "Girls" = 3),
  background = bgcolor)
kt <- row_spec(kt, 0, align = paste0(rep("c", ncol(M9)-1), collapse = ""), 
  background = bgcolor)
aghhrows <- grep("^Ag", M9[, variables])
kt <- row_spec(kt, rep(aghhrows, each = plusrows+1)+0:plusrows, 
  bold = F, color = "black", background = "#87cefa") 
for (iii in 1:length(aghhrows)) 
  kt <- pack_rows(kt, group_label=paste("Age lowerbound:", c(10:12)[iii]), 
    aghhrows[iii], aghhrows[iii]+(plusrows+1)*5)
allcovrows <- which(grepl("\\w", M9[, variables]) & 
  !grepl("trend|^N|^R2|Mea.*1999|Mea.*200", M9[, variables]))
kt <- row_spec(kt, allcovrows+plusrows, font_size = 11)
kt <- pack_rows(kt, group_label="Common specifications", 
  grep("^Cov.*tr", M9[, variables]), grep("^HH", M9[, variables]))
kt <- column_spec(kt, 1, width = "6cm; min-width:6cm;")
kt <- column_spec(kt, 2:10, width = "2.25cm; min-width:2.25cm;")
kt <- scroll_box(kt, height = "800px")
kt <- footnote(kt, 
           general = "Sample of direct offspring of household heads. ",
           number = c(SpecMemo1html, SEMemoForSelectedResultsNoStarhtml)
           )
assign(paste0(c("M", "P")[ii], c(9, 2)[jj], "L"), mrtab)
assign(paste0(c("M", "P")[ii], c(9, 2)[jj]), kt)
qsave(kt, paste0("../save/", c("M", "P")[ii], c(9, 2)[jj], ".qs"))
```
</details>
```{r, echo = F}
kt
```

<details><summary>Click here to see the R script of plotting effects by age lowerbound.</summary>

```{r plot main by age LB, eval = T, echo = T}
#### results <- qread("../save/DID2024_MainResults.qs")
#### results <- qread("save/DID2024_MainResults.qs")
s <- de <- 1
j <- clnum <- 2
m <- 3
cis <- NULL
for (ii in 1:2) {
  jjmax <- 1
  if (ii == 2) jjmax <- 2
  for (jj in 1:jjmax) {
    for (ge in c(3, 1, 2)) {
      for (s in 1:3) {
        cis0 <- lapply(results[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci")
        cis0 <- lapply(cis0, data.table)
        cis0 <- lapply(cis0, function(x) x[, data := c("main", "placebo")[ii]])
        cis0 <- lapply(cis0, function(x) x[, cohort := c("1999", "2002")[jj]])
        cis0 <- lapply(cis0, function(x) x[, gender := genderitems[ge]])
        cis0 <- lapply(cis0, function(x) x[, ageLB := (10:12)[s]])
        cis0 <- lapply(1:length(cis0), function(i) cis0[[i]][, spec := i])
        cis0 <- rbindlist(cis0)
        cis <- rbindlist(list(cis, cis0))
      }
    }
  }
}
cis <- cis[grepl("^agHH.yr", Coef), ]
cis[, group := factor(paste0(data, cohort), 
  levels = c("main1999", "placebo2002", "placebo1999"))]
cis[, group := factor(group, labels = c("main", "placebo2002", "placebo1999"))]
cis[, spec := factor(spec)]
cis[, yintercept := 0]
cis[, gender := factor(gender, levels = genderitems[c(3, 1, 2)])]
cis[, ageLB := factor(ageLB, labels = c("10-18", "11-18", "12-18"))]
library(ggplot2)
PointRange <-  geom_pointrange(aes(ymin = CI_L, ymax = CI_U),
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .25))
g <- ggplot(data = cis, 
    aes(x = group, y = beta, group = spec, fill = spec, shape = spec, colour = spec)) + 
  PointRange + ThisTheme + facet_grid(ageLB ~ gender) +
  xlab("data") + 
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  labs(color  = "regression specifications", fill = "regression specifications", 
    shape = "regression specifications") +
  ThisThemeEnd +
  guides(
    colour = guide_legend(title = "regression specifications", nrow = 1),
    fill = guide_legend(title = "regression specifications", nrow = 1),
    shape = guide_legend(title = "regression specifications", nrow = 1)
    ) +
  geom_hline(aes(yintercept = yintercept), colour = "lightgreen")
pdf(
  "../save/MainVsPlaceboPlotsByAgeLBByGender.pdf"
  , width = 2*12/2.54, height = 2*8/2.54)
print(g)
whatever <- dev.off()
pdf(
  "../draft/Figures/App_MainVsPlaceboPlotsByAgeLBByGender.pdf"
  , width = 2*12/2.54, height = 2*8/2.54)
print(g)
whatever <- dev.off()
rm(results)
```
</details>

```{r plot results by ageLB, echo = F, fig.cap = "Results by different age lowerbound by gender groups"}
g
```


* Verdict: Impacts found for boys of 11 years and older, even with raw DID.  
  * AgHH definition: Head's reply.  
* Point estimates are larger for boys of higher age lowerbounds, indicating a brawn-based mechanism [@PittRosenzweigHassan2012] at work.  
* Probably using 11-18 years old in the main estimation can give sharper results, but we need to commit to the original research design. Also, there is no good justification for using an *ad hoc* 11-18 age range.  
* We need to refer to this figure in the main text that raw DID can show impacts.  



## By age group

<details><summary>Click here to see the code of results by school age group.</summary>
```{r main gender AgeGroup2 for paper, eval = T, warning = F}
Res2 <- qread("../save/TabulatedMainResults2.qs")
NR2 <- qread("../save/TabulatedMainResultsNR2.qs")
Enr2 <- qread("../save/TabulatedMainResultsEnr2.qs")
#### Res2 <- qread("save/TabulatedMainResults2.qs")
#### NR2 <- qread("save/TabulatedMainResultsNR2.qs")
#### Enr2 <- qread("save/TabulatedMainResultsEnr2.qs")
Res2[, gender := factor(gender, levels = genderitems[c(3, 1, 2)])]
NR2[, gender := factor(gender, levels = genderitems[c(3, 1, 2)])]
Enr2[, gender := factor(gender, levels = genderitems[c(3, 1, 2)])]
aghh.defs2 <- aghh.defs[c(3, 2, 4, 1)]
Aghh.defs2 <- Aghh.defs[c(3, 2, 4, 1)]
Res2[, agdef := factor(agdef, levels = aghh.defs2)]
Res2[, Agdef := factor(agdef, labels = Aghh.defs2)]
Enr2[, agdef := factor(agdef, levels = aghh.defs2)]
Enr2[, Agdef := factor(agdef, labels = Aghh.defs2)]
NR2[, agdef := factor(agdef, levels = aghh.defs2)]
NR2[, Agdef := factor(agdef, labels = Aghh.defs2)]
res2 <- Res2[grepl("di", HHtype) & grepl("hd", agdef) & grepl("m.1", data)
   & grepl(2, agegroup) & !is.na(group), ]
nR <- NR2[grepl("hd", agdef) & grepl("m", data) 
  & grepl("^B", inference) & grepl("di", HHtype) & grepl(2, agegroup), ]
enr0 <- unique(Enr2[grepl("hd", agdef) & grepl("m", data) & grepl(2, agegroup)
  & grepl("B", inference) & grepl("di", HHtype), ])
enr0[, EnRate := formatC(EnRate, digits = 4, format = "f")]
res2[, spec := factor(reg, labels = 1:3)]
res2[, Estimate := formatC(beta, digits = 4, format = "f")]
res2[, ci := paste0("\\mbox{\\tiny [", 
  formatC(CI_L, digits = 2, format = "f"), ", ", 
  formatC(CI_U, digits = 2, format = "f"), "]}")]
res2[grepl("^L", inference), ci := paste0("\\mbox{\\tiny (", 
  formatC(CI_L, digits = 2, format = "f"), ", ", 
  formatC(CI_U, digits = 2, format = "f"), ")}")]
setnames(res2, "p_val", "p")
res2[, pv := paste0("\\{", formatC(p*100, digits = 1, format = "f"), "\\}")]
res2[, se := paste0("(", formatC(SE, digits = 4, format = "f"), ")")]
AddStar <- T
if (AddStar) {
  res2[, est := Estimate]
  res2[, Estimate := paste0(est, "^{\\phantom{***}}")]
  res2[p < .1, Estimate := paste0(est, "^{*\\phantom{**}}")]
  res2[p < .05, Estimate := paste0(est, "^{**\\phantom{*}}")]
  res2[p < .01, Estimate := paste0(est, "^{***}")]
  res2[est > 0, Estimate := paste0("\\phantom{-}", Estimate)]
  res2[, est := NULL]
}
#### main/placebo results
options(width=120)
setorder(res2, gender, reg)
setorder(nR, gender)
setorder(enr0, gender)
#### tabulate by specification
for (s in c("pri", "sec")) {
  main <- rbind(
    res2[grepl(s, group) & grepl("^agH", Coef) & grepl("^B", inference), Estimate]
    ,
    res2[grepl(s, group) & grepl("^agH", Coef) & grepl("B", inference), se]
    ,
    res2[grepl(s, group) & grepl("^agH", Coef) & grepl("B", inference), pv]
    ,
    res2[grepl(s, group) & grepl("^agH", Coef) & grepl("B", inference), ci]
  )
  sib <-  rbind(
     res2[grepl(s, group) & grepl("SibF.*H.*yr", Coef) & grepl("BR", inference), Estimate]
     , 
     res2[grepl(s, group) & grepl("SibF.*H.*yr", Coef) & grepl("B", inference), se]
     , 
     res2[grepl(s, group) & grepl("SibF.*H.*yr", Coef) & grepl("B", inference), pv]
     ,
     res2[grepl(s, group) & grepl("SibF.*H.*yr", Coef) & grepl("B", inference), ci]
     ,
     res2[grepl(s, group) & grepl("SibM.*H.*yr", Coef) & grepl("BR", inference), Estimate]
     , 
     res2[grepl(s, group) & grepl("SibM.*H.*yr", Coef) & grepl("B", inference), se]
     , 
     res2[grepl(s, group) & grepl("SibM.*H.*yr", Coef) & grepl("B", inference), pv]
     ,
     res2[grepl(s, group) & grepl("SibM.*H.*yr", Coef) & grepl("B", inference), ci]
   )
  sib <- cbind("", "", sib[, 1], "", "", sib[, 2], "", "", sib[, 3])
  nr <- rbind(
    formatC(nR[grepl(s, group), ][order(gender, spec), R], digits = 4, format = "f")
  , formatC(nR[grepl(s, group), ][order(gender, spec), Yes], digits = 0, format = "f")
  , formatC(nR[grepl(s, group), ][order(gender, spec), n], digits = 0, format = "f")
  )
  nr <- data.table(nr)
  nr[2:3, c(1, 3, 4, 6, 7, 9) := ""]
  nr <- as.matrix(nr)
  enr <- matrix(
   enr0[grepl(s, group), ][order(gender, tee, agHH), EnRate]
   , byrow = F, nrow = 4)
  enr <- data.table(enr[, rep(1:3, each = 3)])
  enr[, c(1, 3, 4, 6, 7, 9) := ""]
  enr <- as.matrix(enr)
  main <- rbind(main, sib, nr, enr)
  assign(paste0("main", s), main)
}
mrtab <- rbind(mainpri, mainsec)
mrtab <- cbind(
    rep(c(
      "Agricultural household * year 2002", 
      "\\hspace{1em} se", 
      "\\hspace{1em} $p$ value", 
      "\\hspace{1em} CI", 
      "\\underline{\\phantom{mm}} * Older sisters",
      "\\hspace{1em} se", 
      "\\hspace{1em} $p$ value", 
      "\\hspace{1em} CI", 
      "\\underline{\\phantom{mm}} * Older brothers",
      "\\hspace{1em} se", 
      "\\hspace{1em} $p$ value", 
      "\\hspace{1em} CI", 
      "$\\bar{R}^{2}$", "N: Agricultural HHs", "N",
      paste0("Mean of ", rep(c("treated", "control"), 2), " in ", 
        list(rep(c(1999, 2002), each = 2), rep(c(2002, 2006), each = 2))[[1]])
       ), 2
    ), 
 mrtab)
#### LaTeX output
####allcovrows <- which(grepl("\\w", mrtab[, 1]) & 
####  !grepl("trend|^N|^R2|\\\\bar\\{|Mea.*1999|Mea.*200|^\\\\hspace", mrtab[, 1]))
#### pval: change bracket to brace
####for (i in allcovrows+2) mrtab[i, ] <- gsub("\\((.*?)\\)", "\\\\{\\1\\\\}", mrtab[i, ])
SepCols <- c(3, 6)
ltb <- latextab(mrtab, delimiterline = NULL, 
    hcenter = c(3, rep(1.3, ncol(mrtab)-1)),
    hleft = c("\\scriptsize", rep("\\hfil\\scriptsize$", ncol(mrtab)-1)), 
    hright = c("\\hfill", rep("$", ncol(mrtab)-1)),
    headercolor = NULL, 
    adjustlineskip = "-.5ex", adjlskiprows = grep("CI|.p. val", mrtab[, 1])-1,
    addseparatingcols = SepCols, separatingcolwidth = rep(.1, length(SepCols)), 
    separatingcoltitle = c("\\textsf{Boys+Girls}", "\\textsf{Boys}", "\\textsf{Girls}")
  ) 
ltb <- c(
  ltb[1], 
  "\\hline", 
  ltb[2:grep("cline", ltb), ],
  "&\\multicolumn{11}{c}{\\scriptsize A. Primary school ages}\\\\",
  paste("&",
    gsub("6\\)", "6)&", gsub("3\\)", "3)&", paste(paste0("(", 1:9, ")", collapse = "&")))), "\\\\"),
  ltb[(grep("cline", ltb)+2):(grep("CI", ltb)[3]), ], 
  paste("Demographic fixed trends", 
    gsub("\\&$", "\\\\\\\\", 
    paste(rep(paste(paste(rep("& \\mbox{\\scriptsize Yes}", 3), collapse = ""), "&"), 3), collapse = ""))
    ),
  paste("Other household fixed trends&",
    paste(rep(paste(rep("& \\mbox{\\scriptsize Yes}", 2), collapse = ""), 3), collapse = "&&"), 
    "\\\\"),
  paste("Thana fixed trends&",
    paste(rep("&&\\mbox{\\scriptsize Yes}", 3), collapse = "&&"),
    "\\\\"),
  ltb[(grep("CI", ltb)[3]+1):(grep("M.*rol in 2", ltb)[1]), ],
  "&\\multicolumn{11}{c}{\\scriptsize B. Secodary school ages}\\\\",
  paste("&",
    gsub("5\\)", "5)&", gsub("2\\)", "2)&", paste(paste0("(", 1:9+9, ")", collapse = "&")))), "\\\\"),
  ltb[(grep("M.*rol in 2", ltb)[1]+1):(nrow(ltb)-1), ],
  "\\hline",
    ltb[nrow(ltb), ]
  )
ltb <- gsub("CI|.p. value| se ", "", ltb)
ltb <- gsub("(^\\\\cline.*$)", "\\1[-1ex]", ltb)
ltb <- gsub("household", "HH", ltb)
ltb <- gsub("Number of ol", "Ol", ltb)
N1 <- gsub("N.*?&", "", ltb[grepl("N: A", ltb)])
N1 <- gsub("\\\\", "", N1)
N1 <- gsub(" ", "", N1)
N1 <- unique(unlist(strsplit(N1, " ?\\& ?")))
N1 <- N1[nchar(N1)>0]
for (nn in 1:length(N1)) 
  ltb <- gsub(paste0(N1[nn], ".*\\& ", N1[nn], collapse = ""), 
    paste("\\\\multicolumn{3}{c}{\\\\scriptsize", N1[nn], "}"), ltb)
N2 <- gsub("N *\\&", "", ltb[grepl("N *\\&", ltb)])
N2 <- gsub("\\\\", "", N2)
N2 <- gsub(" ", "", N2)
N2 <- unique(unlist(strsplit(N2, " ?\\& ?")))
N2 <- N2[nchar(N2)>0]
ltb[grep(N2[1], ltb)] <- 
    paste("N", paste(
    paste("& \\multicolumn{3}{c}{\\scriptsize",  N2[1:3], "}")
    , collapse = "&"), "\\\\")
ltb[grep(N2[4], ltb)] <- 
    paste("N", paste(
    paste("& \\multicolumn{3}{c}{\\scriptsize",  N2[3+1:3], "}")
    , collapse = "&"), "\\\\")
N3 <- gsub("Mean.*?\\&", "", ltb[grepl("Mean", ltb)])
N3 <- gsub("\\&", "", N3)
N3 <- gsub("\\\\\\\\", "", N3)
N3 <- strsplit(N3, " +")
N3 <- lapply(N3, unique)
N3 <- lapply(N3, function(x) x[nchar(x)>0])
for (mm in 1:8)
  for (nn in 1:3) 
    ltb <- gsub(paste0(N3[[mm]][nn], ".*", N3[[mm]][nn], collapse = ""), 
      paste("\\\\multicolumn{3}{c}{\\\\scriptsize", N3[[mm]][nn], "}"), ltb)
ltb <- ltb[!grepl("Raw", ltb)]
write.tablev(ltb
  ,  "../save/MainGenderAgeGroup2WithInteractionsResults.tex"
  ,  colnamestrue = F)
write.tablev(ltb
  ,  "../draft/Tables/App_MainGenderAgeGroup2WithInteractionsResults.tex"
  ,  colnamestrue = F)
#### for compact tables without triple interactions
ninter <- length(grep("Older", ltb))
ltb2 <- ltb[-(grep("Older", ltb)+rep(0:2, ninter))]
write.tablev(ltb2
  ,  "../save/MainGenderAgeGroup2Results.tex"
  ,  colnamestrue = F)
#### HTML outputs
mrtab <- rbind(mrtab, 
  "Covariates, thana trends" = c("Covariates, thana trends", rep(c("", "Y", "Y"), 3)),
  "HH trends" = c("HH trends", rep(c("", "", "Y"), 3)))
Tab <- data.table(mrtab)
setnames(Tab, paste0("v", 1:ncol(Tab)))
aghhrows <- grep("^Ag", Tab[, v1])
nt <- ncol(Tab)-1
Tab <- rbind(t(c("", 1:nt)), Tab, use.names = F)
for (iii in 2:length(aghhrows)) {
  setnames(Tab, paste0("v", 1:ncol(Tab)))
  aghhrows <- grep("^Ag", Tab[, v1])
  Tab <- rbind(
    Tab[1:(aghhrows[iii]-1), ],
    t(c("", nt*(iii-1)+1:nt)), 
    Tab[aghhrows[iii]:nrow(Tab), ], use.names = F) 
}
setnames(Tab, c("variables", paste0("v", 1:nt)))
Tab <- lapply(Tab, function(x) gsub("\\\\mbox\\{\\\\tiny(.*)\\}", "\\1", x))
Tab <- lapply(Tab, function(x) gsub("\\^.*", "", x))
Tab <- lapply(Tab, function(x) gsub("\\\\phantom\\{-\\}", " ", x))
Tab <- lapply(Tab, function(x) gsub("\\\\hspace\\{.*\\}", " ", x))
Tab <- lapply(Tab, function(x) gsub(" *CI.*|.*p. value| +se", " ", x))
Tab <- lapply(Tab, function(x) gsub("\\\\underline\\{.*\\}", "____", x))
Tab <- lapply(Tab, function(x) gsub("^.*bar.R.*", "R2", x))
Tab <- lapply(Tab, function(x) gsub("\\\\phantom\\{.*?\\}", "", x))
Tab <- lapply(Tab, function(x) gsub("\\^\\{.*\\}", "", x))
Tab <- do.call(cbind, Tab)
colnames(Tab) <- c("variables", rep(c("raw DID", "+covariates", 
  "+HH trends", "+HH*agHH fixed trends")[-4], 3))
Tab <- data.table(Tab)
#### pval: change bracket to brace
####allcovrows <- which(grepl("\\w", Tab[, variables]) & 
####  !grepl("trend|^N|^R2|Mea.*1999|Mea.*200", Tab[, variables]))
####for (i in allcovrows+2) for (j in 2:ncol(Tab)) set(Tab, i, j, value = gsub("\\)", "\\}", Tab[[j]][i]))
####for (i in allcovrows+2) for (j in 2:ncol(Tab)) set(Tab, i, j, value = gsub("\\(", "\\{", Tab[[j]][i]))
bgcolor <- "#ffcc99"
kt <- kable(Tab, align = paste0("r", paste0(rep("c", ncol(Tab)-1), collapse = "")), 
  row.names = F, caption = 
  paste("Main results: Enrollment impacts for year 1999-2002 by school level,",
    "direct offspring, Satterthwaite correction"))
kt <- kable_styling(kt, full_width = F, position = "left", fixed_thead = T, 
  html_font = "Cambria", bootstrap_options = c("condensed"))
kt <- add_header_above(kt, c(" " = 1, "Boys+girls" = 3, "Boys" = 3, "Girls" = 3),
  background = bgcolor)
kt <- row_spec(kt, 0, align = paste0(rep("c", ncol(Tab)-1), collapse = ""), 
  background = bgcolor)
aghhrows <- grep("^Ag", Tab[, variables])
kt <- row_spec(kt, rep(aghhrows, each = plusrows+1)+0:plusrows, 
  bold = F, color = "black", background = "#87cefa")
for (iii in 1:length(aghhrows)) 
  kt <- pack_rows(kt, 
    group_label=c("A. Primary school ages", "B. Secondary school ages")[iii], 
    aghhrows[iii]-1, aghhrows[iii]+(plusrows+1)*4)
allcovrows <- which(grepl("\\w", Tab[, variables]) & 
  !grepl("trend|^N|^R2|Mea.*1999|Mea.*200", Tab[, variables]))
kt <- row_spec(kt, allcovrows+plusrows, font_size = 11)
kt <- pack_rows(kt, group_label="Common specifications", 
  grep("^Cov.*tr", Tab[, variables]), grep("^HH", Tab[, variables]))
kt <- column_spec(kt, 1, width = "6.25cm; min-width:6.25cm;")
kt <- column_spec(kt, 2:10, width = "2.25cm; min-width:2.25cm;")
kt <- scroll_box(kt, height = "800px")
kt <- footnote(kt, 
           general = "Sample of direct offspring of household heads. ",
           number = c(SpecMemo1html, SEMemoForSelectedResultsNoStarhtml)
           )
ii <- jj <- s <- 1
assign(paste0(c("M", "P")[ii], c(9, 2)[jj], (10:12)[s], "AgeGroup2"), mrtab)
assign(paste0(c("M", "P")[ii], c(9, 2)[jj], (10:12)[s], "AgeGroup2H"), kt)
qsave(kt, paste0("../save/", c("M", "P")[ii], c(9, 2)[jj], (10:12)[s], "AgeGroup2H.qs"))
```
```{r plot gender AgeGroup2 for paper, eval = T, warning = F}
library(ggplot2)
Res2 <- qread("../save/TabulatedMainResults2.qs")
Res2[, gender := factor(gender, levels = genderitems[c(3, 1, 2)])]
mbga <- Res2[grepl("di", HHtype) & grepl("hd", agdef) & grepl("^agHH.yr2$", Coef)
  & grepl("pri|sec", group), ]
mbga[, spec := factor(reg, labels = 1:3)]
mbga[, spec := factor(reg, labels = 1:3)]
PointRange <-  geom_pointrange(aes(ymin = CI_L, ymax = CI_U),
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .25))
g <- ggplot(data = mbga[grepl("A.*2", agegroup) & !is.na(group), ], 
    aes(x = group, y = beta, group = spec, fill = spec, shape = spec, colour = spec)) + 
  PointRange + ThisTheme + facet_grid( ~ gender) +
  xlab("age groups") + 
  labs(color  = "regression specifications", fill = "regression specifications", 
    shape = "regression specifications") +
  ThisThemeEnd +
  guides(
    colour = guide_legend(title = "regression specifications", nrow = 1),
    fill = guide_legend(title = "regression specifications", nrow = 1),
    shape = guide_legend(title = "regression specifications", nrow = 1)
    ) +
  geom_hline(aes(yintercept = yintercept), colour = "lightgreen")
pdf(
  "../save/GenderAgeGroup2Impacts.pdf"
  , width = 2*12/2.54, height = 2*8/2.54)
print(g)
whatever <- dev.off()
pdf(
  "../draft/Figures/GenderAgeGroup2Impacts.pdf"
  , width = 2*12/2.54, height = 2*8/2.54)
print(g)
whatever <- dev.off()
```
</details>
```{r, echo = F}
kt
```{r , echo = F, fig.cap = "Results by school level and gender"}
g
```

## Other schooling outcomes: Grade progression and days absent per month

* Students enrolled in 1999: Baseline sample including dropped out individuals.  
* Students enrolled in 1999 and 2002 = Students enrolled in 1999 - dropped out individuals 



<a name="NumGradeDaysAbsentResults">Boys+girls and boys and girls subsamples.</a>

<details><summary>Click here to see the code of num grades days absent, full results.</summary>
```{r show num grades days absent full results, eval = T, warning = F}
#### HTML output
library(kableExtra)
Tab <- TabGD
#### Tab <- MNDbg
colnames(Tab) <- c("variables", rep(c("raw DID", "+covariates", "+HH trends"), 3))
Tab[, 1] <- gsub("CI\\$.*\\$", "", Tab[, 1])
Tab[, 1] <- gsub("p\\$.*\\$", "", Tab[, 1])
Tab[, 1] <- gsub("se\\$.*\\$", "", Tab[, 1])
Tab[, 1] <- gsub("(^\\\\cline.*$)", "\\1[-1ex]", Tab[, 1])
Tab[, 1] <- gsub("household", "HH", Tab[, 1])
Tab[, 1] <- gsub("\\\\hspace\\{.*\\}", "", Tab[, 1])
Tab[, 1] <- Tab[, 1][!grepl("Raw", Tab[, 1])]
for (iii in 2:ncol(Tab)) {
  Tab[, iii] <- gsub("\\\\mbox\\{\\\\tiny ?(.*)\\}", "\\1", Tab[, iii])
  Tab[, iii] <- gsub("\\\\phantom\\{.*?\\}", "", Tab[, iii])
  Tab[, iii] <- gsub("\\^\\{(.*)\\}", "", Tab[, iii])
}
if (any(is.na(Tab))) Tab[is.na(Tab)] <- ""
bgcolor <- "#ffcc99"
Tab <- data.table(Tab)
kt <- kable(Tab, align = paste0("r", paste0(rep("c", ncol(Tab)-1), collapse = "")),
  caption = 
  "Other outcome impacts: 10-18 years old, direct offspring, Satterthwaite correction")
####kt <- add_header_above(kt, c(" " = 1, "Grade progression" = 3, "Days absent" = 3),
####  background = bgcolor)
kt <- add_header_above(kt, c(" " = 1, "Boys+girls" = 3, "Boys" = 3, "Girls" = 3),
  background = bgcolor)
allcovrows <- which(grepl("\\w", Tab[, variables]) & 
  !grepl("trend|^N$|^N:|^R2|200|199", Tab[, variables]))
kt <- row_spec(kt, allcovrows+plusrows, font_size = 11)
kt <- row_spec(kt, 0, align = paste0(rep("c", ncol(Tab)), collapse = ""), 
  background = bgcolor)
aghhrows <- grep("Agri", Tab[, variables])
kt <- row_spec(kt, 
  rep(aghhrows, each = plusrows+1)+rep(0:plusrows, length(aghhrows)), 
  bold = F, color = "black", background = "#87cefa")
kt <- column_spec(kt, 1, width = "6cm; min-width:6cm;")
kt <- column_spec(kt, 2:10, width = "2.25cm; min-width:2.25cm;")
RowGenderGroupCSS <- "background-color: #666; color: #fff;"
kt <- pack_rows(kt, group_label="Number of grades", 
  aghhrows[1]-1, aghhrows[3]-1, 
  label_row_css = RowGenderGroupCSS)
kt <- pack_rows(kt, group_label="Days absent", 
  aghhrows[3]-1, aghhrows[length(aghhrows)-2]-1, 
  label_row_css = RowGenderGroupCSS)
kt <- pack_rows(kt, group_label="Number of grades, placebo estimation", 
  aghhrows[length(aghhrows)-1]-1, aghhrows[length(aghhrows)]-1, 
  label_row_css = RowGenderGroupCSS)
packrowtext <- c(
  "Students enrolled in 1999", 
  "Students enrolled in 1999 and 2002", 
  "Students enrolled in 1999 and 2002", 
  "Students enrolled in 1999, cross section OLS of 2000", 
  "Students enrolled in 2002, cross section OLS of 2003", 
  "Students enrolled in 1999 and 2002, cross section OLS of 2000",
  "Students enrolled in 1999 and 2002, cross section OLS of 2003",
  "Students of 10-18 in 2002, 2002-2006 placebo impacts")
for (iii in 1:length(packrowtext))
  kt <- pack_rows(kt, group_label=packrowtext[iii], 
  aghhrows[iii]-1, aghhrows[iii+1]-1)
kt <- pack_rows(kt, group_label="Students of 10-18 in 1999, 2002-2006 placebo impacts", 
  aghhrows[length(packrowtext)+1]-1, grep("Cov.*ana", Tab[, variables])-1)
kt <- pack_rows(kt, group_label="Common specifications", 
  grep("Cov.*ana", Tab[, variables]), grep("HH tr", Tab[, variables]))
kt <- scroll_box(kt, height = "800px")
kt <- footnote(kt, 
           general = "Sample of direct offspring of household heads. ",
           number = c(SpecMemo1, SEMemoForSelectedResultsNoStarhtml)
           )
```
</details>
```{r, echo = F}
kt
```

```{r show days absent results, eval = F}
####resultsG[[ii]][[jj]][[en]][[s]][[j]][[ge]][[m]][[clnum]][[k]]
####resultsD[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]][[k]]
ii <- jj <- en <- s <- 1
j <- clnum <- 2
m <- 3 
#### enrs <- c("initial", "all time", "others")[en]
Tab <- NULL
for (ge in 1:3) {
  cis0 <- lapply(resultsD[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], "[[", "ci")
  cis0 <- lapply(cis0, data.table)
  cis <- lapply(cis0, function(x) x[, df := NULL])
  cis <- lapply(cis, function(x) {
   dm <- data.frame(x[, -1])
   rownames(dm) <- as.character(unlist(x[, 1]))
   dm
   })
  tab <- tabs2latex4(cis, informat = "sattCI", outformat = OUTFORMAT, 
    xx.yyy = T, AddStarIntabstarP = ADDStar, Pparenthesis = "brace", UseHTML = T)
  tab <- tab[grepl("^agHH.yr\\d|\\{agHH.yr\\d|Prog", rownames(tab)), ]
  vs <- c("^agHH.yr\\d", "^Sti", "^NonS")
  nums <- NULL
  for (vv in vs) nums <- c(nums, grep(vv, rownames(tab))+0:plusrows)
  tab <- tab[nums, ]
  rn <- rownames(tab)
  tabmat <- as.matrix(tab)
  rownames(tabmat) <- rn
  Tab <- rbind(Tab, tab)
}
rn <- rownames(Tab)
rn[grepl("^p|^CI|^se", rn)] <- ""
rn <- gsub("22$|21$", "2", rn)
rn <- gsub("m2$|m1$", "m", rn)
rn <- gsub("\\\\hspace\\{.5em\\}", "    ", rn)
rnm <- rn
for (k in 1:nrow(sbt)){
  if (any(grepl(sbt[k, "org"], rnm))) 
    rnm[grep(sbt[k, "org"], rnm)] <- sbt[k, "changedto"]
}
rnm <- gsub("Number of ol", "Ol", rnm)
rnm <- gsub("\\\\hspace\\{.5em\\}", "", rnm)
Tab <- cbind(covariates = rnm, Tab)
Tab <- rbind(Tab, 
  "Covariates, thana trends" = c("Covariates, thana trends", "", "Y", "Y"),
  "HH trends" = c("HH trends", "", "", "Y"))
#### LaTeX output
SepCols <- c(3, 6) 
ltb <- latextab(Tab, delimiterline = NULL, 
    hcenter = c(3, rep(1.3, ncol(Tab)-1)),
    hleft = c("\\scriptsize", rep("\\hfil\\scriptsize$", ncol(Tab)-1)), 
    hright = c("\\hfill", rep("$", ncol(Tab)-1)),
    headercolor = NULL, 
    adjustlineskip = "-.5ex", adjlskiprows = grep("CI", Tab[, 1])-1,
    addseparatingcols = SepCols, separatingcolwidth = rep(.1, length(SepCols)), 
    separatingcoltitle = c("\\textsf{Boys+girls}", "\\textsf{Boys}", "\\textsf{Girls}")
  ) 
ltb <- gsub("CI\\$.*\\$", "", ltb)
ltb <- gsub("p\\$.*\\$", "", ltb)
ltb <- gsub("(^\\\\cline.*$)", "\\1[-1ex]", ltb)
ltb <- gsub("household", "HH", ltb)
ltb <- ltb[!grepl("Raw", ltb)]
aghhrows <- grep(" Agri", ltb)
ltb <- c(
  ltb[1], "\\hline", 
  ltb[2:(aghhrows[1]-2)],
  "&\\multicolumn{11}{c}{A. Non Muslims}\\\\",
  ltb[(aghhrows[1]-1):(aghhrows[2]-2)],
  "&\\multicolumn{11}{c}{B. Flooded}\\\\",
  ltb[(aghhrows[2]-1):(length(ltb)-3)],
  "\\multicolumn{11}{l}{\\scriptsize Common specifications}\\\\",
  ltb[(length(ltb)-2):(length(ltb)-1)],
  "\\hline", ltb[length(ltb)]
  )
ltb <- gsub("CI\\$.*\\$|.p. value|p\\$.*\\$|^se\\$.*\\$", "", ltb)
allcovrows <- which(grepl("\\w", ltb) & 
  !grepl("trend|^N|^R2|[mM]ea.*1999|[mM]ea.*200|^\\\\|^ ?\\&|CI|p\\$|\\\\bar", ltb))
for (i in allcovrows+2) ltb[i] <- gsub("\\{(.*?)\\}|\\((.*?)\\)", "\\\\{\\1\\\\}", ltb[i])
ltb <- gsub("\\^\\\\\\{(.*?)\\\\\\}", "^\\{\\1\\}", ltb)
ltb <- gsub("(^\\\\cline.*$)", "\\1[-1ex]", ltb)
ltb <- gsub("household", "HH", ltb)
ltb <- ltb[!grepl("Raw", ltb)]
write.tablev(ltb
  ,  paste0("../save/", c("Main", "Placebo")[ii], "NumGradeDaysAbsent.tex")
  ,  colnamestrue = F)
#### HTML output
####colnames(Tab) <- c("variables", "raw DID", "+covariates", "+HH trends")
aghhrows <- grep(" Agri", Tab[, 1])
Tab <- rbind(
  t(c("", 1:(ncol(Tab)-1))), Tab[1:(aghhrows[2]-1), ],
  c("", ncol(Tab)+1:(ncol(Tab)-1)), Tab[aghhrows[2]:nrow(Tab), ]
  )
library(kableExtra)
colnames(Tab) <- c("variables", "raw DID", "+covariates", "+HH trends")
for (iii in 2:ncol(Tab)) {
  Tab[, iii] <- gsub("\\\\mbox\\{\\\\tiny ?(.*)\\}", "\\1", Tab[, iii])
  Tab[, iii] <- gsub("\\\\phantom\\{.*?\\}", "", Tab[, iii])
  Tab[, iii] <- gsub("\\^\\{(.*)\\}", "", Tab[, iii])
}
Tab <- rbind(c(" ", 1:3), Tab)
Tab <- data.table(Tab)
kt <- kable(Tab, align = paste0("r", paste0(rep("c", ncol(Tab)-1), collapse = "")), 
  caption = 
  "Monthly days of absence impacts: Year 1999-2002, 10-18 years old, direct offspring, Satterthwaite correction")
kt <- kable_styling(kt, full_width = F, position = "left", fixed_thead = T, 
  html_font = "Cambria", bootstrap_options = c("condensed"))
kt <- row_spec(kt, 0:1, align = paste0(rep("c", ncol(Tab)), collapse = ""), background = "#ffcc99")
aghhrows <- grep("Agri", as.character(unlist(Tab[, 1])))
kt <- row_spec(kt, rep(aghhrows, each = plusrows+1)+0:plusrows, 
  bold = F, color = "black", background = "#87cefa")
allcovrows <- which(grepl("\\w", Tab[, variables]) & 
  !grepl("trend|1999|200[26]|^N|^R2", Tab[, variables]))
kt <- row_spec(kt, allcovrows+plusrows, font_size = 11)
kt <- pack_rows(kt, group_label="Boys", grep("^agH", rn)[1], grep("^Non", rn)[1]+2)
kt <- pack_rows(kt, group_label="Girls", grep("^agH", rn)[2], grep("^Non", rn)[2]+2)
kt <- pack_rows(kt, group_label="Boys+Girls", grep("^agH", rn)[3], grep("^Non", rn)[3]+2)
kt <- scroll_box(kt, height = "800px")
kt <- footnote(kt, 
           general = "Sample of direct offspring of household heads. ",
           number = c(SpecMemo1, SEMemoForSelectedResultsNoStarhtml)
           )
kt
```

<details><summary>Click here to see the R script of plotting effects on grade progression and days absent.</summary>

```{r , echo = T, eval = F}
resultsG <- qread("../save/DID2024_NumGradesEnrollersGenderResults.qs")
resultsD <- qread("../save/DID2024_DaysAbsentEnrollersGenderResults.qs")
resultsC <- qread("../save/DID2024_DaysAbsentCrossSectionResults.qs")
```
These are produced in the section: Other schooling outcomes.  

Number of grades impacts are estimated using both the main and placebo samples:  

* DID estimates on incomplete panel portion.  
* DID estimates on complete panel portion.  

Days absent impacts are estimated using the main sample:  

* DID estimates on complete panel portion.  
* OLS estimates for 2003 impacts on 2003 enrollers.  
* OLS estimates for 2000 impacts on 2000 enrollers.  
* Placebo sample was not used because the 2006 data do not have the days absent information. 

```{r plot grade days, eval = T, echo = F}
ii <- jj <- s <- h <- dd <- 1
clnum <- j <- 2
m <- 3
cis <- NULL
for (ii in 1:2) {
  for (gd in 1:5) {
    #gd 1: NumGrade 1999 enrollers 
    #    2: NumGrade complete panel enrollers
    #    3: DaysAbsent 1999 and 2002 (=always) enrollers
    #    4: DaysAbsent 1999 enrollers, 2000 cross sectional OLS (resultsC, yy = 1)
    #    5: DaysAbsent 2002 enrollers, 2003 cross sectional OLS (resultsC, yy = 2)
    # Placebo is estimated only for NumGrades. No DaysAbsent data collected in 2006.
    if (ii == 2 & gd > 2) next
    # For gd == 4, 5, two months of planting season absenteeism 
    # in a 3 month recall question.
    #   yy = 1 (1999, July-August, asked in Sep-Oct)
    #   yy = 2 (2002, July-August, asked in Sep-Oct) 
    # For days absent cross section
    #   m: ag HH definitions
    #   ge: gender
    #   j: z2 (incl. extended) or z3 (nuclear)
    #   s: upperbound age cutoffs (10, 15)
    #   dd: 1=demeaned (2=undemeaned is not estimated)
    #   yy: 1999, 2002 (survey == sampleyears[yy])
    #      sampleyears <- list(c(1999, 2002), c(2002, 2006))[[ii]]
    #      2006 is excluded because no days absent collected in 2007
    #      So if ii == 2, yy must be 1, yy == 2 needs to be skipped
    #   jj: zE / zS sample selection
    #   ii: main / placebo samples
    # resultsC[[ii]][[jj]][[yy]][[dd]][[s]][[j]][[ge]][[m]]
    for (yy in 1:2) { 
      # Year 2002 impacts are only for cross sections. 
      # Panel estimates (gd < 4) needs to skip
      if (gd < 4 & yy == 2) next
      # For gd < 4, rr is not used. For gd >= 4, rr=1: current enrollers, rr=2: always enrollers
      if (gd == 4) rr <- 1
      if (gd == 5) rr <- 2
      for (ge in c(3, 1, 2)) {
        if (gd <= 2) 
          cis0 <- lapply(resultsG[[ii]][[jj]][[gd]][[s]][[j]][[ge]][[m]][[clnum]], 
            "[[", "ci") else
        if (gd == 3) 
          cis0 <- lapply(resultsD[[ii]][[jj]][[s]][[j]][[ge]][[m]][[clnum]], 
            "[[", "ci") else
          cis0 <- lapply(resultsC[[ii]][[jj]][[yy]][[rr]][[s]][[j]][[ge]][[m]], 
            "[[", "ciBRL")
        cis0 <- lapply(cis0, data.table)
        cis0 <- lapply(1:length(cis0), function(i) cis0[[i]][, spec := i])
        cis0 <- rbindlist(cis0)
        cis0[, data := c("main", "placebo")[ii]]
        cis0[, outcome := c(rep(c("Grades", "Days"), each = 2), 
          "Days", "Days")[gd]]
        cis0[, year := c(1999, 2002)[yy]]
        cis0[, files := gdfiles[gd]]
        cis0[, gender := genderitems[ge]]
        cis <- rbind(cis, cis0)
      } # ge
    } # yy
  } # gd
} # ii
cis <- cis[grepl("^agHH.yr|^agHH$", Coef), ]
cis[gd < 4, year := NA]
cis[, spec := factor(spec)]
cis[, yintercept := 0]
cis[, data := factor(data)]
cis[, gender := factor(gender, levels = genderitems[c(3, 1, 2, 4)])]
cis[, year := as.character(year)]
cis[grepl("D", outcome) & grepl("enrollers$", files), year := "panel 1999-2002"]
cis[, year := factor(year, levels = c("panel 1999-2002", 1999, 2002))]
cis[, year := factor(year, labels = 
  c("Days absent\npanel 1999-2002", "Days absent\nOLS 1999", "Days absent\nOLS 2002"))]
cis[, files := factor(files, levels = gdfiles)]
cis[, outcomes := "Grades\nMain panel\n1999 cohort"]
cis[grepl("pla", data), outcomes := "Grades\nPlacebo panel\n2002 cohort"]
cis[grepl("D", outcome) & grepl("ab.*ers$", files), outcomes := "Days absent\nMain panel\n1999 cohort"]
cis[grepl("D", outcome) & grepl("OLS.*9", year), outcomes := "Days absent\nOLS\n1999"]
cis[grepl("D", outcome) & grepl("OLS.*2", year), outcomes := "Days absent\nOLS\n2002"]
cis[, outcomes := factor(outcomes, levels = c(
  "Grades\nMain panel\n1999 cohort", "Grades\nPlacebo panel\n2002 cohort",
  "Days absent\nMain panel\n1999 cohort", 
  "Days absent\nOLS\n1999", "Days absent\nOLS\n2002"))]
cis[, filesShort := factor(files, labels = gdfilesShort)]
cis[, type := filesShort]
cis[grepl("OLS", files), type := as.character(year)]
cis[grepl("always", files), type := "always enrollers"]
cis[grepl("enro", files) & !grepl("always", files), type := "baseline enrollers"]
cis[, type := factor(type, levels = c("baseline enrollers", "always enrollers"))]
cis[grepl("2$", Coef) & grepl("G", outcome) & grepl("\\+", gender) & spec != 1, 
  .(Coef, beta, spec, gender, filesShort, outcome, type)]
cis[grepl("D", outcome) & grepl("^gi", gender), .(Coef, beta, spec, gender, year, filesShort, outcome, type)]
library(ggplot2)
library(ggh4x)
PointRange <-  geom_pointrange(aes(ymin = CI_L, ymax = CI_U),
    stat = "identity", fatten = 1.75, 
    position = position_dodge(width = .25))
g <- ggplot(data = cis[grepl("Gr", outcome), ], 
    aes(x = type, y = beta, group = spec, fill = spec, shape = spec, colour = spec)) + 
  PointRange + ThisTheme + 
  facet_grid(outcomes ~ gender, scales = "free_y") +
  xlab("data") + 
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  labs(color  = "regression specifications", fill = "regression specifications", 
    shape = "regression specifications") +
  ThisThemeEnd +
  guides(
    colour = guide_legend(title = "regression specifications", nrow = 1),
    fill = guide_legend(title = "regression specifications", nrow = 1),
    shape = guide_legend(title = "regression specifications", nrow = 1)
    ) +
  geom_hline(aes(yintercept = yintercept), colour = "lightgreen")
g1 <- g + theme(
   strip.text.y = element_text(color = "blue", size = 8, 
     margin = margin(2.5, 0, 2.5, 0, "cm")),
   legend.position = "none"
     ) +
  facetted_pos_scales(y = list(
    outcomes == "Grades\n1999 cohort" ~ 
      scale_y_continuous(limits = c(-.8, .2), breaks = seq(-.8, .2, .2)),
    outcomes == "Grades\nplacebo 2002 cohort" ~ 
      scale_y_continuous(limits = c(-.8, .2), breaks = seq(-.8, .2, .2))
  ))
g <- ggplot(data = cis[grepl("D", outcome), ], 
    aes(x = type, y = beta, group = spec, fill = spec, shape = spec, colour = spec)) + 
  PointRange + ThisTheme + 
  facet_grid(year ~ gender, scales = "free_y") +
  xlab("data") + 
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  labs(color  = "regression specifications", fill = "regression specifications", 
    shape = "regression specifications") +
  ThisThemeEnd +
  guides(
    colour = guide_legend(title = "regression specifications", nrow = 1),
    fill = guide_legend(title = "regression specifications", nrow = 1),
    shape = guide_legend(title = "regression specifications", nrow = 1)
    ) +
  geom_hline(aes(yintercept = yintercept), colour = "lightgreen")
g2 <- g + theme(
   strip.text.y = element_text(color = "blue", size = 8, 
     margin = margin(2.5, 0, 2.5, 0, "cm"))
     ) +
  facetted_pos_scales(y = list(
    year == "Days absent\npanel 1999-2002" ~ 
      scale_y_continuous(limits = c(-1, 6), breaks = seq(-1, 6, 2)),
    year == "Days absent\nOLS 1999" ~ 
      scale_y_continuous(limits = c(-1, 6), breaks = seq(-1, 6, 2)),
    year == "Days absent\nOLS 2002" ~ 
      scale_y_continuous(limits = c(-1, 6), breaks = seq(-1, 6, 2))
  ))
library("egg")
g <- ggarrange(g1, g2, nrow=2)
#### library(gridExtra)
#### w = 0.512
#### grid.arrange(g1, g2, heights=c(w,1-w), nrow=2)

#### cis[, EstimatedFor := "Main panel 1999 cohort"]
#### cis[grepl("G", outcome) & grepl("p", data), EstimatedFor := "Placebo panel 2002 cohort"]
#### cis[grepl("D", outcome) & grepl(9, year), EstimatedFor := "OLS 1999"]
#### cis[grepl("D", outcome) & grepl(2, year), EstimatedFor := "OLS 2002"]
g <- ggplot(data = cis, 
    aes(x = type, y = beta, group = spec, fill = spec, shape = spec, colour = spec)) + 
  PointRange + ThisTheme + 
  #facet_nested(outcomes + EstimatedFor ~ gender)
  facet_grid(outcomes ~ gender, scales = "free_y") +
  xlab("data") + 
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  labs(color  = "regression specifications", fill = "regression specifications", 
    shape = "regression specifications") +
  ThisThemeEnd +
  guides(
    colour = guide_legend(title = "regression specifications", nrow = 1),
    fill = guide_legend(title = "regression specifications", nrow = 1),
    shape = guide_legend(title = "regression specifications", nrow = 1)
    ) +
  geom_hline(aes(yintercept = yintercept), colour = "lightgreen")
g <- g + theme(
   strip.text.y = element_text(color = "blue", size = 8, 
     margin = margin(3.5, 0, 3.5, 0, "cm")),
   legend.position = "bottom"
     ) +
  facetted_pos_scales(y = list(
    outcomes == "Grades\nMain panel\n1999 cohort" ~ 
      scale_y_continuous(limits = c(-.8, .2), breaks = seq(-.8, .2, .4)),
    outcomes == "Grades\nPlacebo panel\n2002 cohort" ~ 
      scale_y_continuous(limits = c(-.8, .2), breaks = seq(-.8, .2, .4)),
    outcomes == "Days absent\nMain panel\n1999 cohort" ~ 
      scale_y_continuous(limits = c(-1, 6), breaks = seq(-1, 6, 2)),
    outcomes == "Days absent\nOLS\n1999" ~ 
      scale_y_continuous(limits = c(-1, 6), breaks = seq(-1, 6, 2)),
    outcomes == "Days absent\nOLS\n2002" ~ 
      scale_y_continuous(limits = c(-1, 6), breaks = seq(-1, 6, 2))
  ))
pdf(
  "../save/NumGradesDaysAbsentPlotsByGender.pdf"
  , width = 2*12/2.54, height = 2*8/2.54)
print(g)
whatever <- dev.off()
pdf(
  "../draft/Figures/App_NumGradesDaysAbsentPlotsByGender.pdf"
  , width = 2*12/2.54, height = 3*12/2.54)
print(g)
whatever <- dev.off()
rm(resultsG)
```
</details>

```{r plot GPDA, echo = F, fig.cap = "Grade progression, days absent by different subsamples"}
g
```

See [estimation code of other schooling outcomes](#EstimationOtherSchoolingOutcomes).  

* Grade progreesion and days absent impacts are consistent with main results.  
* Grade progression = 3 if progressed without a delay. Less than 3 indicates repetition or dropping out. When a student discontinues schooling, we use "the highest grade completed" observed in the latest round of the survey and compute the number of grades progressed.  
* Using the baseline enroller sample (top panel), grade progression impact estimates are negative. Exam-harvest overlap delays progression by about .47 years (boys+girls, `r round((c(.47))*12, 2)` months). Impacts on boys are larger in magnitude yet the sample size is too small.  
   * Sample size is small as we must condition on children who are enrolled in 1999. Sample size of always enrollers is even smaller.  
   * Always enroller sample gives larger $p$ values due mostly to weaker impacts.  
   * Always enroller sample has weaker negative grade progression impacts because they are still enrolled.  
* One year impact: As the calendar was favorable in 1999-2001, we consider these estimates as a one year impact because the negative effects were realised only in the academic year of 2002 which were captured in the survey in 2003.   
* What this means: Even when the children of agricultural households are not dropping out of school, more than 40% of them lag behind in one grade progression relative to the children of non-agricultural households.  
* Stipend and non-stipend programs help increase the progression for 1.3-1.5 year in a three year period among girls, but not among boys.  
* Absence impacts are not detected, yet the point estimates are all positive, ranging from .1 to 2.4 days per month.  
* Absence point estimates are larger among boys than girls, which is consistent with the brawn-based interpretation of main estimates.  
* One possible reason for the small magnitude on days absent is attenuation. This variable reports a three month recall, so the interview dates for some households may be off harvesting periods, therefore it may contain measurement errors.  
* Stipend and non-stipend programs help reduce the absence for 4-6 days per month among boys, but not among girls.  
* For programs, boys respond in terms of daily attendance/absence, but not in terms of progression. Opposite is true for girls.  
* Stipend and non-stipend programs may improve grade progression among girls, and they may improve daily attendance among boys. Girls may attend schools constantly with or without them because they are less engaged in remunerative work. Lower opportunity costs of schooling among girls may also allow a stronger responce to programs in terms of progression. It is unclear why they only affect atendance but not progression among boys.  
<!--
* Cross sectional estimates in 2003 (using enrollers of 1999 and 2002) show a monthly 1.0 - 1.2 day increase for children of agricultural households. This reflects that the survey asks days absent of June - August of 2003, which coincide with July-August planting period.  
* In contrast to this, cross sectional estimates in 2000 (using enrollers of 1999 and 2002) show a zero increase for children of agricultural households. In 1999, children from agricultural households benefited from the exam preponement.  
* While we do not have information to support the claim, it is possible that these children of agricultural households who progressed to the next grade may have opted not to work in the field during the planting period of 2000.   
-->
* Placebo estimation of grade progression among "baseline enrollers of 2002" uses the 2002 cohort and measures impacts of 4 years between 2002-2006. It shows the children from agricultural households tend to progress more slowly by `r round(c(.17, .22)/4, 2)` year per annum (`r round((c(.17, .22)/4)*12, 2)` months), which are roughly 10% the size of 1999 impacts, although the $p$ values for placebo estimation are around 7% and are not as small as the 1999 impact estimates. On net, harvest-exam overlap may slow the grade progrssion by `r round(.47 - c(.22)/4, 2)` year per annum (`r round((.47 - c(.22)/4)*12, 2)` months).  
* Placebo estimation of grade progression among "baseline enrollers of 1999" uses the 1999 cohort and shows statistically zero impacts, consistent with our maintained hypothesis.  




## Placebo

### By gender and by aghh def

2002 cohort

```{r P210H, echo = F}
P210H
```

1999 cohort

```{r P910H, echo = F}
P910H
```

## Attrition

<details><summary>Click here to see the R script of attrition analysis.</summary>
```{r read data for attrition analysis, warning = F}
library(clubSandwich)
pathsource00 <- paste0(pathsource, "/ffe/2000/Data/HouseholdData/STATA/")
fn <- list.files(pathsource00)
fn0 <- list.files(pathsource00, full.names = T)
pathsource03 <- paste0(pathsource, "/ffe/2003/Data/HouseholdData/STATA/")
fn <- list.files(pathsource03)
fn3 <- list.files(pathsource03, full.names = T)
pathsource07 <- paste0(pathsource, "/ffe/2007/Data/HouseholdData/STATA/")
fn <- list.files(pathsource07)
fn7 <- list.files(pathsource07, full.names = T)
#### cover
hd1 <-  data.table(foreign::read.dta(grepout("c00", fn0)))
hd1 <- hd1[, .(hhnum, thana)]
#### roster
ros1 <- data.table(foreign::read.dta(grepout("a1", fn0)))
#### rd 2 has hhid = hh used in uniquid
#### uniquid = paste0(4000+hhid, ".", putzeroontop(mid/100))
ros2 <- data.table(foreign::read.dta(grepout("a1", fn3)))
ros3 <- data.table(foreign::read.dta(grepout("rost", fn7)))
#### ros1 and ros2 have hhnum in common. id = hhnum-mid
#### ros2 and ros3 have hhidn in common. id2 = hhidn-mid
ros1[, id := paste0(hhnum, "-", mid)]
ros2[, id := paste0(hhnum, "-", mid)]
ros2[, id2 := paste0(hhidn, "-", mid)]
ros3[, id2 := paste0(hhidn, "-", mid)]
ros1[, rd2 := 0L]
ros1[id %in% ros2[, id], rd2 := 1L]
ros2[, rd3 := 0L]
ros2[id2 %in% ros3[, id2], rd3 := 1L]
ros1[, rd3 := 0L]
ros1[id %in% ros2[rd3==1L, id], rd3 := 1L]
ros1[, exist := paste0(1, rd2, rd3)]
ros1[, exist := factor(exist)]
#### attach uniquid in ros1
ros2[, uniquid := paste0(4000+hhidn, ".", putzeroontop(mid))]
rs2id <- ros2[, .(id, uniquid)]
setkey(rs2id, id); setkey(ros1, id)
ros1 <- rs2id[ros1]
#### ros1 at this point: same as RosRd1 <- qread(paste0(pathsaveThisVer, "OriginalRd1RosterFileWithUniquid.qs"))
#### agHH defined at HH level
	#	isource agri HH
ros1[, isagHH := hhnum %in% hhnum[grep("Agri|Tena", isource)]]
ros1[, isagHH := hhnum %in% hhnum[grep("^1$|^6[12]$", isource)]]
	# head's reply agri HH (following Create2RoundPanel.rnw)
	# head replied: income source or occupation as agri
ros1[, c("ii1", "ii2", "ii3", "hdagHH") := 0L]
ros1[hhnum %in% hhnum[grepl("Agri|Tena", isource)], ii1 := 1L]
ros1[hhnum %in% hhnum[grepl("Agri|enan|farm", occup)], ii2 := 1L]
ros1[hhnum %in% hhnum[grepl("OwnL|Tena", isource)], ii3 := 1L]
ros1[hhnum %in% hhnum[ii1+ii2+ii3>0 & grepl("head", rhhold)], 
  hdagHH := 1L]
	#	occup agri HH
ros1[, ocagHH := hhnum %in% hhnum[grep("Agri|Tenan|farm", occup)]]
	#	owner or cultivator household as ownagHH. A subset of isagHH.
ros1[, ownagHH := hhnum %in% hhnum[grep("OwnL|Tena", isource)]]
ros1[, ownagHH := hhnum %in% hhnum[grep("6[12]", isource)]]
for (m in c(1, 3)) {
    # m=3: use head's reply
   if (m == 3) ros1[, agHH0 := hdagHH] else
    # m=1: previously, used income source or occupation (of any member)
    ros1[, agHH0 := isagHH|ocagHH]
  #### head and spouse education
  ros1[, c("hd.primary", "hd.secondary", "sp.primary", "sp.secondary") := NA]
  ros1[grepl("head", rhhold) & grepl("s[1-5]", educa) & !grepl("ad", educa), hd.primary := 1L]
  ros1[grepl("head", rhhold) & grepl("6|7|8|9|S|A", educa), hd.secondary := 1L]
  ros1[grepl("spo", rhhold) & grepl("s[1-5]", educa) & !grepl("ad", educa), sp.primary := 1L]
  ros1[grepl("spo", rhhold) & grepl("6|7|8|9|S|A", educa), sp.secondary := 1L]
  for (v in c("hd.primary", "hd.secondary", "sp.primary", "sp.secondary") ) {
    ros1[, (v) := eval(parse(text=paste0(v, "[!is.na(", v, ")][1]"))), by = hhnum]
    ros1[eval(parse(text=paste0("is.na(", v, ")"))), (v) := 0L]
  }
  #### assets
  d6a <- data.table(foreign::read.dta(grepout("6a", fn0)))
  d6b <- data.table(foreign::read.dta(grepout("6b", fn0)))
  d6b[, TotalValue := sum(value, na.rm = T), by = hhnum]
  d6b[, num := 1:.N, by = hhnum]
  d6b2 <- d6b[num == 1, .(hhnum, TotalValue)]
  setnames(d6a, "total", "TotalDecimal")
  d6a2 <- d6a[, .(hhnum, TotalDecimal)]
  #### merge files
  setkey(d6a2, hhnum); setkey(d6b2, hhnum); 
  as1 <- d6a2[d6b2]
  setkey(ros1, hhnum); setkey(hd1, hhnum)
  ros1 <- hd1[ros1]
  asr <- as1[ros1]
  asr[, TotalValue := TotalValue/1000]
  #### attrition rates asset holding by agHH at individual level
  asr[, .(Land=mean(TotalDecimal, na.rm = T), Asset=mean(TotalValue), 
    hd.primary = mean(hd.primary), hd.secondary = mean(hd.secondary),
    sp.primary = mean(sp.primary), sp.secondary = mean(sp.secondary),
    exist=mean(grepl("^11", exist))), by = agHH0]
  asr[grepl("^10", exist), .(Land=mean(TotalDecimal, na.rm = T), Asset=mean(TotalValue),
    hd.primary = mean(hd.primary), hd.secondary = mean(hd.secondary),
    sp.primary = mean(sp.primary), sp.secondary = mean(sp.secondary)), 
    by = agHH0]
  asr[, attrit := 0L]
  asr[grepl("^10", exist), attrit := 1L]
  #### attrition rates asset holding by agHH at HH level
  asrH <- asr[, .(attrit, agHH0, TotalDecimal, TotalValue, 
    hd.primary, hd.secondary, sp.primary, sp.secondary, exist, thana, num=1:.N), 
    by = hhnum][num==1, ]
  asrH[, .(Land=mean(TotalDecimal, na.rm = T), Asset=mean(TotalValue), 
    hd.primary = mean(hd.primary), hd.secondary = mean(hd.secondary),
    sp.primary = mean(sp.primary), sp.secondary = mean(sp.secondary),
    exist=mean(grepl("^11", exist))), by = agHH0]
  asrH[grepl("^10", exist), .(Land=mean(TotalDecimal, na.rm = T), Asset=mean(TotalValue),
    hd.primary = mean(hd.primary), hd.secondary = mean(hd.secondary),
    sp.primary = mean(sp.primary), sp.secondary = mean(sp.secondary)
    ), by = agHH0]
  atlm1 <- lm(data = asr, 
    attrit ~ (TotalValue+TotalDecimal+hd.primary+hd.secondary+sp.primary+sp.secondary)*agHH0)
  atlm2 <- lm(data = asrH, 
    attrit ~ (TotalValue+TotalDecimal+hd.primary+hd.secondary+sp.primary+sp.secondary)*agHH0)
  LZ2 <- clx(atlm2, cluster = asrH[- as.numeric(summary(atlm2)$na), thana])
  Satt2 <- coef_test(atlm2, vcov = "CR2", cluster = asrH[- as.numeric(summary(atlm2)$na), thana], 
    test = "Satterthwaite")
  Sattcov <- clubSandwich::vcovCR(atlm2, 
    cluster = asrH[- as.numeric(summary(atlm2)$na), thana], type = "CR2")
  ####coef_test(atlm2, vcov = Sattcov, coefs = "All")
  #### constraint matrix Cb = 0: C is 1 for (2, 2), (3, 3), ... elements
  C0 <- diag(length(atlm2$coeff))
  rownames(C0) <- names(atlm2$coeff)
  C.All <- C0[-1, ]
  C.Ag <- paste0(grepout("agHH", names(atlm2$coeff)), "=0")
  C.Ag <- C0[grep("agHH", names(atlm2$coeff)), ]
  #### Below gives an error due to singularity of cov matrix
  #### clubSandwich::Wald_test(atlm2, vcov = Sattcov, constraints = C.All)
  library(multcomp)
  #### "p value of the global test is the minimum p value of the partial tests"
  #### in multcomp_additionalexample.pdf p.2.
  #### glht only allows a OLS cov matrix. No option to feed vcov of choice. (Wrong)
  #### glht allows user provided cov matrix in vcov. argument via modelparm function.
  F.all <- multcomp::glht(atlm2, linfct = C.All, alternative = "two.sided") # OLS cov
  F.ag <- multcomp::glht(atlm2, linfct = C.Ag, alternative = "two.sided") # OLS cov
  F.all <- multcomp::glht(atlm2, linfct = C.All, alternative = "two.sided", 
    vcov. = Sattcov)
  F.ag <- multcomp::glht(atlm2, linfct = C.Ag, alternative = "two.sided",
    vcov. = Sattcov)
  p.all <- summary(F.all)
  p.ag <- summary(F.ag)
  print(LZ2)
  options(width = 120)
  print(Satt2)
  options(width = 100)
  Ftest.all <- summary(F.all, test = Ftest())$test
  Ftest.ag <- summary(F.ag, test = Ftest())$test
  print(data.frame(Fstat = Ftest.all$fstat, dof = Ftest.all$df, pval = Ftest.all$pval))
  print(p.all)
  print(confint(F.all))
  print(data.frame(Fstat = Ftest.ag$fstat, dof = Ftest.ag$df, pval = Ftest.ag$pval))
  print(p.ag)
  print(confint(F.ag))
  thesecols <- c("attrit", "TotalValue", "TotalDecimal", 
    "hd.primary", "hd.secondary", "sp.primary", "sp.secondary")
  AttritComp <- NULL
  for (kk in thesecols) {
    if (kk == "attrit") {
      d0 <- asrH[agHH0==0, kk, with = F]
      d1 <- asrH[agHH0==1, kk, with = F]
    } else {
      d0 <- asrH[grepl("^10", exist) & agHH0==0, kk, with = F]
      d1 <- asrH[grepl("^10", exist) & agHH0==1, kk, with = F]
    }
    ttestK <- t.test(d1, d0)
    AttritComp <- rbind(AttritComp,
      cbind(kk, var(d1, na.rm = T)^(.5), var(d0, na.rm = T)^(.5),
        round(-diff(unlist(ttestK["estimate"])), 3), # -diff = -(y - x) = AgHH - nonagHH
        t(as.numeric(unlist(lapply(ttestK[c("estimate", "conf.int", "stderr", "p.value")], round, 4))))
      )
    )
  }
  AttritComp <- data.table(AttritComp)
  setnames(AttritComp, c("variable", "se.agHH", "se.nonagHH", "AgNonag", "agHH", "nonagHH", 
    "lb95", "ub95", "se", "pvalue"))
  ac1 <- AttritComp[, .(variable, agHH, nonagHH, AgNonag)]
  ac2 <- AttritComp[, .(variable, se.agHH, se.nonagHH, pvalue)]
  #### ac1[grepl("TotalV", variable), agHH := formatC(as.numeric(agHH), digits = 0, format = "f")]
  #### ac1[grepl("TotalV", variable), nonagHH := formatC(as.numeric(nonagHH), digits = 0, format = "f")]
  #### ac1[grepl("TotalV", variable), AgNonag := formatC(as.numeric(AgNonag), digits = 0, format = "f")]
  #### ac2[grepl("TotalV", variable), se.agHH := 
  ####   paste0("(", formatC(as.numeric(se.agHH), digits = 0, format = "f"),")")]
   ac2[, se.agHH := 
     paste0("(", formatC(as.numeric(se.agHH), digits = 3, format = "f"),")")]
  #### ac2[grepl("TotalV", variable), se.nonagHH := 
  ####   paste0("(", formatC(as.numeric(se.nonagHH), digits = 0, format = "f"),")")]
   ac2[, se.nonagHH := 
     paste0("(", formatC(as.numeric(se.nonagHH), digits = 3, format = "f"),")")]
  ac2[, pvalue := 
    paste0("[", formatC(as.numeric(pvalue)*100, digits = 2, format = "f"),"]")]
  newAC <- NULL
  for (r in 1:nrow(ac1))
    newAC <- rbind(newAC, rbindlist(list(ac1[r, ], ac2[r, ]), use.names = F))
  dtsatt <- data.table(Satt2)
  dtsatt[, Pstar := "\\phantom{^{*}}"]
  dtsatt[p_Satt<.1, Pstar := "^{*}"]
  dtsatt[p_Satt<.05, Pstar := "^{**}"]
  dtsatt[p_Satt<.01, Pstar := "^{***}"]
  dfsatt <- data.frame(Satt2)[, c("beta", "SE", "p_Satt")]
  tbsatt <- tabstarP(dfsatt, XX.YYY = T, DispSE = F)
  sta <- matrix(rep(dtsatt[, Pstar], each = 2), ncol = 2)
  sta[seq(2, nrow(sta), 2), ] <- ""
  dfsatt <- data.frame(variables = rownames(tbsatt)[1:14], 
    Base=paste0(tbsatt[1:14, ], sta[, 1]), AddagHH=paste0(tbsatt[-(1:14), ], sta[ ,2]))
  dfsatt2 <- rbind("", "", dfsatt)
  newAC2 <- rbind(newAC[1:2, ], t(rep("", 4)), t(rep("", 4)), newAC[-(1:2), ], use.names = F)
  matatt <- cbind(newAC2, dfsatt2[, -1])
  matatt[, variable := 
  rep(c("Attrition", "(Intercept)", "Total asset holding (BDT1000)", "Total landholding (decimal)", 
    "Head primary education", "Head secondary education", 
    "Spouse primary education", "Spouse secondary education"
    ), each = 2)]
  matatt[seq(2, nrow(matatt), 2), variable := ""]
  matatt[, variable := paste("\\makebox[3.5cm]{\\hfill", variable, "}")]
  setnames(matatt, c("AgNonag", "AddagHH"), c("agHH - NonagHH", "Base $\\times$ agHH"))
  assign(paste0("AttComp", aghh.defs[m]), matatt)
}
```
</details>


<details><summary>Click here to see the R script of tabulating attrition analysis.</summary>
```{r attrition tabulation}
matthd <- get(paste0("AttComp", aghh.defs[m]))
write.tablev(matthd, "../save/HeadReplyBasedAttritionComparison.tex") 
mattagHH0 <- get(paste0("AttComp", aghh.defs[m]))
write.tablev(mattagHH0, "../save/JHRAgHHDefBasedAttritionComparison.tex")
#### LaTeX table
TabAttrit <- latextab(as.matrix(matthd),
  hleft = "\\footnotesize\\hfil$", hcenter = c(3.5, rep(1.95, ncol(matthd)-1)), 
  hright = "$", 
  headercolor = "gray80", adjustlineskip = "-.8ex", delimiterline= NULL,
  alternatecolor2 = "gray90",
  addseparatingcols = 3, separatingcolwidth = .2,
  separatingcoltitle = c("\\textsf{Descriptive statistics}", "\\textsf{OLS estimates}"),
  addsubcoltitlehere = T)
write.tablev(TabAttrit,  
  "../save/AttritionEstimation.tex"
  , colnamestrue = F)
#### HTML table
for (m in c(1, 3)) {
  matatt <- get(paste0("AttComp", aghh.defs[m]))
  coln <- colnames(matatt)
  matatt <- rbind(t(matrix(c("", 1:5))), matatt, use.names = F)
  setnames(matatt, coln)
  matatt[, variable := gsub("^.*hfill (.*?) \\}", "\\1", variable)]
  matatt[, Base := gsub("^\\\\phantom\\{.*?\\}", "", Base)]
  matatt[, Base := gsub("\\\\phantom\\{.*\\}$", "", Base)]
  matatt[grepl("\\w", Base) & !grepl("^Att", Base), Base := gsub("\\(", "[", Base)]
  matatt[grepl("\\w", Base) & !grepl("^Att", Base), Base := gsub("\\)", "]", Base)]
  setnames(matatt, "Base $\\times$ agHH", "BaseAgHH")
  matatt[, BaseAgHH := gsub("^\\\\phantom\\{.*?\\}", "", BaseAgHH)]
  matatt[, BaseAgHH := gsub("\\\\phantom\\{.*\\}$", "", BaseAgHH)]
  matatt[, BaseAgHH := gsub("\\^\\{(.*?)\\}", "\\1", BaseAgHH)]
  matatt[grepl("\\w", Base) & !grepl("^Att", Base), BaseAgHH := gsub("\\(", "[", BaseAgHH)]
  matatt[grepl("\\w", Base) & !grepl("^Att", Base), BaseAgHH := gsub("\\)", "]", BaseAgHH)]
  setnames(matatt, "BaseAgHH", "Base * agHH")
  kt <- kable(matatt, align = paste0("r", paste0(rep("c", ncol(matatt)-1), collapse = "")), 
      caption =  paste0(
        "Attrition comparisons between agricultural and non-agricultural households",
        ": ", aghh.defs[m]
      )
    )
  kt <- add_header_above(kt, c(" " = 1, "A. Descriptive statistics of attriters" = 3, "B. OLS estimates" = 2),
    background = bgcolor)
  kt <- row_spec(kt, 0, align = paste0(rep("c", ncol(matatt)), collapse = ""), background = "#ffcc99")
  kt <- column_spec(kt, 1, width = "4.75cm; min-width:4.75cm;")
  kt <- column_spec(kt, 2:6, width = "2.25cm; min-width:2.25cm;")
  kt <- footnote(kt, 
             general = "Sample of direct offspring of household heads. ",
             number = c("Attrition is true if a household is missing in round 2. All covariates are of round 1.",
             paste0("`A. Descriptive statistics of attriters` panel shows attriter's characteristics. For each baseline covariates, top rows show the means and bottom rows show the standard errors in columns (1) and (2), respectively. In column (3), top rows show mean differences and bottom rows show associated $p$ values of mean differences in per centage. `B. OLS estimates` panel shows results from linear probability model of attrition on baseline variables and their interaction with the agricultural household dummy. Top rows show point estimates and bottom rows show standard errors. Estimates of nonag HHs are shown in (4) Base and interaction terms of each variables with ag HH are shown in (5) Base * agHH. Number of observations for LPM is ", atlm2$df.res, " with $\\bar{R}$=", round(summary(atlm2)$r.sq, 3), ". Standard errors are clustered at the Thana level with a Satterthwaite correction for a small number of clusters. $*$ indicates a $p$ value between 5% and 10%."
             )
             ))
   assign(paste0("kt", aghh.defs[m]), kt)
}
```
</details>

```{r attrition analysis results, echo = F}
kthdagHH
```

* `A. Descriptive statistics of attriters` panel shows attriter's characteristics.  
* `B. OLS estimation` panel shows results from linear probability model of attrition on baseline variables and their interaction with the agricultural household dummy.  
* Attrition rate is higher among non-ag HHs. While we do not know the enrollment rate changes of the attrited non-ag HHs, we know that their parental educational achievements are higher than the attrited ag HH counterparts. If their enrollment rate changes are smaller (more likely to stay on school) than the ag HH attriters, provided that the more educated parents value education more highly, this has <Blue>a potential to understate the impacts.</Blue>  
* Despite some differences in attriter characteristics, we see in below that, when we estimate the attrition selection with the whole sample of attrited and non-attrited households, the attrition can be considered as good as random.  
* Based on linear probability estimation, <Blue>attrition seems random between agHHs and nonag HHs at the household level.</Blue> There is an indication that smaller land holders of agHHs may be more prone to attrit at the rate of 3% per one acre reduction in landholding.  
* The implied magnitude of correlation between landholding and attrition is small given the mean landholding of agHHs is 1.46 acre. In addition, it is not easy to guess the direction of the bias it gives to enrollment rates: When smaller landholding has smaller labor demand for children that results in higher enrollment rates, their attrition can understate enrollment rates. When smaller landholders, or less wealthy households, stop schooling early that results in lower enrollment rates, their attrition can overstate enrollment rates. Given the <Blue>small magnitude of possible impacts that may potentially cancel out each other with a mildly small $p$ value attached to it,</Blue> we restrict our attention to the complete panel portion of the data. We also note that we include landholding as a covariate in the main estimation.  


## Other ag-nonag comparisons


### Reasons of not going to school

Overall, <Blue>agricultural households are poorer, and nonattending children claim that financial as the reason of not going to school.</Blue>  

<details><summary>Click here to see the R script of tabulating reasons of not going to school.</summary>
```{r reasons, warning = F}
z <- readRDS("../save/zFm1999.rds")
z <- qread("../save/zEm1999.qs")
 zi00N <- qread("../save/DID2024_N_MainResults.qs")
 ii <- jj <- s <- 1
 j <- clnum <- 2
 m <- ge <- 3
 zi <- zi00N[[ii]][[jj]][[s]][[j]][[ge]][[m]] 
 zidd <- lapply(zi, "[[", "diff.data")
 #### least num of obs data
 zidd0 <- zidd[[length(zidd)]]
 z <- z[uniquid %in% zidd0[, uniquid], ]
z[, memnum := 1:.N, by = .(hh, survey)]
iisch <- z[, schoolp] == 1
y2k <- z[, survey] == 1999
id2k <- unique(z[, uniquid][iisch & y2k])
iiid2k <- z[, uniquid] %in% id2k  #  HHs whose children are going school in y2k
#### table0(z[, reastop])
z[, ReasonStop := as.character(NA)]
z[grep("expense|money|Stipend|earn|farm", reastop), ReasonStop := "financial"]
z[grep("mixed|harass|safe", reastop), ReasonStop := "school environ"]
z[grep("Mar", reastop), ReasonStop := "marriage"]
z[grep("far", reastop), ReasonStop := "distance"]
z[grep("Not accepted", reastop), ReasonStop := "not accepted"]
z[grep("Sick", reastop), ReasonStop := "sickness"]
z[grep("want|Other", reastop), ReasonStop := "not want to, others"]
#### table0(z[, ReasonStop])
####  reasons by pcexp quartile
reatab <- NULL
for (class in 1:4)
{
  cat(paste("pcexp class", class, "\n"))
  iiq <- grepl(class, z[, UDpc4])
  cat("non-goers 1999:", round(sum(iiq & y2k & !iisch, na.rm = T)/
    sum(iiq & y2k, na.rm = T), 2), "=",
    sum(iiq & y2k & !iisch, na.rm = T), "/", 
    sum(iiq & y2k, na.rm = T), "\n")
  t1 <- table0(z[iiq & y2k & !iisch, ReasonStop])
  cat("non-goers 2002:", round(sum(iiq & !y2k & !iisch, na.rm = T)/
    sum(iiq & !y2k, na.rm = T), 2), "=",
    sum(iiq & !y2k & !iisch, na.rm = T), "/", 
    sum(iiq & !y2k, na.rm = T), "\n")
  t2 <- table0(z[iiq & !y2k & !iisch, ReasonStop])
  cat("dropouts 2002 conditional on going to school in 1999:", 
    round(sum(iiq & iiid2k & !y2k & !iisch, na.rm = T)/
    sum(iiq & iiid2k & !y2k, na.rm = T), 2), "=",
    sum(iiq & iiid2k & !y2k & !iisch, na.rm = T), "/", 
    sum(iiq & iiid2k & !y2k, na.rm = T), "\n")
  t3 <- table0(z[iiq & iiid2k & !y2k & !iisch, ReasonStop])
  t1 <- t(as.matrix(t1)); t2 <- t(as.matrix(t2)); t3 <- t(as.matrix(t3))
  colnames(t1)[ncol(t1)] <- colnames(t2)[ncol(t2)] <- colnames(t3)[ncol(t3)] <- "NA"
  t1 <- grbind(t1, t2)
  if (class == 1) reatab <- grbind(t1, t3) else reatab <- grbind(reatab, grbind(t1, t3))
}
reatab <- reatab[, c(2:4, 7, 1, 5, 6)]
reatab <- cbind(reatab, sum = apply(reatab, 1, sum, na.rm = T))
reatab[, -ncol(reatab)] <- round(reatab[, -ncol(reatab)]/reatab[, ncol(reatab)], 2)
reatab <- a2b(reatab, NA, 0)
reatab <- data.frame(cbind(
  group = rep(paste0("\\mbox{\\scriptsize ", 
    c("Non-attendees 1999", "Non-attendees 2002", "Dropouts 2002"), "}"), 4), 
  formatC(reatab[, -ncol(reatab)], digits = 2, format = "f"), total = reatab[, ncol(reatab)]))
cn0 <- colnames(reatab)
cn <- paste0(toupper(substr(cn0, 1, 1)), substr(cn0, 2, 20))
cn <- gsub("Not.accepted", "\\\\begin{minipage}{1cm}\\\\hfil Not\\\\\\\\\\\\hfil accepted\\\\setlength{\\\\baselineskip}{10pt}\\\\end{minipage}", cn)
cn <- gsub("School.environ", "\\\\begin{minipage}{1cm}\\\\hfil School\\\\\\\\\\\\hfil environ.\\\\setlength{\\\\baselineskip}{10pt}\\\\end{minipage}", cn)
cn <- gsub("NA.", "NA", cn)
colnames(reatab) <- cn
reatab <- cbind(Quartile = repseq(1:4, 3), reatab)
#### reorder rows: pack rows by group, Irregulars 1999 q1, q2, q3, q4, 
####  Irregulars2002 q1, q2, q3, q4, etc.
rseq <- seq(1, nrow(reatab), 3)
rseq <- c(rseq, rseq+1, rseq+2)
reatab <- reatab[rseq, ]
reatab <- reatab[, c(2, 1, 3:ncol(reatab))]
reatab[-seq(1, nrow(reatab), 4), "Group"] <- ""

#### LaTeX table
ltb <- latextab(as.matrix(reatab),
  hleft = c("\\scriptsize\\hfill", rep("\\scriptsize\\hfil$", ncol(reatab)-1)),
  hcenter = c(2.5, 1, rep(1, ncol(reatab)-2)), 
  hright = c("", rep("$", ncol(reatab)-1)), 
  headercolor = NULL, delimiterline = NULL)
ltb <- gsub("Group|Quartile|Total", "", ltb)
ltb <- c(
    ltb[1],
    "\\makebox[2.5cm]{Group} & \\makebox[1cm]{Quartile} & \\multicolumn{7}{c}{\\scriptsize Reasons} & \\makebox[1cm]{Total}\\\\", 
    ltb[2], 
    "\\hline",
    ltb[-c(1:2)]
  )
write.tablev(ltb, "../save/reasons.tex", colnamestrue = F)
write.tablev(ltb, "../draft/Tables/reasons.tex", colnamestrue = F)

#### HTML table
reatab <- data.table(reatab)
reatab[, Group := gsub("^\\\\mbox\\{\\\\scriptsize (.*?)\\}", "\\1", Group)]
cn <- colnames(reatab)
cn <- gsub(".*Not.*", "Not accepted", cn)
cn <- gsub(".*Schoo.*", "School environment", cn)
setnames(reatab, cn)
kt <- kable(reatab, align = paste0("r", paste0(rep("c", ncol(reatab)-1), collapse = "")), 
  caption =   "Reasons of not going to school by consumption quartile")
kt <- row_spec(kt, 0, align = paste0(rep("c", ncol(reatab)), collapse = ""), background = "#ffcc99")
kt <- column_spec(kt, 1, width = "4.0cm; min-width:4.0cm;")
kt <- column_spec(kt, 2:10, width = "2.25cm; min-width:2.25cm;")
ktReaPC4 <- footnote(kt, 
           general = ReasonsMemo
           )

####  ag vs non-ag
z[hdagHH<0, agHH := 0L]
z[hdagHH>0, agHH := 1L]
reatab <- NULL
for (k in 0:1)
{
  cat(paste("ag household", k, "\n"))
  iiq <- as.logical(z[, "agHH"] == k)
  cat("non-goers 1999:", round(sum(iiq & y2k & !iisch, na.rm = T)/
    sum(iiq & y2k, na.rm = T), 2), "=",
    sum(iiq & y2k & !iisch, na.rm = T), "/", 
    sum(iiq & y2k, na.rm = T), "\n")
  t1 <- table0(z[iiq & y2k & !iisch, ReasonStop])
  cat("non-goers 2002:", round(sum(iiq & !y2k & !iisch, na.rm = T)/
    sum(iiq & !y2k, na.rm = T), 2), "=",
    sum(iiq & !y2k & !iisch, na.rm = T), "/", 
    sum(iiq & !y2k, na.rm = T), "\n")
  t2 <- table0(z[iiq & !y2k & !iisch, ReasonStop])
  cat("dropouts 2002 conditional on going to school in 1999:", 
    round(sum(iiq & iiid2k & !y2k & !iisch, na.rm = T)/
    sum(iiq & iiid2k & !y2k, na.rm = T), 2), "=",
    sum(iiq & iiid2k & !y2k & !iisch, na.rm = T), "/", 
    sum(iiq & iiid2k & !y2k, na.rm = T), "\n")
  t3 <- table0(z[iiq & iiid2k & !y2k & !iisch, ReasonStop])
  t1 <- t(as.matrix(t1)); t2 <- t(as.matrix(t2)); t3 <- t(as.matrix(t3))
  colnames(t1)[ncol(t1)] <- colnames(t2)[ncol(t2)] <- colnames(t3)[ncol(t3)] <- "NA"
  t1 <- grbind(t1, t2)
  if (k == 0) reatab <- grbind(t1, t3) else reatab <- grbind(reatab, grbind(t1, t3))
}
cn1 <- gsub("\\.", " ", cn0)
cn1 <- gsub(" $", "", cn1)
cn1 <- cn1[!grepl("gr|tota", cn1)]
reatab <- reatab[, cn1]
reatab <- cbind(reatab, sum = apply(reatab, 1, sum, na.rm = T))
reatab[, -ncol(reatab)] <- round(reatab[, -ncol(reatab)]/reatab[, ncol(reatab)], 2)
reatab <- a2b(reatab, NA, 0)
reatab <- data.frame(cbind(
  Group = rep(paste0("\\mbox{\\scriptsize ", 
    c("Non-attendees 1999","Non-attendees 2002","Dropouts 2002"), "}"), 2), 
  formatC(reatab[, -ncol(reatab)], digits = 2, format = "f"), total = reatab[, ncol(reatab)]))
colnames(reatab)[-c(1, ncol(reatab))] <- cn1
reatab <- cbind("HH type" = repseq(c("Agricultural", "Non-agricultural"), 3), reatab)
#### reorder rows: pack rows by group, Nonattendees 1999 ag, nonag, 
####  Nonattendees 2002 ag, nonag, etc.
rseq <- seq(1, nrow(reatab), 3)
rseq <- c(rseq, rseq+1, rseq+2)
reatab <- reatab[rseq, ]
cn00 <- colnames(reatab)
cn <- paste0(toupper(substr(cn00, 1, 1)), substr(cn00, 2, 20))
cn <- gsub("Not.accepted", "\\\\begin{minipage}{1cm}\\\\hfil Not\\\\\\\\\\\\hfil accepted\\\\setlength{\\\\baselineskip}{10pt}\\\\end{minipage}", cn)
cn <- gsub("School.environ", "\\\\begin{minipage}{1cm}\\\\hfil School\\\\\\\\\\\\hfil environ.\\\\setlength{\\\\baselineskip}{10pt}\\\\end{minipage}", cn)
cn <- gsub("NA.", "NA", cn)
colnames(reatab) <- cn
reatab <- reatab[, c(2, 1, 3:ncol(reatab))]
reatab[c(2, 4, 6), 1] <- ""

#### LaTeX table
ltb <- latextab(as.matrix(reatab),
  hleft = c("\\scriptsize\\hfill", "\\scriptsize\\hfil", rep("\\scriptsize\\hfil$", ncol(reatab)-2)),
  hcenter = c(2.5, 2.5, rep(1, ncol(reatab)-2)), 
  hright = c("", "", rep("$", ncol(reatab)-2)), 
  headercolor = NULL, delimiterline = NULL)
ltb <- gsub("Group|HH type|Total", "", ltb)
ltb <- c(
    ltb[1],
    "\\makebox[2.5cm]{Group} & \\makebox[2.5cm]{HH type} & \\multicolumn{7}{c}{\\scriptsize Reasons} & \\makebox[1cm]{Total}\\\\", 
    ltb[2], 
    "\\hline",
    ltb[-c(1:2)]
  )
write.tablev(ltb, "../save/reasons_ag.tex", colnamestrue = F)
write.tablev(ltb, "../draft/Tables/reasons_ag.tex", colnamestrue = F)
#### HTML table
reatab <- data.table(reatab)
setnames(reatab, grepout(".*Schoo.*", colnames(reatab)), "School environment")
setnames(reatab, grepout(".*Not.*", colnames(reatab)), "Not accepted")
reatab[, Group := gsub("^\\\\mbox\\{\\\\scriptsize (.*?)\\}", "\\1", Group)]
setnames(reatab, "HH type", "HHtype")
reatab[, HHtype := factor(HHtype, labels = c("Agricultural", "Non-agricultural"))]
setnames(reatab, "HHtype", "HH type")
kt <- kable(reatab, align = paste0("r", paste0(rep("c", ncol(reatab)-1), collapse = "")), 
  caption =   "Reasons of not going to school")
kt <- row_spec(kt, 0, align = paste0(rep("c", ncol(reatab)), collapse = ""), background = "#ffcc99")
kt <- column_spec(kt, 1, width = "3.75cm; min-width:3.75cm;")
kt <- column_spec(kt, 2, width = "4.0cm; min-width:4.0cm;")
kt <- column_spec(kt, 3:10, width = "2.25cm; min-width:2.25cm;")
kt <- footnote(kt, 
           general = ReasonsMemo
           )
```
</details>

```{r reasons of not going to school by group and con q4, echo = F}
ktReaPC4
```

* 1999 data show financial as the top reason, while 2002 show NAs.  
* Among non-NA, financial is the top reason in both years.  
* <Blue>The rate of financial is decreasinng in consumption quartile</Blue> within each group.  

```{r reasons of not going to school bg ag nonag, echo = F}
kt
```

* Financial among nonattending children of <Blue>agricultural housesholds is greater than non-agricultural households.</Blue>  

### Consumption quartiles

<details><summary>Click here to see the R script of consumption quartile shares.</summary>
```{r consumption quartiles, warning = F}
####print(table0(z[, c("agHH", "pc4")]))
####print(addmargins(table0(z[tee == 1, .(agHH, UDpc4)])))
rowsumoftab <- apply(table0(z[tee == 1, .(agHH, pc4)]), 1, sum)
thistab <- cbind("ag HH/quartile" = paste("\\mbox{", c("yes", "no"), "}", sep = ""), 
  round((table0(z[tee == 1, .(agHH, UDpc4)]) / rowsumoftab) * 100, 2), 
  "rowtotal (persons)" = rowsumoftab)
#### LaTeX table
write.tablev(latextab(as.matrix(thistab),hleft = "\\scriptsize\\hfil$", 
  hcenter = c(rep(1.5, 6), 2), hright = "$", delimiterline = NULL), 
  "../save/tab_agvspc4.tex", colnamestrue = F)
#### ag vs quartile
(agp <- addmargins(table0(z[survey == 1999, .(agHH, UDpc4)])))
agp <- data.table(as.data.frame.matrix(agp))
setnames(agp, c(paste0("q", 1:4), "NA", "Total"))
for (j in 1:5) set(agp, j=j, value = as.character(agp[[j]]))
for (i in 1:2) for (j in 1:5) 
  set(agp, i, j, value = formatC((as.numeric(agp[[j]][[i]])/agp[[6]][[i]])*100, digits = 2, format = "f"))
agp <- cbind(Quartile = c("Non agricultural households", "Agricultural households", "Total"), agp)
#### LaTeX table
ltb <- latextab(as.matrix(agp), 
  hleft = c("\\scriptsize\\hfill", rep("\\scriptsize\\hfil$", ncol(agp)-1)), 
  hcenter = c(3.5, rep(1.5, ncol(agp)-1)), 
  hright = c("", rep("$", ncol(agp)-1)), 
  headercolor = NULL, delimiterline = NULL)
ltb <- gsub("Quartiles|Total", "", ltb)
ltb <- c(
    ltb[1],
    "\\makebox[2cm]{HH type} &\\multicolumn{5}{c}{\\scriptsize Quartile} & \\makebox[1cm]{Total}\\\\", 
    ltb[2], 
    "\\hline",
    ltb[-c(1:2)]
  )
write.tablev(ltb, "../save/tab_agpc4.tex", colnamestrue = F)
write.tablev(ltb, "../draft/Tables/tab_agpc4.tex", colnamestrue = F)
#### HTML table
kt <- kable(agp, align = paste0("r", paste0(rep("c", ncol(agp)-1), collapse = "")), 
  caption = "Consumption quartiles")
kt <- row_spec(kt, 0, align = paste0(rep("c", ncol(agp)), collapse = ""), background = "#ffcc99")
kt <- footnote(kt, 
           general = "Sample of direct offspring of household heads. q1 - q4 indicate quartiles 1 - 4, and the numbers are percentages of row totals. Totals are sum of households of each columns and rows. "
           )
```
</details>

```{r con q4 shares, echo = F}
kt
```

* There are <Blue>50% fewer agricultural households than non-agricultural households in the richest quartile.</Blue>  



### Enrollment rate by age and age at first enrollment

<Blue>Enrollment at 6 yeas old is neither compulsory nor strictly enforced.</Blue> 


<details><summary>Click here to see the R script of enrollment by age and age at enrollment.</summary>
```{r enrollment by age}
yzw <- readRDS("../save/DataForJHR.rds")
zE = copy(yzw[grepl("111|110", exist), ])
iiid <- unique(zE[AgeIn1999 <= 18, uniquid])
z1 <- zE[uniquid %in% iiid & survey != 2006 & sd == 1, ]
#### enrollment rates of cohort 1999, exist sample for main estimation
z1[, .(Enroll = mean(schoolp, na.rm = T), N = .N), by = .(AgeIn1999, agHH0>0)][order(AgeIn1999, agHH0), ]
er1 <- addmargins(addmargins(table(z1[agHH0>0,.(survey, schoolp)]), 1, sum), 2, sum)
pathsource00 <- paste0(pathsource, "/ffe/2000/Data/HouseholdData/STATA/")
fn <- list.files(pathsource00)
fn0 <- list.files(pathsource00, full.names = T)
#### 1.A.1 section (roster)
e00 <- foreign::read.dta(grepout("a1", fn0))
e00 <- data.table(e00)
	#	isource agri HH: Agri|Tena
e00[, isagHH := as.integer(hhnum %in% hhnum[grep("^1$|^6[12]$", isource)])]
	#	occup agri HH
e00[, ocagHH := as.integer(hhnum %in% hhnum[grep("Agri|enan|farm", occup)])]
	#	owner or cultivator household as ownagHH. A subset of isagHH.
e00[, ownagHH := as.integer(hhnum %in% hhnum[grep("^6[12]$", isource)])]
e00[, agHH0 := as.integer(isagHH+ocagHH > 0L)]
#### 1.A.2 section (roster and school attendance): schoolp (still attending school?), 
#### agead (age first admitted) and year_ (year first admitted)
a00 <- foreign::read.dta(grepout("a2a", fn0))
a00 <- data.table(a00)
e00age <- e00[, .(hhnum, mid, age, agem, agHH0)]
setkey(e00age, hhnum, mid); setkey(a00, hhnum, mid)
a00 <- e00age[a00]
#### Age and year admitted to grade 1
adyr <- a00[, .(MeanAgeAtG1 = mean(agead, na.rm = T), 
  MedianAgeAtG1 = median(agead, na.rm = T), 
  MinAgeAtG1 = min(agead, na.rm = T), 
  MaxAgeAtG1 = max(agead, na.rm = T), N = .N), by = .(agHH0, year_)]
adyr <- adyr[!is.na(year_) & !is.na(agHH0), ]
setkey(adyr, year_, agHH0)
adyrW <- reshape(adyr, direction = "wide", idvar = "year_", timevar = "agHH0", 
  v.names = grepout("G1|N", colnames(adyr)))
adyr[, agHH0 := factor(agHH0, labels = c("nonag HH", "ag HH"))]
#### Enrollment rates by age
a00[, Schoolp := schoolp]
a00[, schoolp := NULL]
a00[, schoolp := 0L]
a00[grepl("Y", Schoolp), schoolp := 1L]
erbg <- a00[, .(MeanEAtG1 = mean(schoolp, na.rm = T), 
  StdEAtG1 = var(schoolp, na.rm = T)^(.5), N = .N), by = .(age, agHH0)]
erbg <- erbg[!is.na(age) & !is.na(agHH0) & age <= 18 & age >= 5, ]
setkey(erbg, age, agHH0)
erbgW <- reshape(erbg, direction = "wide", idvar = "age", timevar = "agHH0", 
  v.names = grepout("G1|N", colnames(erbg)))
erbg[, agHH0 := factor(agHH0, labels = c("nonag HH", "ag HH"))]
erbg[, age := factor(age, levels = 5:18)]
```
```{r plot enrollment rate by age}
library(ggplot2)
g1 <- ggplot(data = erbg, 
    aes(x = age, y = MeanEAtG1, 
      group = agHH0, fill = agHH0, colour = agHH0, label = N)) + 
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("lightblue", "blue")) +
  scale_colour_manual(values = c("blue", "blue")) +
  scale_x_discrete(expand=c(.04, .04)) +
  ThisThemeEnd+
  geom_text(vjust = -0.5, size = 3, position = position_dodge(width = 0.9),
    show.legend = F)+
  xlab("age") + 
  ylab("mean enrollment rate at round 1") + 
  labs(color  = "HH type", fill = "HH type", label = "cell size") +
  guides(
    colour = guide_legend(title = "HH type", nrow = 1),
    label = guide_legend(title = "cell size", nrow = 1),
    fill = guide_legend(title = "HH type", nrow = 1)
    )
pdf(
  "../save/AgewiseRawEnrollmentRates.pdf"
  , width = 2*12/2.54, height = 2*6/2.54)
print(g1)
whatever <- dev.off()
```
```{r plot age at grade 1}
library(ggplot2)
g2 <- ggplot(data = adyr, 
    aes(x = year_, y = MeanAgeAtG1, 
      group = agHH0, fill = agHH0, colour = agHH0, label = N)) + 
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("lightblue", "blue")) +
  scale_colour_manual(values = c("blue", "blue")) +
  scale_x_continuous(breaks = 1987:2000, expand=c(.04, .04)) +
  ThisThemeEnd+
  geom_text(vjust = -0.5, size = 3, position = position_dodge(width = 0.9),
    show.legend = F)+
  xlab("year of starting primary school") + 
  ylab("mean age") + 
  labs(color  = "HH type", fill = "HH type", label = "cell size") +
  guides(
    colour = guide_legend(title = "HH type", nrow = 1),
    label = guide_legend(title = "cell size", nrow = 1),
    fill = guide_legend(title = "HH type", nrow = 1)
    )
pdf(
  "../save/AgeAtClass1Enrollment.pdf"
  , width = 2*12/2.54, height = 2*6/2.54)
print(g2)
whatever <- dev.off()
```
</details>

```{r enrollment figure1, fig.cap='Enrollment rates by age. Values above each bar are total number of observations.', echo = F}
g1
```

* Enrollment rates are lower for agricultural than non-agricultural households at the baseline.  
* Differences between agricltural and non-agricultural households in cross sectional (=between age) enrollment rate decline are not monotone. I.e., it is not that the agricultural households show faster decline between ages. 

```{r enrollment figure2, echo = F, fig.cap='Age at class 1 enrollment. Values above each bar are total number of observations.'}
g2
```

* Mean age of first enrollment is generally older than 6 for both household groups.  
* Mean age of first enrollment is older among the agricultural households. 


# Memo on FD and DID

FD and raw DID are numerically identical in a two-period panel. In a longer panel, they differ. FD automatically controls for individual FEs while DID needs explicit inclusion of individual dummy variables. Unfortunately, adding FEs explicitly at the individual level by using dummy variables, with the order of hundreds to thousands, is practically infeasible to implement in estimation. So most econometric programs use either FD or FE implementation. FE implementation subtracts individual means of each variables and thus requires degree of freedom correction (reduction by a single period, or subtracting the total number of cross sectional units $J$, so $JT-K-J=J(T-1)-K$). In a longer panel, it has been discussed that the choice of FD or FE depends on error persistence: If errors are close to a unit root process, FD is more efficient. If errors are closer to a white noise process, FE is more efficient [@Wooldridge2010]. 

\begin{quote}
In practice, with many individuals it is typically not feasible to estimate
the individual dummy variables in equation (3) directly. Instead, the model
is either estimated by differencing out the fixed effect or by taking deviations from means. \\
\hfill \href{https://econ.lse.ac.uk/staff/spischke/ec524/evaluation3.pdf}{Stephen Pischke} (p.13)
\end{quote}

```{r , echo = F, eval = F}
library(qs)
Enr.DID <- qread("../save/Enr2024.DID.qs")
Enrchg.DID <- qread("../save/Enrchg2024.DID.qs")
```

```{r ShowMemUse, echo = F}
ShowMemUse(decreasing = T, limit = 10)
```

